<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Dashboard</title>
  <style>
    :root{
      --primary:#4CAF50;
      --primary-hover:#45a049;
      --pastel-dark:#81c784;
      --card-shadow:0 8px 24px rgba(0,0,0,0.12);
      --muted:#6b7280;
    }
    body{ margin:0; font-family:Arial, sans-serif; background:var(--pastel-dark); min-height:100vh; display:flex; flex-direction:column; }
    .logo-header{ background:#000; padding:10px 18px; display:flex; align-items:center; }
    .logo{ height:35px; width:auto; }

    .container{
      background:#fff; margin:30px; border-radius:14px; box-shadow:var(--card-shadow);
      padding:20px; display:grid; grid-template-columns:160px 1fr; gap:20px;
    }
    .header{ grid-column:1 / -1; text-align:center; font-size:24px; margin:0; color:#111; }

    /* Left menu */
    .menu{ display:flex; flex-direction:column; border-radius:8px; overflow:hidden; }
    .main-btn{
      width:100%; text-align:left; padding:14px 8px; font-size:14px; border:none;
      background:var(--primary); color:#fff; cursor:pointer; transition:.2s; border-bottom:1px solid #3e9141;
    }
    .main-btn:last-child{ border-bottom:none; }
    .main-btn:hover,.main-btn:focus{ background:var(--primary-hover); outline:none; }

    /* Right content */
    .content{ background:#fafafa; border:1px solid #eee; border-radius:10px; box-shadow:var(--card-shadow); padding:16px; min-height:260px; }
    .page{ display:none; }
    .page.active{ display:block; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; }
    .actions .action-btn{
      padding:10px 12px; border-radius:8px; border:1px solid var(--primary);
      background:#fff; color:#2e7d32; cursor:pointer; font-size:13px; transition:all .2s;
    }
    .actions .action-btn:hover{ background:#e8f5e9; }

    .back{ display:inline-block; margin-bottom:10px; font-size:12px; color:#0b57d0; text-decoration:none; cursor:pointer; }

    /* Forms */
    .form{ background:#fff; border:1px solid #e9e9e9; border-radius:10px; padding:16px; position:relative; }
    .form-row{ margin-bottom:12px; }
    .form-row label{ display:block; font-size:14px; color:#333; margin-bottom:6px; }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="datetime-local"],
    .form-row input[type="file"],
    .form-row textarea{
      width:100%; padding:10px; border:1px solid #888; border-radius:8px; font-size:14px; background:#fff; box-sizing:border-box;
    }
    .form-row textarea{ min-height:90px; resize:vertical; }
    .form-row input[readonly]{ background:#f7f7f7; color:#555; }
    .form-actions{ display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
    .btn-primary{ background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn-primary:hover{ background:var(--primary-hover); }
    .btn-secondary{ background:#e9ecef; color:#111; border:1px solid #d0d7de; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; }

    /* Claim badge */
    .claim-stamp{
      position:absolute; top:10px; right:12px;
      background:#f1f8e9; border:1px solid #cfe3c4; color:#1b5e20;
      padding:6px 10px; border-radius:8px; font-weight:700; font-size:13px;
    }

    /* Travel voucher */
    .travel-title{ text-align:center; font-weight:700; margin-bottom:10px; }
    .travel-table{ width:100%; border-collapse:collapse; margin-bottom:12px; table-layout:fixed; }
    .travel-table th, .travel-table td{ border:1px solid #444; padding:6px; vertical-align:middle; }
    .travel-table b{ font-weight:700; }
    .travel-table input{ width:95%; padding:8px; border:1px solid #888; border-radius:6px; background:#fff; font-size:14px; box-sizing:border-box; }

    /* Expense section */
    .exp-card{ background:#fff; border:1px solid #e3e3e3; border-radius:10px; padding:12px; margin:10px 0; display:none; position:relative; }
    .exp-card.active{ display:block; }
    .exp-grid{ display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; }
    .exp-grid .cell{ display:flex; flex-direction:column; }
    .exp-grid label{ font-size:13px; margin-bottom:6px; color:#333; }

    /* Summary */
    .summary-wrap{ margin-top:12px; border:1px solid #cfd8dc; border-radius:10px; background:#fff; overflow:hidden; }
    .summary-head{ background:#f1f8e9; padding:8px 10px; font-weight:800; border-bottom:1px solid #cfd8dc; }
    .sum-table{ width:100%; border-collapse:collapse; }
    .sum-table th, .sum-table td{ border:1px solid #e0e0e0; padding:8px; }
    .sum-amount{ text-align:right; }
    .summary-total{ font-size:18px; font-weight:bold; background:#f7f7f7; }

    @media (max-width: 768px){
      .container{ grid-template-columns:1fr; margin:16px; }
      .menu{ flex-direction:row; }
      .main-btn{ flex:1; border-bottom:none; border-right:1px solid #3e9141; padding:10px; text-align:center; font-size:13px; }
      .main-btn:last-child{ border-right:none; }
      .travel-table, .travel-table tbody, .travel-table tr, .travel-table td{ display:block; width:100%; }
      .travel-table tr{ margin-bottom:10px; border:1px solid #ccc; border-radius:6px; padding:8px; background:#fdfdfd; }
      .travel-table td{ border:none; padding:6px 4px; }
      .travel-table td b{ display:block; margin-bottom:4px; }
      .travel-table input{ border:1px solid #ccc; border-radius:6px; padding:10px; width:100%; }
      .exp-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body data-username="">
  <div class="logo-header">
    <img class="logo" src="core/images/logo.png" alt="Company Logo">
  </div>

  <div class="container">
    <h1 class="header">Employee Dashboard</h1>

    <!-- Left menu -->
    <nav class="menu" aria-label="Main actions">
      <button class="main-btn" data-target="page-upload">Upload Voucher</button>
      <button class="main-btn" data-target="page-payment-form">Submit Payment Request</button>
      <button class="main-btn" data-target="page-payment-view">View Payment Request</button>
      <button class="main-btn" data-target="page-ledger">Download Ledger</button>
      <button class="main-btn" data-target="page-view">View Voucher</button>
    </nav>

    <!-- Right content -->
    <section class="content">
      <div id="page-home" class="page active"></div>

      <!-- Upload Voucher -->
      <div id="page-upload" class="page">
        <span class="back" data-target="page-home">← Back</span>
        <h2>Upload Voucher</h2>
        <div class="actions">
          <button class="action-btn" data-target="page-purchase-form">Purchase</button>
          <button class="action-btn" data-target="page-travel-form">Travel Voucher</button>
          <button class="action-btn" data-target="page-cash-form">Cash Voucher</button>
          <button class="action-btn" data-target="page-others-form">Others</button>
        </div>
      </div>

      <!-- Purchase Voucher -->
      <div id="page-purchase-form" class="page">
        <span class="back" data-target="page-upload">← Back</span>
        <h2>Purchase Voucher</h2>
        <form class="form" id="purchaseForm" data-code="P">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input type="date" required /></div>
          <div class="form-row"><label>Supplier Name:-</label><input type="text" required /></div>
          <div class="form-row"><label>Invoice No:-</label><input type="text" placeholder="INV-001" /></div>
          <div class="form-row"><label>Bill Date:-</label><input type="date" required /></div>
          <div class="form-row"><label>Amount:-</label><input type="text" placeholder="10000" required /></div>
          <div class="form-row"><label>Work Order:-</label><input type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input type="text" required /></div>
          <div class="form-row"><label>Upload Bill:-</label><input type="file" accept=".pdf,.jpg,.jpeg,.png" required /></div>
          <div class="form-actions"><button type="submit" class="btn-primary">Submit</button><button type="reset" class="btn-secondary">Reset</button></div>
        </form>
      </div>

      <!-- Travel Voucher -->
      <div id="page-travel-form" class="page">
        <span class="back" data-target="page-upload">← Back</span>
        <h2>Travel Voucher</h2>
        <form class="form" id="travelForm" data-code="T">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="travel-title">TRAVELING ALLOWANCE</div>

          <table class="travel-table">
            <tr>
              <td><b>Project Name / W.O # :</b><input type="text" name="project" required></td>
              <td><b>Date :</b><input type="date" name="date" required></td>
            </tr>
            <tr>
              <td><b>Customer :</b><input type="text" name="customer" required></td>
              <td><b>Name :</b><input type="text" name="name" required></td>
            </tr>
            <tr>
              <td><b>Designation :</b><input type="text" name="designation" required></td>
              <td><b>Place of Visit :</b><input type="text" name="place" required></td>
            </tr>
            <tr>
              <td><b>Purpose of Journey :</b><input type="text" name="purpose" required></td>
              <td><b>Visit Authorised By :</b><input type="text" name="authorised_by"></td>
            </tr>
            <tr>
              <td><b>From (Date) :</b><input type="date" name="from_date" required></td>
              <td><b>To (Date) :</b><input type="date" name="to_date" required></td>
            </tr>
          </table>

          <div class="form-actions" style="margin-top:12px;">
            <button type="submit" class="btn-primary">Submit Travel Voucher</button>
            <button type="reset" class="btn-secondary">Reset All</button>
          </div>

          <div class="actions" style="margin:8px 0 2px;">
            <button class="action-btn" type="button" data-exp="fare">Travel Fare</button>
            <button class="action-btn" type="button" data-exp="local">Local Travel</button>
            <button class="action-btn" type="button" data-exp="hotel">Hotel Accommodation</button>
            <button class="action-btn" type="button" data-exp="da">Daily & Food Allowance</button>
            <button class="action-btn" type="button" data-exp="misc">Miscellaneous Expenses</button>
          </div>

          <!-- (A) Travel Fare -->
          <div class="exp-card" id="card-fare">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(A) Travel Fare</h3>
            <div class="exp-grid">
              <div class="cell"><label>Sl No</label><input type="text" id="fare-sl" placeholder="1"></div>
              <div class="cell"><label>From Place</label><input type="text" id="fare-from"></div>
              <div class="cell"><label>To Place</label><input type="text" id="fare-to"></div>
              <div class="cell"><label>Date & Time of Departure</label><input type="datetime-local" id="fare-dep"></div>
              <div class="cell"><label>Date & Time of Arrival</label><input type="datetime-local" id="fare-arr"></div>
              <div class="cell"><label>Mode of Transport</label><input type="text" id="fare-mode"></div>
              <div class="cell"><label>Amount</label><input type="text" id="fare-amt" placeholder="10000"></div>
              <div class="cell"><label>Ticket No (Ticket to be enclosed)</label><input type="text" id="fare-ticket"></div>
              <div class="cell"><label>Ticket File</label><input type="file" id="fare-file" accept=".pdf,.jpg,.jpeg,.png"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="fare">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="fare">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="fare">Reset</button>
            </div>
          </div>

          <!-- (B) Local Travel -->
          <div class="exp-card" id="card-local">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(B) Local Travel</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="local-date"></div>
              <div class="cell"><label>From</label><input type="text" id="local-from"></div>
              <div class="cell"><label>To</label><input type="text" id="local-to"></div>
              <div class="cell"><label>Mode</label><input type="text" id="local-mode"></div>
              <div class="cell"><label>Amount</label><input type="text" id="local-amt" placeholder="1000"></div>
              <div class="cell"><label>Remarks</label><input type="text" id="local-remarks"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="local">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="local">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="local">Reset</button>
            </div>
          </div>

          <!-- (C) Hotel Accommodation -->
          <div class="exp-card" id="card-hotel">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(C) Hotel Accommodation</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Date</label><input type="date" id="hotel-from"></div>
              <div class="cell"><label>To Date</label><input type="date" id="hotel-to"></div>
              <div class="cell"><label>Hotel Name & Place</label><input type="text" id="hotel-name"></div>
              <div class="cell"><label>Amount</label><input type="text" id="hotel-amt" placeholder="4500"></div>
              <div class="cell"><label>Bill No (Bill to be enclosed)</label><input type="text" id="hotel-bill"></div>
              <div class="cell"><label>Bill File</label><input type="file" id="hotel-file" accept=".pdf,.jpg,.jpeg,.png"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="hotel">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="hotel">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="hotel">Reset</button>
            </div>
          </div>

          <!-- (D) Daily & Food Allowance -->
          <div class="exp-card" id="card-da">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(D) Daily Allowance & Food Allowance</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Date & Time</label><input type="datetime-local" id="da-from"></div>
              <div class="cell"><label>To Date & Time</label><input type="datetime-local" id="da-to"></div>
              <div class="cell"><label>No of Days</label><input type="text" id="da-days" placeholder="1.0"></div>
              <div class="cell"><label>DA/FA</label><input type="text" id="da-type" placeholder="DA or FA"></div>
              <div class="cell"><label>Amount</label><input type="text" id="da-amt" placeholder="800"></div>
              <div class="cell"><label>Remarks</label><input type="text" id="da-remarks"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="da">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="da">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="da">Reset</button>
            </div>
          </div>

          <!-- (E) Miscellaneous Expenses -->
          <div class="exp-card" id="card-misc">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(E) Miscellaneous Expenses</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="misc-date"></div>
              <div class="cell"><label>Particulars</label><input type="text" id="misc-particulars"></div>
              <div class="cell"><label>Amount</label><input type="text" id="misc-amt" placeholder="450"></div>
              <div class="cell"><label>Bill No (Bill to be enclosed)</label><input type="text" id="misc-bill"></div>
              <div class="cell"><label>Bill File</label><input type="file" id="misc-file" accept=".pdf,.jpg,.jpeg,.png"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="misc">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="misc">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="misc">Reset</button>
            </div>
          </div>

          <!-- Summary -->
          <div class="summary-wrap">
            <div class="summary-head">Summary</div>
            <table class="sum-table" id="summaryTable">
              <thead>
                <tr>
                  <th style="width:70px;">Sl No</th>
                  <th>Main Contents</th>
                  <th style="width:140px;">Amount Claimed</th>
                  <th style="width:180px;">Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>A</td><td>Travel Fare</td><td class="sum-amount" id="sum-fare">0.00</td><td></td></tr>
                <tr><td>B</td><td>Local Travel</td><td class="sum-amount" id="sum-local">0.00</td><td></td></tr>
                <tr><td>C</td><td>Hotel Accommodation</td><td class="sum-amount" id="sum-hotel">0.00</td><td></td></tr>
                <tr><td>D</td><td>Daily Allowance & Food Allowance</td><td class="sum-amount" id="sum-da">0.00</td><td></td></tr>
                <tr><td>E</td><td>Miscellaneous Expenses</td><td class="sum-amount" id="sum-misc">0.00</td><td></td></tr>
              </tbody>
              <tfoot>
                <tr class="summary-total">
                  <th colspan="2" style="text-align:right;">Total Amount</th>
                  <th class="sum-amount" id="sum-total">0.00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </form>
      </div>

      <!-- Cash Voucher -->
      <div id="page-cash-form" class="page">
        <span class="back" data-target="page-upload">← Back</span>
        <h2>Cash Voucher</h2>
        <form class="form" id="cashForm" data-code="C">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input type="date" required /></div>
          <div class="form-row"><label>Supplier Name:-</label><input type="text" required /></div>
          <div class="form-row"><label>Bill Date:-</label><input type="date" required /></div>
          <div class="form-row"><label>Amount:-</label><input type="text" placeholder="1000" required /></div>
          <div class="form-row"><label>Work Order:-</label><input type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input type="text" required /></div>
          <div class="form-row"><label>Upload Bill:-</label><input type="file" accept=".pdf,.jpg,.jpeg,.png" required /></div>
          <div class="form-actions"><button type="submit" class="btn-primary">Submit</button><button type="reset" class="btn-secondary">Reset</button></div>
        </form>
      </div>

      <!-- Others Voucher -->
      <div id="page-others-form" class="page">
        <span class="back" data-target="page-upload">← Back</span>
        <h2>Others Voucher</h2>
        <form class="form" id="othersForm" data-code="O">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input type="date" required /></div>
          <div class="form-row"><label>Description:-</label><input type="text" required /></div>
          <div class="form-row"><label>Amount:-</label><input type="text" required /></div>
          <div class="form-row"><label>Work Order:-</label><input type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input type="text" required /></div>
          <div class="form-row"><label>Upload Bill:-</label><input type="file" accept=".pdf,.jpg,.jpeg,.png" required /></div>
          <div class="form-actions"><button type="submit" class="btn-primary">Submit</button><button type="reset" class="btn-secondary">Reset</button></div>
        </form>
      </div>
      <div id="page-payment-form" class="page">
        <span class="back" data-target="page-home">← Back</span>
        <h2>Submit Payment Request</h2>
        <form class="form" id="paymentForm" data-code="PR">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input id="pr-date" type="date" required /></div>
          <div class="form-row"><label>Description:-</label><input id="pr-desc" type="text" required /></div>
          <div class="form-row"><label>Amount:-</label><input id="pr-amount" type="text" placeholder="20000" required /></div>
          <div class="form-row"><label>Work Order:-</label><input id="pr-wo" type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input id="pr-remarks" type="text" required /></div>
          <div class="form-actions">
            <button type="submit" class="btn-primary">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>
        </form>
      </div>
       <!-- View Payment Request -->
      <div id="page-payment-view" class="page">
        <span class="back" data-target="page-home">← Back</span>
        <h2>View Payment Request</h2>
        <div class="table-wrap">
          <table id="paymentTable">
            <thead>
              <tr>
                <th style="width:50px;">SL</th>
                <th style="width:120px;">Date</th>
                <th>Claim No</th>
                <th style="width:120px;">Amount</th>
                <th>Department Head</th>
                <th>Finance Head</th>
                <th>Accountant</th>
              </tr>
            </thead>
            <tbody id="paymentTbody">
              <tr class="empty"><td colspan="7">No payment requests yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="toolbar" style="display:flex;gap:8px;margin-top:8px;">
          <button id="refreshStatusBtn" class="btn-secondary">Refresh Statuses</button>
          <button id="seedDemoBtn" class="btn-secondary">Add Demo Rows</button>
        </div>
      </div>
      <!-- Ledger -->
      <div id="page-ledger" class="page">
        <span class="back" data-target="page-home">← Back</span>
        <h2>Download Ledger</h2>
        <div class="actions">
          <button class="action-btn" data-route="ledger-start-date.html">Start Date</button>
          <button class="action-btn" data-route="ledger-end-date.html">End Date</button>
        </div>
      </div>

      <!-- View Voucher -->
      <div id="page-view" class="page">
        <span class="back" data-target="page-home">← Back</span>
        <h2>View Voucher</h2>
        <div class="actions"><button class="action-btn" data-route="view-voucher.html">Open Voucher List</button></div>
      </div>
    </section>
  </div>

  <script>
    /* ============ Username & Claim helpers ============ */
    function readCookie(name){ return document.cookie.split('; ').find(r=>r.startsWith(name+'='))?.split('=')[1] || ''; }
    function getUsername(){ return (window.APP_USERNAME || document.body.dataset.username || readCookie('username') || '').trim(); }
    function firstLetterOfUser(){ const u=getUsername(); return u ? u[0].toUpperCase() : 'X'; }

    // Preview next sequence (not committed)
    function previewSeq(code){
      const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10);
      return n+1;
    }
    // Commit sequence on submit
    function commitSeq(code){
      const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10)+1;
      localStorage.setItem(k, String(n));
      return n;
    }
    function formatClaim(code, seq){
      const fl=firstLetterOfUser();
      if(code==='PR') return `${fl}-PR-${seq}`;
      return `${fl}-${code}V-${seq}`;
    }

    /* ============ Navigation ============ */
    const pages=document.querySelectorAll('.page');
    function showPage(id){
      pages.forEach(p=>p.classList.remove('active'));
      const pg=document.getElementById(id)||document.getElementById('page-home');
      pg.classList.add('active');
      const form=pg.querySelector('form');
      if(form) updateClaimPreview(form);
      if(id==='page-payment-view'){ renderPaymentTable(); }
    }
    document.querySelectorAll('[data-target]').forEach(btn=>{
      btn.addEventListener('click',()=> showPage(btn.dataset.target));
    });

    /* ============ Claim preview for forms ============ */
    function updateClaimPreview(formEl){
      const code=formEl.dataset.code;
      if(!code) return;
      const seqPreview = previewSeq(code);
      const claim = formatClaim(code, seqPreview);
      const bannerSp=formEl.querySelector('.claim-text');
      if(bannerSp) bannerSp.textContent = claim;
      formEl.querySelectorAll('.claim-text-inline').forEach(el=> el.textContent = claim);
      const hidden=formEl.querySelector('.claim');
      if(hidden) hidden.value = claim;
    }

    function wireUVForm(formId, successMsg){
      const f=document.getElementById(formId); if(!f) return;
      updateClaimPreview(f);
      f.addEventListener('submit',(e)=>{
        e.preventDefault();
        const code=f.dataset.code;
        const finalSeq = commitSeq(code);
        const finalClaim = formatClaim(code, finalSeq);
        const hidden=f.querySelector('.claim'); if(hidden) hidden.value = finalClaim;
        const banner=f.querySelector('.claim-text'); if(banner) banner.textContent = finalClaim;
        alert(`${successMsg}\nClaim No: ${finalClaim}`);
      });
      f.addEventListener('reset',()=> setTimeout(()=>{ updateClaimPreview(f); if(formId==='travelForm'){ clearTravelTotals(); } },0));
    }
    wireUVForm('purchaseForm','Purchase voucher submitted!');
    wireUVForm('travelForm','Travel voucher submitted!');
    wireUVForm('cashForm','Cash voucher submitted!');
    wireUVForm('othersForm','Other voucher submitted!');

    /* ============ Travel sub-sections show/hide ============ */
    function hideAllExpenseCards(){ document.querySelectorAll('.exp-card').forEach(c=>c.classList.remove('active')); }
    document.querySelectorAll('[data-exp]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        hideAllExpenseCards();
        const card=document.getElementById('card-'+btn.dataset.exp);
        if(card){ card.classList.add('active'); const form=card.closest('form'); if(form) updateClaimPreview(form); }
      });
    });
    hideAllExpenseCards();

    /* ============ Summary auto-calculation (Add Entry) ============ */
    const travelTotals = { fare:0, local:0, hotel:0, da:0, misc:0 };
    function parseAmount(str){
      if(!str) return 0;
      const cleaned = (str+'').replace(/[^0-9.]/g,'');
      const num = parseFloat(cleaned);
      return isNaN(num) ? 0 : num;
    }
    function updateSummaryUI(){
      const fmt = v => v.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('sum-fare').textContent = fmt(travelTotals.fare);
      document.getElementById('sum-local').textContent = fmt(travelTotals.local);
      document.getElementById('sum-hotel').textContent = fmt(travelTotals.hotel);
      document.getElementById('sum-da').textContent = fmt(travelTotals.da);
      document.getElementById('sum-misc').textContent = fmt(travelTotals.misc);
      const total = travelTotals.fare + travelTotals.local + travelTotals.hotel + travelTotals.da + travelTotals.misc;
      document.getElementById('sum-total').textContent = fmt(total);
    }
    function clearTravelTotals(){
      travelTotals.fare = travelTotals.local = travelTotals.hotel = travelTotals.da = travelTotals.misc = 0;
      updateSummaryUI();
    }
    updateSummaryUI();

    // Add Entry – accumulates amounts
    document.querySelectorAll('[data-addentry]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const kind = btn.getAttribute('data-addentry');
        let amt = 0;
        if(kind==='fare'){ amt = parseAmount(document.getElementById('fare-amt').value); }
        else if(kind==='local'){ amt = parseAmount(document.getElementById('local-amt').value); }
        else if(kind==='hotel'){ amt = parseAmount(document.getElementById('hotel-amt').value); }
        else if(kind==='da'){ amt = parseAmount(document.getElementById('da-amt').value); }
        else if(kind==='misc'){ amt = parseAmount(document.getElementById('misc-amt').value); }
        travelTotals[kind] += amt;
        updateSummaryUI();
        alert('Entry added. Summary updated (fields kept).');
      });
    });

    // Section Submit – acknowledge only
    document.querySelectorAll('[data-submit-section]').forEach(btn=>{
      btn.addEventListener('click',()=>{ alert('Section submitted (fields kept).'); });
    });

    // Section Reset – only clears that section
    document.querySelectorAll('[data-reset-section]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const section = btn.getAttribute('data-reset-section');
        const card = document.getElementById('card-'+section);
        if(!card) return;
        card.querySelectorAll('input[type="text"], input[type="date"], input[type="datetime-local"]').forEach(inp=> inp.value='');
        card.querySelectorAll('input[type="file"]').forEach(inp=> inp.value='');
      });
    });

    /* ============ Payment Request (typed voucher -> claim) ============ */
    function getUsernamePR(){ return getUsername(); }
    function firstLetterPR(){ const u=getUsernamePR(); return u ? u[0].toUpperCase() : 'X'; }
    function genPRClaim(){
      const vno=(document.getElementById('pr-vno')?.value||'').trim();
      const fl=firstLetterPR();
      document.getElementById('pr-claim').value = (fl && vno) ? `${fl}-PR-${vno}` : '';
    }
    const prVno=document.getElementById('pr-vno');
    const prForm=document.getElementById('paymentForm');
    if(prVno){ prVno.addEventListener('input', genPRClaim); genPRClaim(); }
    if(prForm){
      prForm.addEventListener('submit',(e)=>{
        e.preventDefault();
        genPRClaim();
        const date = document.getElementById('pr-date').value;
        const amount = document.getElementById('pr-amount').value;
        const claimNo = document.getElementById('pr-claim').value;
        addPaymentRequest({date, amount, claimNo});
        alert(`Payment request submitted!\nClaim No: ${claimNo}`);
      });
    }

    /* ============ Payment Request storage + approvals ============ */
    const LS_KEY='paymentRequests';
    const TWO_DAYS=2*24*60*60*1000;
    function loadPR(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
    function savePR(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function addPaymentRequest({date, amount, claimNo}){
      const arr=loadPR(); const now=Date.now();
      arr.push({ id:'pr_'+now, date, amount, claimNo, createdAt:now,
        stages:{dept:{status:'Pending',updatedAt:now},finance:{status:'Pending',updatedAt:null},accountant:{status:'Pending',updatedAt:null}},
        currentStage:'dept' });
      savePR(arr);
    }
    function approveStage(item, stage, auto=false){
      item.stages[stage].status = auto ? 'Auto-approved' : 'Approved';
      item.stages[stage].updatedAt = Date.now();
      const order=['dept','finance','accountant'], idx=order.indexOf(stage);
      if(idx<order.length-1){ const next=order[idx+1]; item.currentStage=next; if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now(); }
      else item.currentStage='done';
    }
    function applyAutoApprovals(item){
      const order=['dept','finance','accountant'];
      for(const stage of order){
        const st=item.stages[stage];
        if(st.status==='Pending'){
          const base = st.updatedAt ?? item.createdAt;
          if(Date.now()-base >= TWO_DAYS){ approveStage(item, stage, true); continue; }
          else break;
        }
      }
      if(item.stages.dept.status==='Pending') item.currentStage='dept';
      else if(item.stages.finance.status==='Pending') item.currentStage='finance';
      else if(item.stages.accountant.status==='Pending') item.currentStage='accountant';
      else item.currentStage='done';
      return item;
    }
    function manualApprove(id){
      const arr=loadPR(); const item=arr.find(x=>x.id===id); if(!item) return;
      applyAutoApprovals(item); if(item.currentStage==='done'){ savePR(arr); renderPaymentTable(); return; }
      approveStage(item, item.currentStage, false); savePR(arr); renderPaymentTable();
    }
    function renderPaymentTable(){
      let arr=loadPR(); if(arr.length===0){
        document.getElementById('paymentTbody').innerHTML=`<tr class="empty"><td colspan="7">No payment requests yet.</td></tr>`;
        return;
      }
      arr=arr.map(applyAutoApprovals); savePR(arr);
      const tbody=document.getElementById('paymentTbody'); tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const num = parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmtAmt=num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td>
          <td>${fmtAmt}</td><td>${renderStageCell(item,'dept')}</td>
          <td>${renderStageCell(item,'finance')}</td><td>${renderStageCell(item,'accountant')}</td>`;
        tbody.appendChild(tr);
      });
    }
    function renderStageCell(item, stage){
      const st=item.stages[stage], isActive=item.currentStage===stage, statusText=st.status;
      let cls='s-pending'; if(statusText==='Approved') cls='s-approved';
      else if(statusText==='Auto-approved') cls='s-auto';
      else if(statusText==='Rejected') cls='s-rejected';
      const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '—';
      const btn = isActive ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApprove('${item.id}')">Approve</button>` : '';
      return `<span class="${cls}">${statusText}</span>${btn}<div class="muted">Updated: ${updated}</div>`;
    }
    document.getElementById('seedDemoBtn')?.addEventListener('click',()=>{
      const now=Date.now();
      addPaymentRequest({date:new Date().toISOString().slice(0,10), amount:'1500', claimNo:'X-PR-101'});
      const arr=loadPR();
      arr.push({ id:'pr_demo_'+(now-1), date:new Date(now-3*24*60*60*1000).toISOString().slice(0,10),
        amount:'2500', claimNo:'Y-PR-202', createdAt: now-(2*24*60*60*1000+60*60*1000),
        stages:{dept:{status:'Pending',updatedAt:now-(2*24*60*60*1000+60*60*1000)}, finance:{status:'Pending',updatedAt:null}, accountant:{status:'Pending',updatedAt:null}},
        currentStage:'dept' });
      savePR(arr); renderPaymentTable(); alert('Demo rows added.');
    });
    document.getElementById('refreshStatusBtn')?.addEventListener('click',()=>{
      const arr=loadPR().map(applyAutoApprovals); savePR(arr); renderPaymentTable();
    });

    // Initialize
    document.querySelectorAll('.page.active form').forEach(updateClaimPreview);
    updateSummaryUI();
  </script>
</body>
</html>
