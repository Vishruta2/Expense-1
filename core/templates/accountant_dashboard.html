<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accountant Dashboard</title>
  {% load static %}
  <style>
    :root{
      --primary:#4CAF50; --primary-hover:#45a049;
      --pastel-dark:#81c784; --card-shadow:0 8px 24px rgba(0,0,0,0.12);
      --border:#e6e6e6; --ring:rgba(76,175,80,.25);
      --text:#1f2937;
    }
    body{ margin:0; font-family:Arial, sans-serif; background:var(--pastel-dark); color:var(--text); }
    .logo-header{ background:#000; padding:10px 18px; display:flex; align-items:center; gap:12px; color:#fff; }
    .logo{ height:35px; width:auto; }

    .container{ background:#fff; margin:30px; border-radius:14px; box-shadow:var(--card-shadow); padding:20px;
      display:grid; grid-template-columns: 220px 1fr; gap:20px; }
    .header{ grid-column:1/-1; text-align:center; font-size:24px; margin:0; color:#111; }

    /* Left menu */
    .menu{ display:flex; flex-direction:column; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:#fff; }
    .main-btn{
      width:100%; text-align:left; padding:12px 10px; font-size:14px; border:0; border-bottom:1px solid #f0f0f0;
      background:#fff; color:#111; cursor:pointer; transition:.15s;
    }
    .main-btn:hover{ background:#f5fff6; }
    .main-btn.active{ background:#e9f7ec; color:#0c5b16; font-weight:600; }

    /* Content area */
    .content{ background:#fafafa; border:1px solid #eee; border-radius:12px; box-shadow:var(--card-shadow); padding:16px; }
    .page{ display:none; } .page.active{ display:block; animation:fade .15s ease-out; }
    @keyframes fade{ from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:none;} }
    .page h2{ margin:0 0 12px; font-size:18px; }

    /* Back button – pill like your photo */
    .btn-back{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 16px; border-radius:9999px;
      border:1px solid #c8e6c9; background:#e8f5e9; color:#256029;
      font-weight:700; text-decoration:none; cursor:pointer; user-select:none; margin-bottom:10px;
    }
    .btn-back::before{ content:"←"; font-weight:900; }

    /* Buttons */
    .btn-primary{ background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn-primary:hover{ background:var(--primary-hover); }
    .btn-secondary{ background:#fff; border:1px solid #ccc; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; }

    /* Forms */
    .form{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:16px; position:relative; }
    .form-row{ margin-bottom:12px; }
    .form-row label{ display:block; margin-bottom:4px; font-size:14px; }
    .form-row input, .form-row select, .form-row textarea{ width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    .form-actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }

    /* Tables */
    .table-wrap{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; overflow:auto; margin-top:10px; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:#f5f5f5; padding:8px; text-align:left; }
    tbody td{ padding:8px; border-bottom:1px solid #eee; }
    .right{text-align:right;}
    .muted{ color:#6b7280; font-size:12px; display:block; margin-top:4px; }

    /* ===== Extra styles needed by the uploaded sections ===== */
    .content-card{ background:#fafafa; border:1px solid #eee; border-radius:10px; box-shadow:var(--card-shadow); padding:16px; }
    .action-btn{ padding:10px 12px; border-radius:8px; border:1px solid var(--primary); background:#fff; color:#2e7d32; cursor:pointer; font-size:13px; }
    .action-btn:hover{ background:#e8f5e9; }

    .claim-stamp{ position:absolute; top:10px; right:12px; background:#f1f8e9; border:1px solid #cfe3c4; color:#1b5e20; padding:6px 10px; border-radius:8px; font-weight:700; font-size:13px; }
    .travel-title{text-align:center;font-weight:700;margin-bottom:10px}
    .travel-table{width:100%;border-collapse:collapse;margin-bottom:12px;table-layout:fixed}
    .travel-table th,.travel-table td{border:1px solid #444;padding:6px;vertical-align:middle}
    .travel-table input{width:95%;padding:8px;border:1px solid #888;border-radius:6px;background:#fff;font-size:14px;box-sizing:border-box}
    .exp-card{background:#fff;border:1px solid #e3e3e3;border-radius:10px;padding:12px;margin:10px 0;display:none;position:relative}
    .exp-card.active{display:block}
    .exp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .exp-grid .cell{display:flex;flex-direction:column}
    .summary-wrap{margin-top:12px;border:1px solid #cfd8dc;border-radius:10px;background:#fff;overflow:hidden}
    .summary-head{background:#f1f8e9;padding:8px 10px;font-weight:800;border-bottom:1px solid #cfd8dc}
    .sum-table{width:100%;border-collapse:collapse}
    .sum-table th,.sum-table td{border:1px solid #e0e0e0;padding:8px}
    .sum-amount{text-align:right}
    .summary-total{font-size:18px;font-weight:bold;background:#f7f7f7}

    table.data{width:100%;border-collapse:collapse;font-size:14px}
    table.data th,table.data td{border:1px solid #e5e7eb;padding:8px;text-align:left}
    .s-pending{color:#9a6700}.s-approved{color:#116329}.s-auto{color:#1b4b91}.s-rejected{color:#a40e26}

    /* Cash voucher tiny table */
    .small-table{width:100%;border-collapse:collapse}
    .small-table th,.small-table td{padding:8px;border-bottom:1px solid #eee;font-size:13px}

    /* Ledger (download ledger page) */
    .ledger-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .ledger-title{font-size:28px;letter-spacing:1px;font-weight:800}
    .ledger-total{border:1px solid #111;border-collapse:collapse}
    .ledger-total th,.ledger-total td{border:1px solid #111;padding:6px 10px}
    .ledger-box{border:1px solid #111;border-collapse:collapse;width:100%}
    .ledger-box th,.ledger-box td{border:1px solid #111;padding:8px}
    .ledger-actions{display:flex;gap:8px;margin:10px 0}
    .ledger-actions .btn-secondary{padding:8px 10px}
    .ledger-wrap{background:#fff;border:1px solid #111;padding:14px;border-radius:8px}
    .number{text-align:right}

    @media(max-width:700px){ .container{ grid-template-columns:1fr; } .menu{ border-radius:8px; } }

    /* PRINT ONLY THE LEDGER BOX (hide menu/top) */
    @media print{
      body *{ visibility:hidden !important; }
      #dv-ledger #ledgerArea, #dv-ledger #ledgerArea *{ visibility:visible !important; }
      #dv-ledger #ledgerArea{
        position:absolute; left:0; top:0; width:100%; box-shadow:none; border-radius:0;
      }
      #dv-ledger .btn-back, #dv-ledger .ledger-actions{ display:none !important; }
      @page{ margin:12mm; }
    }
  </style>
</head>
<body data-username="">
  <div class="logo-header">
    <img class="logo" src="{% static 'core/images/logo.png' %}" alt="Company Logo">
    <span>Accountant Portal</span>
  </div>

  <div class="container">
    <h1 class="header">Accountant Dashboard</h1>

    <!-- LEFT MENU -->
    <nav class="menu">
      <button class="main-btn" data-target="dv-upload">Upload Voucher</button>
      <button class="main-btn" data-target="dv-payment-form">Payment Request</button>
      <button class="main-btn" data-target="dv-view-voucher">View Voucher</button>
      <button class="main-btn" data-target="dv-reports">Report</button>
      <button class="main-btn" data-target="dv-view-pr">View Payment Request</button>
      <button class="main-btn" data-target="page-update-logins">Update Logins</button>
      <button class="main-btn" data-target="dv-approval">Approval Pendings</button>
      <button class="main-btn" data-target="page-workorders">Workorder Details</button>
      <button class="main-btn" data-target="page-ledger">Ledger</button>
      <button class="main-btn" data-target="dv-ledger">Download Ledger</button>
    </nav>

    <!-- CONTENT -->
    <section class="content">

      <!-- BLANK DEFAULT PAGE (CENTER EMPTY ON LOAD) -->
      <div id="dashboard-home" class="page active"></div>

      <!-- ======= REPLACED SECTIONS (from uploaded file) ======= -->

      <!-- Upload Voucher (chooser) -->
      <div id="dv-upload" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Upload Voucher</h2>
        <div class="actions">
          <button class="action-btn" data-target="dv-purchase">Purchase</button>
          <button class="action-btn" data-target="dv-travel">Travel Voucher</button>
          <button class="action-btn" data-target="dv-cash">Cash Voucher</button>
          <button class="action-btn" data-target="dv-others">Others</button>
        </div>
      </div>

      <!-- Purchase Voucher -->
      <div id="dv-purchase" class="page">
        <a class="btn-back" data-target="dv-upload">Back</a>
        <h2>Purchase Voucher</h2>
        <form class="form" id="purchaseForm" data-code="P">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input id="pv-date" type="date" required /></div>
          <div class="form-row"><label>Supplier Name:-</label><input id="pv-supplier" type="text" required /></div>
          <div class="form-row"><label>Invoice No:-</label><input id="pv-invoice" type="text" /></div>
          <div class="form-row"><label>Bill Date:-</label><input id="pv-billdate" type="date" required /></div>
          <div class="form-row"><label>Amount:-</label><input id="pv-amt" type="text" required /></div>
          <div class="form-row"><label>Work Order:-</label><input id="pv-wo" type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input id="pv-remarks" type="text" /></div>
          <div class="form-row"><label>Upload Bill:-</label><input id="pv-file" type="file" accept=".pdf,.jpg,.jpeg,.png" multiple /></div>
          <div class="form-actions">
            <button type="submit" class="btn-primary">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>
        </form>
      </div>

      <!-- Travel Voucher -->
      <div id="dv-travel" class="page">
        <a class="btn-back" data-target="dv-upload">Back</a>
        <h2>Travel Voucher</h2>
        <form class="form" id="travelForm" data-code="T">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="travel-title">TRAVELING ALLOWANCE</div>

          <table class="travel-table">
            <tr>
              <td><b>Project Name / W.O # :</b><input id="tv-wo" type="text" required></td>
              <td><b>Date :</b><input id="tv-date" type="date" required></td>
            </tr>
            <tr>
              <td><b>Customer :</b><input id="tv-customer" type="text" required></td>
              <td><b>Name :</b><input id="tv-name" type="text" required></td>
            </tr>
            <tr>
              <td><b>Designation :</b><input id="tv-desig" type="text" required></td>
              <td><b>Place of Visit :</b><input id="tv-place" type="text" required></td>
            </tr>
            <tr>
              <td><b>Purpose of Journey :</b><input id="tv-purpose" type="text" required></td>
              <td><b>Visit Authorised By :</b><input id="tv-auth" type="text"></td>
            </tr>
            <tr>
              <td><b>From (Date) :</b><input id="tv-from" type="date" required></td>
              <td><b>To (Date) :</b><input id="tv-to" type="date" required></td>
            </tr>
          </table>

          <div class="form-actions" style="margin-top:12px;">
            <button type="submit" class="btn-primary">Submit Travel Voucher</button>
            <button type="reset" class="btn-secondary">Reset All</button>
          </div>

          <div class="actions" style="margin:8px 0 2px;">
            <button class="action-btn" type="button" data-exp="fare">Travel Fare</button>
            <button class="action-btn" type="button" data-exp="local">Local Travel</button>
            <button class="action-btn" type="button" data-exp="hotel">Hotel Accommodation</button>
            <button class="action-btn" type="button" data-exp="da">Daily & Food Allowance</button>
            <button class="action-btn" type="button" data-exp="misc">Miscellaneous Expenses</button>
          </div>

          <!-- Travel subcards -->
          <div class="exp-card" id="card-fare">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(A) Travel Fare</h3>
            <div class="exp-grid">
              <div class="cell"><label>Sl No</label><input type="text" id="fare-sl"></div>
              <div class="cell"><label>From Place</label><input type="text" id="fare-from"></div>
              <div class="cell"><label>To Place</label><input type="text" id="fare-to"></div>
              <div class="cell"><label>Date & Time of Departure</label><input type="datetime-local" id="fare-dep"></div>
              <div class="cell"><label>Date & Time of Arrival</label><input type="datetime-local" id="fare-arr"></div>
              <div class="cell"><label>Mode of Transport</label><input type="text" id="fare-mode"></div>
              <div class="cell"><label>Amount</label><input type="text" id="fare-amt"></div>
              <div class="cell"><label>Ticket No</label><input type="text" id="fare-ticket"></div>
              <div class="cell"><label>Ticket File</label><input type="file" id="fare-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="fare">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="fare">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="fare">Reset</button>
            </div>
          </div>

          <div class="exp-card" id="card-local">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(B) Local Travel</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="local-date"></div>
              <div class="cell"><label>From</label><input type="text" id="local-from"></div>
              <div class="cell"><label>To</label><input type="text" id="local-to"></div>
              <div class="cell"><label>Mode</label><input type="text" id="local-mode"></div>
              <div class="cell"><label>Amount</label><input type="text" id="local-amt"></div>
              <div class="cell"><label>Remarks</label><input type="text" id="local-remarks"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="local">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="local">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="local">Reset</button>
            </div>
          </div>

          <div class="exp-card" id="card-hotel">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(C) Hotel Accommodation</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Date</label><input type="date" id="hotel-from"></div>
              <div class="cell"><label>To Date</label><input type="date" id="hotel-to"></div>
              <div class="cell"><label>Hotel Name & Place</label><input type="text" id="hotel-name"></div>
              <div class="cell"><label>Amount</label><input type="text" id="hotel-amt"></div>
              <div class="cell"><label>Bill No</label><input type="text" id="hotel-bill"></div>
              <div class="cell"><label>Bill File</label><input type="file" id="hotel-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="hotel">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="hotel">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="hotel">Reset</button>
            </div>
          </div>

          <div class="exp-card" id="card-da">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(D) Daily Allowance & Food Allowance</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Date & Time</label><input type="datetime-local" id="da-from"></div>
              <div class="cell"><label>To Date & Time</label><input type="datetime-local" id="da-to"></div>
              <div class="cell"><label>No of Days</label><input type="text" id="da-days"></div>
              <div class="cell"><label>DA/FA</label><input type="text" id="da-type"></div>
              <div class="cell"><label>Amount</label><input type="text" id="da-amt"></div>
              <div class="cell"><label>Remarks</label><input type="text" id="da-remarks"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="da">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="da">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="da">Reset</button>
            </div>
          </div>

          <div class="exp-card" id="card-misc">
            <div class="claim-stamp">Claim No: <span class="claim-text-inline">—</span></div>
            <h3>(E) Miscellaneous Expenses</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="misc-date"></div>
              <div class="cell"><label>Particulars</label><input type="text" id="misc-particulars"></div>
              <div class="cell"><label>Amount</label><input type="text" id="misc-amt"></div>
              <div class="cell"><label>Bill No</label><input type="text" id="misc-bill"></div>
              <div class="cell"><label>Bill File</label><input type="file" id="misc-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="misc">Add Entry</button>
              <button type="button" class="btn-primary" data-submit-section="misc">Submit</button>
              <button type="button" class="btn-secondary" data-reset-section="misc">Reset</button>
            </div>
          </div>

          <div class="summary-wrap">
            <div class="summary-head">Summary</div>
            <table class="sum-table" id="summaryTable">
              <thead>
                <tr>
                  <th style="width:70px;">Sl No</th>
                  <th>Main Contents</th>
                  <th style="width:140px;">Amount Claimed</th>
                  <th style="width:180px;">Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>A</td><td>Travel Fare</td><td class="sum-amount" id="sum-fare">0.00</td><td></td></tr>
                <tr><td>B</td><td>Local Travel</td><td class="sum-amount" id="sum-local">0.00</td><td></td></tr>
                <tr><td>C</td><td>Hotel Accommodation</td><td class="sum-amount" id="sum-hotel">0.00</td><td></td></tr>
                <tr><td>D</td><td>Daily Allowance & Food Allowance</td><td class="sum-amount" id="sum-da">0.00</td><td></td></tr>
                <tr><td>E</td><td>Miscellaneous Expenses</td><td class="sum-amount" id="sum-misc">0.00</td><td></td></tr>
              </tbody>
              <tfoot>
                <tr class="summary-total">
                  <th colspan="2" style="text-align:right;">Total Amount</th>
                  <th class="sum-amount" id="sum-total">0.00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </form>
      </div>

      <!-- Cash Voucher -->
      <div id="dv-cash" class="page">
        <a class="btn-back" data-target="dv-upload">Back</a>
        <h2>Cash Voucher</h2>
        <form class="form" id="cashForm" data-code="C">
          <div class="form-row"><label>Date:-</label><input id="cash-date" type="date" required /></div>
          <div class="form-row"><label>Particulars:-</label><input id="cash-particulars" type="text" placeholder="Type particulars..."/></div>
          <div class="form-row">
            <label>HEAD OF ACCOUNT:-</label>
            <select id="cash-head">
              <option value="" selected disabled>-- Select Head of Account --</option>
              <option>Conveyance</option><option>Staff Welfare Expenses</option><option>Printing & Stationary</option>
              <option>Postage & Telegram</option><option>Vehicle Maintenance</option><option>Frieght(Inward / Forward)</option>
              <option>Raw Materials</option><option>Consumable</option><option>Others</option>
            </select>
          </div>
          <div class="form-row"><label>Amount:-</label><input id="cash-amount" type="number" step="0.01" min="0" placeholder="0.00" /></div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>

          <div class="form-row">
            <div class="table-wrap">
              <table class="small-table" id="cashItemsTable">
                <thead><tr><th>Date</th><th>Particulars</th><th>Head of Account</th><th class="right">Amount</th></tr></thead>
                <tbody id="cashItemsBody"><tr><td colspan="4" class="muted">No items added.</td></tr></tbody>
                <tfoot><tr><th colspan="3" class="right">Total</th><th class="right">₹ <span id="cashTotal">0.00</span></th></tr></tfoot>
              </table>
            </div>
          </div>
          <input id="cashTotalInput" type="number" step="0.01" name="total" hidden />
        </form>
      </div>

      <!-- Others Voucher -->
      <div id="dv-others" class="page">
        <a class="btn-back" data-target="dv-upload">Back</a>
        <h2>Others Voucher</h2>
        <form class="form" id="othersForm" data-code="O">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" />
          <div class="form-row"><label>Date:-</label><input id="ov-date" type="date" required /></div>
          <div class="form-row"><label>Description:-</label><input id="ov-desc" type="text" required /></div>
          <div class="form-row"><label>Amount:-</label><input id="ov-amt" type="text" required /></div>
          <div class="form-row"><label>Work Order:-</label><input id="ov-wo" type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input id="ov-remarks" type="text" /></div>
          <div class="form-row"><label>Upload Bill:-</label><input id="ov-file" type="file" accept=".pdf,.jpg,.jpeg,.png" multiple /></div>
          <div class="form-actions"><button type="submit" class="btn-primary">Submit</button><button type="reset" class="btn-secondary">Reset</button></div>
        </form>
      </div>

      <!-- Payment Request (form) -->
      <div id="dv-payment-form" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Submit Payment Request</h2>
        <form class="form" id="paymentForm" data-code="PR">
          <div class="claim-stamp">Claim No: <span class="claim-text">—</span></div>
          <input type="hidden" class="claim" id="pr-claim"/>
          <div class="form-row"><label>Date:-</label><input id="pr-date" type="date" required /></div>
          <div class="form-row"><label>Description:-</label><input id="pr-desc" type="text" required /></div>
          <div class="form-row"><label>Amount:-</label><input id="pr-amount" type="text" required /></div>
          <div class="form-row"><label>Work Order:-</label><input id="pr-wo" type="text" /></div>
          <div class="form-row"><label>Remarks:-</label><input id="pr-remarks" type="text" required /></div>
          <div class="form-actions">
            <button type="submit" class="btn-primary">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>
        </form>
      </div>

      <!-- View Payment Request -->
      <div id="dv-view-pr" class="page">
        <a class="btn-back" data-target="dv-payment-form">Back</a>
        <h2>View Payment Request</h2>
        <div class="table-wrap">
          <table class="data" id="paymentTable">
            <thead>
              <tr>
                <th style="width:50px;">SL</th>
                <th style="width:120px;">Date</th>
                <th>Claim No</th>
                <th style="width:120px;">Amount</th>
                <th>Department Head</th>
                <th>Finance Head</th>
                <th>Accountant</th>
              </tr>
            </thead>
            <tbody id="paymentTbody">
              <tr class="empty"><td colspan="7">No payment requests yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="refreshStatusBtn" class="btn-secondary">Refresh Statuses</button>
          <button id="seedDemoBtn" class="btn-secondary">Add Demo Rows</button>
        </div>
      </div>

      <!-- Approval Pendings -->
      <div id="dv-approval" class="page">
        <a class="btn-back" data-target="dv-payment-form">Back</a>
        <h2>Approval Pendings</h2>

        <h3 style="margin-top:0">Payment Requests waiting for Dept Head</h3>
        <div class="table-wrap" style="margin-bottom:16px;">
          <table class="data">
            <thead>
              <tr>
                <th style="width:50px;">SL</th>
                <th style="width:120px;">Date</th>
                <th>Claim No</th>
                <th style="width:120px;">Amount</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="pendingPRTbody">
              <tr class="empty"><td colspan="5">Nothing pending.</td></tr>
            </tbody>
          </table>
        </div>

        <h3>Vouchers waiting for Dept Head</h3>
        <div class="table-wrap">
          <table class="data">
            <thead>
              <tr>
                <th style="width:50px;">SL</th>
                <th style="width:120px;">Date</th>
                <th>Claim No</th>
                <th style="width:120px;">Amount</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="pendingVTbody">
              <tr class="empty"><td colspan="5">Nothing pending.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Download Ledger -->
      <div id="dv-ledger" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Download Ledger</h2>

        <div class="ledger-actions">
          <button class="btn-secondary" onclick="window.print()">Print / Download</button>
        </div>
        <div class="ledger-wrap" id="ledgerArea">
          <div class="ledger-top">
            <div class="ledger-title">
              <input id="ledgerName" value="HANUMANTHA" style="font:inherit;font-weight:800;border:none;border-bottom:1px solid #111;outline:0;width:100%;max-width:360px"/>
            </div>
            <table class="ledger-total">
              <tr><th>TOTAL</th><th>CREDIT</th><td id="lt-credit" class="number">0</td></tr>
              <tr><td></td><th>DEBIT</th><td id="lt-debit" class="number">0</td></tr>
              <tr><td></td><th>BALANCE</th><td id="lt-balance" class="number">0</td></tr>
            </table>
          </div>

          <table class="ledger-box" id="ledgerTable">
            <thead>
              <tr>
                <th style="width:60px;">SL NO.</th>
                <th style="width:140px;">DATE</th>
                <th>VOUCHER NO</th>
                <th style="width:140px;">DEBIT</th>
                <th style="width:140px;">CREDIT</th>
                <th>REMARKS</th>
              </tr>
            </thead>
            <tbody id="ledgerBody"></tbody>
            <tfoot>
              <tr>
                <th colspan="3" style="text-align:right">TOTAL</th>
                <th id="lb-debit" class="number">0</th>
                <th id="lb-credit" class="number">0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- View Voucher -->
      <div id="dv-view-voucher" class="page">
        <a class="btn-back" data-target="dv-upload">Back</a>
        <h2>View Voucher</h2>
        <div class="table-wrap">
          <table class="data" id="voucherTable">
            <thead>
              <tr>
                <th style="width:50px;">SL</th>
                <th style="width:120px;">Date</th>
                <th>Claim No</th>
                <th style="width:120px;">Amount</th>
                <th>Accountant</th>
                <th>Department Head</th>
                <th>Finance Head</th>
              </tr>
            </thead>
            <tbody id="voucherTbody">
              <tr class="empty"><td colspan="7">No vouchers yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="voucherRefreshBtn" class="btn-secondary">Refresh Statuses</button>
          <button id="voucherSeedBtn" class="btn-secondary">Add Demo Rows</button>
        </div>
      </div>

      <!-- Reports home + detail pages -->
      <div id="dv-reports" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Reports</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="rpt-purchase">Purchase</button>
          <button class="btn-secondary" data-target="rpt-travel">Travel Voucher</button>
          <button class="btn-secondary" data-target="rpt-cash">Cash Voucher</button>
          <button class="btn-secondary" data-target="rpt-others">Other Voucher</button>
          <button class="btn-secondary" data-target="rpt-wo">Workorder wise</button>
        </div>
      </div>

      <div id="rpt-purchase" class="page">
        <a class="btn-back" data-target="dv-reports">Back</a>
        <h2>Purchase Vouchers</h2>
        <div class="table-wrap">
          <table class="data">
            <thead><tr><th>Date</th><th>Claim No</th><th>Amount</th><th>Workorder</th><th>Files</th><th>Remarks</th></tr></thead>
            <tbody id="rpt-purchase-body"><tr class="empty"><td colspan="6">No data.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="rpt-travel" class="page">
        <a class="btn-back" data-target="dv-reports">Back</a>
        <h2>Travel Vouchers</h2>
        <div class="table-wrap">
          <table class="data">
            <thead><tr><th>Date</th><th>Claim No</th><th>Amount</th><th>Workorder</th><th>Files</th><th>Remarks</th></tr></thead>
            <tbody id="rpt-travel-body"><tr class="empty"><td colspan="6">No data.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="rpt-cash" class="page">
        <a class="btn-back" data-target="dv-reports">Back</a>
        <h2>Cash Vouchers</h2>
        <div class="table-wrap">
          <table class="data">
            <thead><tr><th>Date</th><th>Claim No</th><th>Amount</th><th>Workorder</th><th>Files</th><th>Remarks</th></tr></thead>
            <tbody id="rpt-cash-body"><tr class="empty"><td colspan="6">No data.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="rpt-others" class="page">
        <a class="btn-back" data-target="dv-reports">Back</a>
        <h2>Other Vouchers</h2>
        <div class="table-wrap">
          <table class="data">
            <thead><tr><th>Date</th><th>Claim No</th><th>Amount</th><th>Workorder</th><th>Files</th><th>Remarks</th></tr></thead>
            <tbody id="rpt-others-body"><tr class="empty"><td colspan="6">No data.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="rpt-wo" class="page">
        <a class="btn-back" data-target="dv-reports">Back</a>
        <h2>Workorder wise</h2>
        <div class="actions" style="align-items:center;margin-bottom:6px;">
          <span class="muted" style="min-width:120px;">Select Workorder:</span>
          <select id="woFilter" style="padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer;"></select>
        </div>
        <h3 id="woTitle" style="margin:6px 0 2px 0;">Workorder No: —</h3>
        <div id="woRange" class="muted" style="margin-bottom:10px;">From — To —</div>
        <div class="table-wrap">
          <table class="data">
            <thead>
              <tr>
                <th style="width:120px;">Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Type of Business</th>
                <th>Customer</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="rpt-wo-body"><tr class="empty"><td colspan="6">No entries yet.</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ======= SECTIONS KEPT "AS IS" (Accountant-only) ======= -->

      <!-- Update Logins -->
      <div id="page-update-logins" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Update Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-emp">Employee</button>
          <button class="btn-secondary" data-target="ul-mgr">Manager</button>
          <button class="btn-secondary" data-target="ul-acct">Accountant</button>
          <button class="btn-secondary" data-target="ul-dept">Department Head</button>
          <button class="btn-secondary" data-target="ul-fin">Finance Head</button>
        </div>
      </div>

      <!-- EMP -->
      <div id="ul-emp" class="page">
        <a class="btn-back" data-target="page-update-logins">Back</a>
        <h2>Employee Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-emp-add">Add Employee</button>
          <button class="btn-secondary" data-target="ul-emp-list">Total Employee</button>
        </div>
      </div>
      <div id="ul-emp-add" class="page">
        <a class="btn-back" data-target="ul-emp">Back</a>
        <h2>Add Employee</h2>
        <form class="form ul-form" data-role="employee">
          <div class="form-row"><label>Name:</label><input type="text" required/></div>
          <div class="form-row"><label>Username:</label><input type="text" required/></div>
          <div class="form-row"><label>Password:</label><input type="password" required/></div>
          <div class="form-actions"><button class="btn-primary" type="submit">Update</button><button class="btn-secondary" type="reset">Reset</button></div>
        </form>
      </div>
      <div id="ul-emp-list" class="page">
        <a class="btn-back" data-target="ul-emp">Back</a>
        <h2>Total Employee</h2>
        <div class="table-wrap">
          <table class="data"><thead><tr><th>Name</th><th>Username</th><th>Password</th></tr></thead><tbody data-role-list="employee"><tr class="empty"><td colspan="3">No entries yet.</td></tr></tbody></table>
        </div>
      </div>

      <!-- MGR -->
      <div id="ul-mgr" class="page">
        <a class="btn-back" data-target="page-update-logins">Back</a>
        <h2>Manager Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-mgr-add">Add Manager</button>
          <button class="btn-secondary" data-target="ul-mgr-list">Total Manager</button>
        </div>
      </div>
      <div id="ul-mgr-add" class="page">
        <a class="btn-back" data-target="ul-mgr">Back</a>
        <h2>Add Manager</h2>
        <form class="form ul-form" data-role="manager">
          <div class="form-row"><label>Name:</label><input type="text" required/></div>
          <div class="form-row"><label>Username:</label><input type="text" required/></div>
          <div class="form-row"><label>Password:</label><input type="password" required/></div>
          <div class="form-actions"><button class="btn-primary" type="submit">Update</button><button class="btn-secondary" type="reset">Reset</button></div>
        </form>
      </div>
      <div id="ul-mgr-list" class="page">
        <a class="btn-back" data-target="ul-mgr">Back</a>
        <h2>Total Manager</h2>
        <div class="table-wrap">
          <table class="data"><thead><tr><th>Name</th><th>Username</th><th>Password</th></tr></thead><tbody data-role-list="manager"><tr class="empty"><td colspan="3">No entries yet.</td></tr></tbody></table>
        </div>
      </div>

      <!-- ACCT -->
      <div id="ul-acct" class="page">
        <a class="btn-back" data-target="page-update-logins">Back</a>
        <h2>Accountant Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-acct-add">Add Accountant</button>
          <button class="btn-secondary" data-target="ul-acct-list">Total Accountant</button>
        </div>
      </div>
      <div id="ul-acct-add" class="page">
        <a class="btn-back" data-target="ul-acct">Back</a>
        <h2>Add Accountant</h2>
        <form class="form ul-form" data-role="accountant">
          <div class="form-row"><label>Name:</label><input type="text" required/></div>
          <div class="form-row"><label>Username:</label><input type="text" required/></div>
          <div class="form-row"><label>Password:</label><input type="password" required/></div>
          <div class="form-actions"><button class="btn-primary" type="submit">Update</button><button class="btn-secondary" type="reset">Reset</button></div>
        </form>
      </div>
      <div id="ul-acct-list" class="page">
        <a class="btn-back" data-target="ul-acct">Back</a>
        <h2>Total Accountant</h2>
        <div class="table-wrap">
          <table class="data"><thead><tr><th>Name</th><th>Username</th><th>Password</th></tr></thead><tbody data-role-list="accountant"><tr class="empty"><td colspan="3">No entries yet.</td></tr></tbody></table>
        </div>
      </div>

      <!-- DEPT -->
      <div id="ul-dept" class="page">
        <a class="btn-back" data-target="page-update-logins">Back</a>
        <h2>Department Head Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-dept-add">Add Dept Head</button>
          <button class="btn-secondary" data-target="ul-dept-list">Total Dept Head</button>
        </div>
      </div>
      <div id="ul-dept-add" class="page">
        <a class="btn-back" data-target="ul-dept">Back</a>
        <h2>Add Department Head</h2>
        <form class="form ul-form" data-role="depthead">
          <div class="form-row"><label>Name:</label><input type="text" required/></div>
          <div class="form-row"><label>Username:</label><input type="text" required/></div>
          <div class="form-row"><label>Password:</label><input type="password" required/></div>
          <div class="form-actions"><button class="btn-primary" type="submit">Update</button><button class="btn-secondary" type="reset">Reset</button></div>
        </form>
      </div>
      <div id="ul-dept-list" class="page">
        <a class="btn-back" data-target="ul-dept">Back</a>
        <h2>Total Dept Head</h2>
        <div class="table-wrap">
          <table class="data"><thead><tr><th>Name</th><th>Username</th><th>Password</th></tr></thead><tbody data-role-list="depthead"><tr class="empty"><td colspan="3">No entries yet.</td></tr></tbody></table>
        </div>
      </div>

      <!-- FIN -->
      <div id="ul-fin" class="page">
        <a class="btn-back" data-target="page-update-logins">Back</a>
        <h2>Finance Head Logins</h2>
        <div class="actions">
          <button class="btn-secondary" data-target="ul-fin-add">Add Finance Head</button>
          <button class="btn-secondary" data-target="ul-fin-list">Total Finance Head</button>
        </div>
      </div>
      <div id="ul-fin-add" class="page">
        <a class="btn-back" data-target="ul-fin">Back</a>
        <h2>Add Finance Head</h2>
        <form class="form ul-form" data-role="financehead">
          <div class="form-row"><label>Name:</label><input type="text" required/></div>
          <div class="form-row"><label>Username:</label><input type="text" required/></div>
          <div class="form-row"><label>Password:</label><input type="password" required/></div>
          <div class="form-actions"><button class="btn-primary" type="submit">Update</button><button class="btn-secondary" type="reset">Reset</button></div>
        </form>
      </div>
      <div id="ul-fin-list" class="page">
        <a class="btn-back" data-target="ul-fin">Back</a>
        <h2>Total Finance Head</h2>
        <div class="table-wrap">
          <table class="data"><thead><tr><th>Name</th><th>Username</th><th>Password</th></tr></thead><tbody data-role-list="financehead"><tr class="empty"><td colspan="3">No entries yet.</td></tr></tbody></table>
        </div>
      </div>

      <!-- Workorder Details -->
      <div id="page-workorders" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Workorder Details</h2>
        <div class="form">Add your Accountant-specific workorder details UI here.</div>
      </div>

      <!-- Ledger (extra Accountant section – separate from Download Ledger) -->
      <div id="page-ledger" class="page">
        <a class="btn-back" data-target="dashboard-home">Back</a>
        <h2>Ledger</h2>
        <div class="form">Extra ledger tools/widgets can go here.</div>
      </div>

    </section>
  </div>

  <script>
    /* ===== Simple router: toggle pages, keep left-menu active ===== */
    const pages = document.querySelectorAll('.page');
    const menuBtns = document.querySelectorAll('.main-btn');

    function showPage(id){
      pages.forEach(p=>p.classList.remove('active'));
      const el = document.getElementById(id) || document.querySelector('#'+id);
      (el||document.getElementById('dashboard-home')).classList.add('active');

      // highlight left menu button if it targets this id
      menuBtns.forEach(b=>b.classList.toggle('active', b.dataset.target===id));

      // lazy renders
      if(id==='dv-view-pr'){ renderPaymentTable(); }
      if(id==='dv-approval'){ renderPendingPRTable(); renderPendingVTable(); }
      if(id==='dv-view-voucher'){ renderVoucherTable(); }
      if(id==='dv-ledger'){ if(!window._ledgerLoaded){ fillSampleLedger(); window._ledgerLoaded=true; } }
      if(id && id.startsWith('rpt-')){ renderReports(); if(id==='rpt-wo'){ renderWOReport(); } }
    }

    document.addEventListener('click',(e)=>{
      const t = e.target.closest('[data-target]');
      if(!t) return;
      e.preventDefault();
      showPage(t.getAttribute('data-target'));
    });

    // initial: BLANK PAGE
    showPage('dashboard-home');

    /* ===== Helpers from uploaded file (adapted) ===== */
    function readCookie(name){ return document.cookie.split('; ').find(r=>r.startsWith(name+'='))?.split('=')[1] || ''; }
    function getUsername(){ return (window.APP_USERNAME || document.body.dataset.username || readCookie('username') || '').trim(); }
    function firstLetterOfUser(){ const u=getUsername(); return u ? u[0].toUpperCase() : 'X'; }
    function previewSeq(code){ const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10); return n+1; }
    function commitSeq(code){ const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10)+1; localStorage.setItem(k,String(n)); return n; }
    function formatClaim(code, seq){ const fl=firstLetterOfUser(); return code==='PR' ? `${fl}-PR-${seq}` : `${fl}-${code}V-${seq}`; }
    function updateClaimPreview(formEl){
      const code=formEl?.dataset?.code; if(!code) return;
      const seq = previewSeq(code); const claim = formatClaim(code, seq);
      formEl.querySelector('.claim')?.setAttribute('value', claim);
      formEl.querySelectorAll('.claim-text,.claim-text-inline').forEach(el=> el.textContent = claim);
    }

    // Travel totals + summary
    const travelTotals={fare:0,local:0,hotel:0,da:0,misc:0};
    function parseAmount(str){ if(!str) return 0; const n=parseFloat((str+'').replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; }
    function updateSummaryUI(){
      const fmt=v=>v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      (document.getElementById('sum-fare')||{}).textContent=fmt(travelTotals.fare);
      (document.getElementById('sum-local')||{}).textContent=fmt(travelTotals.local);
      (document.getElementById('sum-hotel')||{}).textContent=fmt(travelTotals.hotel);
      (document.getElementById('sum-da')||{}).textContent=fmt(travelTotals.da);
      (document.getElementById('sum-misc')||{}).textContent=fmt(travelTotals.misc);
      (document.getElementById('sum-total')||{}).textContent=fmt(travelTotals.fare+travelTotals.local+travelTotals.hotel+travelTotals.da+travelTotals.misc);
    }
    function clearTravelTotals(){ travelTotals.fare=travelTotals.local=travelTotals.hotel=travelTotals.da=travelTotals.misc=0; updateSummaryUI(); }
    updateSummaryUI();

    document.querySelectorAll('[data-exp]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.exp-card').forEach(c=>c.classList.remove('active'));
        const card=document.getElementById('card-'+btn.dataset.exp);
        if(card){ card.classList.add('active'); updateClaimPreview(document.getElementById('travelForm')); }
      });
    });

    document.querySelectorAll('[data-addentry]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const k=btn.getAttribute('data-addentry');
        const m = k==='fare' ? parseAmount(document.getElementById('fare-amt').value)
                : k==='local'? parseAmount(document.getElementById('local-amt').value)
                : k==='hotel'? parseAmount(document.getElementById('hotel-amt').value)
                : k==='da'   ? parseAmount(document.getElementById('da-amt').value)
                : parseAmount(document.getElementById('misc-amt').value);
        travelTotals[k]+=m; updateSummaryUI(); alert('Entry added. Summary updated.');
      });
    });

    /* ===== Payment Requests (localStorage) ===== */
    const PR_KEY='paymentRequests', TWO_DAYS=2*24*60*60*1000;
    const loadPR=()=>{try{return JSON.parse(localStorage.getItem(PR_KEY)||'[]')}catch{return[]}};
    const savePR=(a)=>localStorage.setItem(PR_KEY,JSON.stringify(a));
    function addPaymentRequest({date, amount, claimNo}){
      const arr=loadPR(); const now=Date.now();
      arr.push({ id:'pr_'+now, date, amount, claimNo, createdAt:now,
        stages:{dept:{status:'Pending',updatedAt:now},finance:{status:'Pending',updatedAt:null},accountant:{status:'Pending',updatedAt:null}},
        currentStage:'dept' });
      savePR(arr);
    }
    function approveStagePR(item, stage, auto=false){
      item.stages[stage].status=auto?'Auto-approved':'Approved'; item.stages[stage].updatedAt=Date.now();
      const order=['dept','finance','accountant'], idx=order.indexOf(stage);
      if(idx<order.length-1){ const next=order[idx+1]; item.currentStage=next; if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now(); }
      else item.currentStage='done';
    }
    function applyAutoApprovalsPR(item){
      const order=['dept','finance','accountant'];
      for(const stg of order){
        const st=item.stages[stg];
        if(st.status==='Pending'){
          const base=st.updatedAt??item.createdAt;
          if(Date.now()-base>=TWO_DAYS){ approveStagePR(item, stg, true); continue; } else break;
        }
      }
      if(item.stages.dept.status==='Pending') item.currentStage='dept';
      else if(item.stages.finance.status==='Pending') item.currentStage='finance';
      else if(item.stages.accountant.status==='Pending') item.currentStage='accountant';
      else item.currentStage='done';
      return item;
    }
    function manualApprovePR(id){
      const arr=loadPR(); const it=arr.find(x=>x.id===id); if(!it) return;
      applyAutoApprovalsPR(it);
      if(it.currentStage==='done'){ savePR(arr); renderPaymentTable(); renderPendingPRTable(); return; }
      approveStagePR(it, it.currentStage, false); savePR(arr); renderPaymentTable(); renderPendingPRTable();
    }
    function stageCellPR(item, stage){
      const st=item.stages[stage], isActive=item.currentStage===stage, statusText=st.status;
      let cls='s-pending'; if(statusText==='Approved') cls='s-approved'; else if(statusText==='Auto-approved') cls='s-auto';
      const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '—';
      const btn = isActive ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApprovePR('${item.id}')">Approve</button>` : '';
      return `<span class="${cls}">${statusText}</span>${btn}<span class="muted">Updated: ${updated}</span>`;
    }
    function renderPaymentTable(){
      let arr=loadPR(); const tbody=document.getElementById('paymentTbody'); if(!tbody) return;
      if(arr.length===0){ tbody.innerHTML='<tr class="empty"><td colspan="7">No payment requests yet.</td></tr>'; return; }
      arr=arr.map(applyAutoApprovalsPR); savePR(arr); tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const num=parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmt=num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td><td>${fmt}</td>
                      <td>${stageCellPR(item,'dept')}</td><td>${stageCellPR(item,'finance')}</td><td>${stageCellPR(item,'accountant')}</td>`;
        tbody.appendChild(tr);
      });
    }
    function renderPendingPRTable(){
      const tbody=document.getElementById('pendingPRTbody'); if(!tbody) return;
      let arr=loadPR().map(applyAutoApprovalsPR).filter(x=>x.currentStage==='dept' && x.stages.dept.status==='Pending');
      if(arr.length===0){ tbody.innerHTML='<tr class="empty"><td colspan="5">Nothing pending.</td></tr>'; return; }
      tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const amt=parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmt=amt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td><td>${fmt}</td>
          <td><button class="btn-secondary" style="padding:4px 8px" onclick="manualApprovePR('${item.id}')">Approve</button></td>`;
        tbody.appendChild(tr);
      });
    }

    /* ===== Vouchers (localStorage) ===== */
    const V_KEY='vouchers';
    const loadV=()=>{try{return JSON.parse(localStorage.getItem(V_KEY)||'[]')}catch{return[]}};
    const saveV=(a)=>localStorage.setItem(V_KEY,JSON.stringify(a));
    const sessionFileURLs={};

    function addVoucher(v){
      const arr=loadV(); const now=Date.now();
      arr.push({
        id:'v_'+now, createdAt:now, currentStage:'accountant',
        stages:{accountant:{status:'Pending',updatedAt:now},dept:{status:'Pending',updatedAt:null},finance:{status:'Pending',updatedAt:null}},
        ...v
      });
      saveV(arr);
    }
    function approveStageV(item, stage){
      item.stages[stage].status='Approved'; item.stages[stage].updatedAt=Date.now();
      const order=['accountant','dept','finance'], idx=order.indexOf(stage);
      if(idx<order.length-1){ const next=order[idx+1]; item.currentStage=next; if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now(); }
      else item.currentStage='done';
    }
    function manualApproveVoucher(id){
      const arr=loadV(); const it=arr.find(x=>x.id===id); if(!it) return;
      if(it.currentStage!=='dept'){ alert('Only Department Head can approve at this stage.'); return; }
      approveStageV(it,'dept'); saveV(arr); renderVoucherTable(); renderPendingVTable();
    }
    function stageCellVoucher(item, stage){
      const st=item.stages[stage]; const isDeptStage = stage==='dept' && item.currentStage==='dept';
      const statusText=st.status; let cls='s-pending'; if(statusText==='Approved') cls='s-approved';
      const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '—';
      const btn = isDeptStage ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApproveVoucher('${item.id}')">Approve</button>` : '';
      return `<span class="${cls}">${statusText}</span>${btn}<span class="muted">Updated: ${updated}</span>`;
    }
    function renderVoucherTable(){
      const tbody=document.getElementById('voucherTbody'); if(!tbody) return;
      let arr=loadV(); if(arr.length===0){ tbody.innerHTML='<tr class="empty"><td colspan="7">No vouchers yet.</td></tr>'; return; }
      tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const num=parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmt=num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td><td>${fmt}</td>
                      <td>${stageCellVoucher(item,'accountant')}</td>
                      <td>${stageCellVoucher(item,'dept')}</td>
                      <td>${stageCellVoucher(item,'finance')}</td>`;
        tbody.appendChild(tr);
      });
    }
    function renderPendingVTable(){
      const tbody=document.getElementById('pendingVTbody'); if(!tbody) return;
      let arr=loadV().filter(x=>x.currentStage==='dept' && x.stages.dept.status==='Pending');
      if(arr.length===0){ tbody.innerHTML='<tr class="empty"><td colspan="5">Nothing pending.</td></tr>'; return; }
      tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const amt=parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmt=amt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td><td>${fmt}</td>
          <td><button class="btn-secondary" style="padding:4px 8px" onclick="manualApproveVoucher('${item.id}')">Approve</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function fileInfoFromInput(inputEl, key){
      const out=[]; if(!inputEl || !inputEl.files) return out;
      for(const f of inputEl.files){ const url=URL.createObjectURL(f); out.push({name:f.name, urlKey:key}); sessionFileURLs[key]=(sessionFileURLs[key]||[]); sessionFileURLs[key].push(url); }
      return out;
    }

    // Wire voucher forms
    function wireVoucherFormPurchase(){
      const f=document.getElementById('purchaseForm'); if(!f) return; updateClaimPreview(f);
      f.addEventListener('submit',(e)=>{
        e.preventDefault();
        const seq=commitSeq('P'); const claim=formatClaim('P',seq);
        f.querySelector('.claim').value=claim; f.querySelector('.claim-text').textContent=claim;
        const files=fileInfoFromInput(document.getElementById('pv-file'), claim+'-pv');
        addVoucher({
          type:'purchase',
          date:document.getElementById('pv-date').value,
          amount:document.getElementById('pv-amt').value,
          workorder:document.getElementById('pv-wo').value,
          remarks:document.getElementById('pv-remarks').value,
          claimNo:claim, files
        });
        alert(`Purchase voucher submitted!\nClaim No: ${claim}`);
        f.reset(); setTimeout(()=>updateClaimPreview(f),0);
      });
    }
    function wireVoucherFormTravel(){
      const f=document.getElementById('travelForm'); if(!f) return; updateClaimPreview(f);
      f.addEventListener('submit',(e)=>{
        e.preventDefault();
        const seq=commitSeq('T'); const claim=formatClaim('T',seq);
        f.querySelector('.claim').value=claim; f.querySelector('.claim-text').textContent=claim;
        const total=(travelTotals.fare+travelTotals.local+travelTotals.hotel+travelTotals.da+travelTotals.misc).toFixed(2);
        const files=[
          ...fileInfoFromInput(document.getElementById('fare-file'), claim+'-fare'),
          ...fileInfoFromInput(document.getElementById('hotel-file'), claim+'-hotel'),
          ...fileInfoFromInput(document.getElementById('misc-file'), claim+'-misc')
        ];
        addVoucher({
          type:'travel',
          date:document.getElementById('tv-date').value,
          amount:String(total),
          workorder:document.getElementById('tv-wo').value,
          remarks:'',
          claimNo:claim, files
        });
        alert(`Travel voucher submitted!\nClaim No: ${claim}`);
        f.reset(); setTimeout(()=>{ updateClaimPreview(f); clearTravelTotals(); },0);
      });
    }
    function wireVoucherFormOthers(){
      const f=document.getElementById('othersForm'); if(!f) return; updateClaimPreview(f);
      f.addEventListener('submit',(e)=>{
        e.preventDefault();
        const seq=commitSeq('O'); const claim=formatClaim('O',seq);
        f.querySelector('.claim').value=claim; f.querySelector('.claim-text').textContent=claim;
        const files=fileInfoFromInput(document.getElementById('ov-file'), claim+'-ov');
        addVoucher({
          type:'others',
          date:document.getElementById('ov-date').value,
          amount:document.getElementById('ov-amt').value,
          workorder:document.getElementById('ov-wo').value,
          remarks:document.getElementById('ov-remarks').value,
          claimNo:claim, files
        });
        alert(`Other voucher submitted!\nClaim No: ${claim}`);
        f.reset(); setTimeout(()=>updateClaimPreview(f),0);
      });
    }
    wireVoucherFormPurchase();
    wireVoucherFormTravel();
    wireVoucherFormOthers();

    /* Cash voucher items & save */
    (function initCashForm(){
      const f = document.getElementById('cashForm'); if(!f) return;
      updateClaimPreview(f);
      f._items = [];
      const dateEl = document.getElementById('cash-date');
      const partEl = document.getElementById('cash-particulars');
      const headEl = document.getElementById('cash-head');
      const amtEl  = document.getElementById('cash-amount');
      const tbody  = document.getElementById('cashItemsBody');
      const totalEl= document.getElementById('cashTotal');
      const hidden = document.getElementById('cashTotalInput');

      (function sortHeadOptionsByLength(){
        const all = Array.from(headEl.querySelectorAll('option'));
        const placeholder = all.find(o => o.disabled || o.value==='');
        const opts = all.filter(o => o !== placeholder);
        opts.sort((a,b) => {
          const la = a.textContent.trim().length;
          const lb = b.textContent.trim().length;
          if (la !== lb) return la - lb;
          return a.textContent.localeCompare(b.textContent);
        });
        headEl.innerHTML = ''; if (placeholder) headEl.appendChild(placeholder); opts.forEach(o => headEl.appendChild(o)); headEl.value='';
      })();

      function render(){
        if(!f._items.length){
          tbody.innerHTML = `<tr><td colspan="4" class="muted">No items added.</td></tr>`;
        }else{
          tbody.innerHTML = f._items.map(it => `
            <tr>
              <td>${it.date}</td>
              <td>${it.part}</td>
              <td>${it.head}</td>
              <td class="right">${it.amount.toFixed(2)}</td>
            </tr>
          `).join('');
        }
        const sum = f._items.reduce((s,i)=> s + i.amount, 0);
        totalEl.textContent = sum.toFixed(2);
        hidden.value = sum.toFixed(2);
      }
      tbody.addEventListener('beforeinput', e => e.preventDefault());
      tbody.addEventListener('keydown', e => {
        if (!['Tab','Shift','ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) e.preventDefault();
      });

      function addCurrentIfValid(){
        const d    = dateEl.value;
        const part = (partEl.value || '').trim();
        const head = headEl.value || '';
        const amt  = parseFloat(amtEl.value || '0');
        if(!d || !part || !head || !(amt > 0)) return false;
        f._items.push({ date: d, part, head, amount: amt });
        render(); return true;
      }
      function addVoucherFromCash(){
        const seq=commitSeq('C'); const claim=formatClaim('C', seq);
        const total = parseFloat(hidden.value || '0') || 0;
        addVoucher({ type:'cash', date: dateEl.value || '', amount: String(total), workorder:'', remarks:partEl.value||'', claimNo:claim, files:[] });
        alert(`Cash voucher submitted!\nClaim No: ${claim}`);
      }
      render();
      f.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(f._items.length === 0){ addCurrentIfValid(); }
        render(); addVoucherFromCash(); f.reset(); f._items = []; render();
      });
    })();

    /* Reports */
    function linkForFiles(files){
      if(!files || files.length===0) return '';
      return files.map((f,i)=>{
        const urls=sessionFileURLs[f.urlKey]||[];
        const u=urls[i]||''; return u? `<a href="${u}" target="_blank">${f.name}</a>` : f.name;
      }).join(', ');
    }
    function renderReports(){
      const rows=loadV();
      const byType={purchase:[],travel:[],cash:[],others:[]};
      rows.forEach(r=>{ if(byType[r.type]) byType[r.type].push(r); });
      function fill(tid, arr){
        const tb=document.getElementById(tid); if(!tb) return;
        if(arr.length===0){ tb.innerHTML='<tr class="empty"><td colspan="6">No data.</td></tr>'; return; }
        tb.innerHTML='';
        arr.forEach(r=>{
          const num=parseFloat((r.amount+'').replace(/[^0-9.]/g,''))||0;
          const fmt=num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.date||''}</td><td>${r.claimNo||''}</td><td>${fmt}</td><td>${r.workorder||''}</td><td>${linkForFiles(r.files)}</td><td>${r.remarks||''}</td>`;
          tb.appendChild(tr);
        });
      }
      fill('rpt-purchase-body', byType.purchase);
      fill('rpt-travel-body', byType.travel);
      fill('rpt-cash-body', byType.cash);
      fill('rpt-others-body', byType.others);
    }

    /* Workorder report bits (for rpt-wo) — minimal store for now */
    const WO_KEY='workorders';
    const loadWO=()=>{try{return JSON.parse(localStorage.getItem(WO_KEY)||'[]')}catch{return[]}};
    const saveWO=(a)=>localStorage.setItem(WO_KEY,JSON.stringify(a));
    function renderWOReport(){
      const arr=loadWO(); const filterEl=document.getElementById('woFilter'); const tb=document.getElementById('rpt-wo-body'); const titleEl=document.getElementById('woTitle'); const rangeEl=document.getElementById('woRange');
      if(!filterEl||!tb) return;
      if(!arr.length){ filterEl.innerHTML=''; titleEl.textContent='Workorder No: —'; rangeEl.textContent='From — To —'; tb.innerHTML='<tr class="empty"><td colspan="6">No entries yet.</td></tr>'; return; }
      const groups={}; for(const r of arr){ const key=r.wo||'(blank)'; (groups[key]||(groups[key]=[])).push(r); }
      const woList=Object.keys(groups).sort(); const selected = (window._woSelected && groups[window._woSelected]) ? window._woSelected : woList[0]; window._woSelected = selected;
      filterEl.innerHTML = woList.map(wo=>`<option value="${wo}" ${wo===selected?'selected':''}>${wo}</option>`).join('');
      filterEl.onchange = () => { window._woSelected = filterEl.value; renderWOReport(); };
      const rows = (groups[selected]||[]).slice().sort((a,b)=>(a.date||'').localeCompare(b.date||'')); titleEl.textContent = 'Workorder No: ' + (selected||'—');
      if(rows.length){ const dates = rows.map(r=>r.date).filter(Boolean).sort(); rangeEl.textContent = `From ${dates[0]||'—'}  To ${dates[dates.length-1]||'—'}`; } else { rangeEl.textContent = 'From — To —'; }
      if(!rows.length){ tb.innerHTML='<tr class="empty"><td colspan="6">No entries yet.</td></tr>'; return; }
      tb.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date||''}</td><td>${r.desc||''}</td><td>${r.category||''}</td><td>${r.type||''}</td><td>${r.customer||''}</td><td>${r.status||''}</td>`; tb.appendChild(tr); });
    }

    /* Ledger sample rows for Download Ledger */
    const ledgerBody=document.getElementById('ledgerBody');
    function fmtInt(n){ const num=parseInt((n||0),10); return isNaN(num)?'0':num.toLocaleString(); }
    function renderLedgerRows(rows){
      if(!ledgerBody) return;
      ledgerBody.innerHTML=''; const max=10; let debitSum=0, creditSum=0;
      for(let i=0;i<max;i++){
        const r=rows[i]||{date:'',voucher:'',debit:'',credit:'',remarks:''};
        const d=parseInt(r.debit||0,10)||0; const c=parseInt(r.credit||0,10)||0; debitSum+=d; creditSum+=c;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${r.date||''}</td><td>${r.voucher||''}</td><td class="number">${r.debit?fmtInt(r.debit):''}</td><td class="number">${r.credit?fmtInt(r.credit):''}</td><td>${r.remarks||''}</td>`;
        ledgerBody.appendChild(tr);
      }
      document.getElementById('lb-debit').textContent=fmtInt(debitSum);
      document.getElementById('lb-credit').textContent=fmtInt(creditSum);
      document.getElementById('lt-debit').textContent=fmtInt(debitSum);
      document.getElementById('lt-credit').textContent=fmtInt(creditSum);
      document.getElementById('lt-balance').textContent=fmtInt(creditSum - debitSum);
    }
    function fillSampleLedger(){
      const rows=[
        {date:'30-06-2025', voucher:'OPENING BALANCE', debit:103941, credit:'', remarks:'TILL DATE C/F'},
        {date:'16-08-2025', voucher:'H-PV-001', debit:1500, credit:'', remarks:''},
        {date:'18-08-2025', voucher:'H-PR-008', debit:'', credit:5000, remarks:''},
      ];
      renderLedgerRows(rows);
    }

    // Preview claim stamps on load
    document.querySelectorAll('form[data-code]').forEach(updateClaimPreview);

    /* ===== Update Logins (localStorage per role) ===== */
    const UL_KEY='ul_roles_v1';
    function ulLoad(){
      try{ return JSON.parse(localStorage.getItem(UL_KEY)||'{}'); }catch{ return {}; }
    }
    function ulSave(obj){ localStorage.setItem(UL_KEY, JSON.stringify(obj)); }
    function ulAdd(role, rec){
      const store=ulLoad(); store[role]=store[role]||[]; store[role].push(rec); ulSave(store);
    }
    function ulList(role){
      const store=ulLoad(); return store[role]||[];
    }
    // submit handlers for all .ul-form
    document.querySelectorAll('.ul-form').forEach(form=>{
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const role = form.dataset.role;
        const inputs = form.querySelectorAll('input');
        const [name, username, password] = [inputs[0].value.trim(), inputs[1].value.trim(), inputs[2].value.trim()];
        if(!name || !username || !password){ alert('Please fill all fields'); return; }
        ulAdd(role, {name, username, password});
        alert('Saved!');
        form.reset();
      });
    });
    // render list tables when their page is shown
    function renderRoleTable(role){
      const tbody = document.querySelector(`[data-role-list="${role}"]`); if(!tbody) return;
      const rows = ulList(role);
      if(rows.length===0){ tbody.innerHTML = `<tr class="empty"><td colspan="3">No entries yet.</td></tr>`; return; }
      tbody.innerHTML = rows.map(r=>`<tr><td>${r.name}</td><td>${r.username}</td><td>${r.password}</td></tr>`).join('');
    }
    // hook page switching for role lists
    ['employee','manager','accountant','depthead','financehead'].forEach(role=>{
      const pageId = role==='employee'?'ul-emp-list'
                    : role==='manager'?'ul-mgr-list'
                    : role==='accountant'?'ul-acct-list'
                    : role==='depthead'?'ul-dept-list'
                    : 'ul-fin-list';
      document.getElementById(pageId)?.addEventListener('click',()=>renderRoleTable(role));
    });

    // Also render when the page becomes active via left menu
    const obs=new MutationObserver(()=>{
      const active=document.querySelector('.page.active');
      if(!active) return;
      const map={
        'ul-emp-list':'employee','ul-mgr-list':'manager','ul-acct-list':'accountant',
        'ul-dept-list':'depthead','ul-fin-list':'financehead'
      };
      const role = map[active.id];
      if(role) renderRoleTable(role);
    });
    obs.observe(document.querySelector('.content'),{subtree:true,attributes:true,attributeFilter:['class']});
  </script>
</body>
</html>
