<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Dashboard</title>
  {% load static %}
  <style>
    :root{
      --primary:#4CAF50; --primary-hover:#2e7d32; --pastel-dark:#81c784;
      --card-shadow:0 10px 26px rgba(0,0,0,.08); --muted:#6b7280; --text:#0f172a;
      --nav:#0e1f17;
      --field-max: 360px;            /* NEW: narrow inputs like typical sites */
      --field-max-wide: 260px;       /* NEW: for table cells */
      --field-pad: 8px;              /* NEW: compact padding */
      --field-font: 13px;            /* NEW: compact font-size */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--pastel-dark);min-height:100vh;color:var(--text);}
    .logo-header{background:#000;padding:10px 18px;display:flex;align-items:center}
    .logo{height:35px;width:auto}

    /* NAVBAR */
    .topnav{display:flex;gap:16px;align-items:center;background:var(--nav);color:#d1fae5;padding:12px 20px;position:sticky;top:0;z-index:50;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .nav-title{font-weight:800;letter-spacing:.4px;margin-right:auto;color:#a7f3d0}
    .nav-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#e2e8f0;cursor:pointer;font-weight:700;transition:.18s}
    .nav-btn:hover,.nav-btn.active{background:#113f2e;border-color:#32d399;color:#d1fae5;transform:translateY(-1px)}
    .ic{font-size:18px}

    .container{background:#fff;margin:24px;border-radius:16px;box-shadow:var(--card-shadow);padding:22px}
    .content{min-height:64vh}
    .page{display:none}
    .page.active{display:block}
    .content-card{background:#fff;border:1px solid #e9eef4;border-radius:16px;box-shadow:var(--card-shadow);padding:20px}

    .btn,.btn-primary{display:inline-flex;justify-content:center;align-items:center;gap:8px;background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;transition:.18s;font-size:14px}
    .btn:hover,.btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px)}
    .btn-secondary{background:#e9ecef;color:#111;border:1px solid #d0d7de;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:13px}
    .btn-ghost{background:#e8f5e9;color:#256029;border:1px solid #c8e6c9;border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px}

    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}

    .table-wrap{overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin:12px 0}
    table.data{width:100%;border-collapse:collapse;font-size:14px}
    table.data th,table.data td{border:1px solid #e5e7eb;padding:8px;text-align:left}
    .muted{color:#6b7280;font-size:12px;display:block;margin-top:4px}

    .s-pending{color:#9a6700}.s-approved{color:#116329}.s-auto{color:#1b4b91}.s-rejected{color:#a40e26}

    /* Forms (COMPACT) */
    .form{background:#fff;border:1px solid #e9e9e9;border-radius:10px;padding:16px;position:relative}
    .form-row{margin-bottom:10px}
    .form-row label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    .form-row input[type="text"],
    .form-row input[type="number"],
    .form-row input[type="date"],
    .form-row input[type="datetime-local"],
    .form-row input[type="file"],
    .form-row textarea,
    .form-row select{
      width:min(100%, var(--field-max));
      padding:var(--field-pad);
      border:1px solid #888;border-radius:8px;font-size:var(--field-font);background:#fff
    }
    .form-row textarea{min-height:80px;resize:vertical}
    .form-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .claim-stamp{position:absolute;top:10px;right:12px;background:#f1f8e9;border:1px solid #cfe3c4;color:#1b5e20;padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px}

    /* Wizard (used inside modal) */
    .uv-wrap{background:#fff;border:1px solid #e5efe6;border-radius:14px;padding:16px;margin-top:12px}
    .uv-tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .uv-tab{background:#40a4d8;color:#fff;border:none;padding:8px 12px;border-radius:8px;opacity:.85;cursor:default;font-size:13px}
    .uv-tab.active{opacity:1;font-weight:700}
    .uv-panel.hidden{display:none}
    .uv-heading{margin:4px 0 8px 0}
    .uv-help{color:#6b7280;font-size:12px;margin:6px 0}
    .uv-filelist{margin-top:6px;font-size:12px}
    .uv-nav{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .uv-btn{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-size:13px}
    .uv-btn.primary{background:#40a4d8;color:#fff;border-color:#40a4d8}
    .uv-btn.primary:disabled{opacity:.5;cursor:not-allowed}

    /* Travel widgets (COMPACT widths) */
    .travel-title{text-align:center;font-weight:700;margin-bottom:8px}
    .travel-table{width:100%;border-collapse:collapse;margin-bottom:10px;table-layout:fixed}
    .travel-table th,.travel-table td{border:1px solid #444;padding:6px;vertical-align:middle}
    .travel-table input,.travel-table select{
      width:min(100%, var(--field-max-wide));
      padding:var(--field-pad);
      border:1px solid #888;border-radius:6px;background:#fff;font-size:var(--field-font)
    }
    .exp-card{background:#fff;border:1px solid #e3e3e3;border-radius:10px;padding:10px;margin:10px 0;display:none;position:relative}
    .exp-card.active{display:block}
    .exp-grid{display:grid;grid-template-columns:repeat(3, minmax(180px, 1fr));gap:10px}
    .exp-grid .cell{display:flex;flex-direction:column}
    .exp-grid .cell input,.exp-grid .cell select{width:min(100%, var(--field-max-wide)); font-size:var(--field-font); padding:var(--field-pad);}
    .summary-wrap{margin-top:10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff;overflow:hidden}
    .summary-head{background:#f1f8e9;padding:8px 10px;font-weight:800;border-bottom:1px solid #cfd8dc}
    .sum-table{width:100%;border-collapse:collapse}
    .sum-table th,.sum-table td{border:1px solid #e0e0e0;padding:8px}
    .sum-amount{text-align:right}
    .summary-total{font-size:16px;font-weight:bold;background:#f7f7f7}

    /* Ledger */
    #pg-ledger h2{text-align:center}
    .ledger-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .ledger-title{font-size:24px;letter-spacing:1px;font-weight:800}
    .ledger-total{border:1px solid #111;border-collapse:collapse}
    .ledger-total th,.ledger-total td{border:1px solid #111;padding:6px 10px}
    .ledger-box{border:1px solid #111;border-collapse:collapse;width:100%}
    .ledger-box th,.ledger-box td{border:1px solid #111;padding:8px}
    .ledger-actions{display:flex;gap:8px;margin:10px 0}
    .ledger-actions .btn-secondary{padding:8px 10px}
    .ledger-wrap{background:#fff;border:1px solid #111;padding:14px;border-radius:8px}
    .number{text-align:right}
    .print-note{color:#6b7280;font-size:12px;margin-top:8px}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-overlay.active{display:flex}
    /* Fit popups to their content with sensible caps */
    .modal{
      display:inline-block;               /* shrink-wrap to contents */
      width:auto;                         /* no forced width */
      max-width:92vw;                     /* cap on small screens */
      max-height:90vh;                    /* avoid viewport overflow */
      overflow:auto;                      /* scroll if needed */
      background:#fff;
      border-radius:16px;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      padding:16px;                       /* compact padding */
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-title{font-weight:800;font-size:20px}
    .modal-actions{display:flex;gap:8px}
    .modal-close{border:none;background:#f1f5f9;border-radius:10px;padding:8px 10px;cursor:pointer}
    .modal-back{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid #c8e6c9;background:#e8f5e9;color:#256029;font-weight:700;cursor:pointer}

    /* Dropdowns */
    .btn-group{position:relative;display:inline-flex;align-items:center}
    .caret{font-size:12px}
    .menu{position:absolute;top:100%;left:0;background:#fff;border:1px solid #d1d5db;border-radius:10px;box-shadow:var(--card-shadow);padding:6px;min-width:220px;display:none;z-index:20}
    .menu.open{display:block}
    .menu button{display:flex;width:100%;justify-content:flex-start;gap:8px;padding:10px 12px;background:#fff;border:none;border-radius:8px;cursor:pointer}
    .menu button:hover{background:#f3f4f6}

    /* ===== Mobile: keep desktop tables with horizontal scroll ===== */
    @media(max-width:700px){
      .container{margin:16px}
      .nav-title{display:none}
    }
  
    /* ---- Bootstrap-like container, pure CSS ---- */
    :root{ --container-padding-x: 12px; }
    .container-fluid{ width:100%; padding-right:var(--container-padding-x); padding-left:var(--container-padding-x); margin-right:auto; margin-left:auto; }
    /* Keep desktop layout on phones by allowing horizontal scroll */
    .container-fluid{ min-width:1200px; }
    html, body{ overflow-x:auto; }
  </style>

    <style>.bill-btn{border-radius:999px;padding:6px 12px;font-weight:600;min-width:86px}</style>
    
</head>
<body data-username="">
  <div class="logo-header">
    <img class="logo" src="{% static 'core/images/logo.png' %}" alt="Company Logo">
  </div>

  <!-- NAVBAR -->
  <nav class="topnav" aria-label="Primary">
    <div class="nav-title">Employee Dashboard</div>
    <button class="nav-btn" data-target="pg-voucher"><span class="ic">üßæ</span><span>Voucher</span></button>
    <button class="nav-btn" data-target="pg-validate"><span class="ic">‚úÖ</span><span>Validate Voucher</span></button>
    <button class="nav-btn" data-target="pg-payment"><span class="ic">üí∏</span><span>Payment Request</span></button>
    <button class="nav-btn" data-target="pg-ledger"><span class="ic">üìí</span><span>Ledger</span></button>
    <div class="btn-group" id="adminEditWrap" style="display:none;">
      <button class="nav-btn" id="btnAdminEdit"><span class="ic">‚úèÔ∏è</span><span>Edit</span></button>
      <div id="adminEditMenu" class="menu" role="menu" style="left:auto; right:0;">
        <button type="button" data-edit="wo">Work Order Add/Update</button>
        <button type="button" data-edit="emp">Employee Add/Update</button>
        <button type="button" data-edit="master">Update Master Travel/Transport</button>
      </div>
    </div>
    <button class="nav-btn" id="btnWorkOrder" style="display:none"><span class="ic">üìÑ</span><span>Add/Update Work Order</span></button>
  </nav>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        const res = await fetch('/api/auth/me/');
        const me = await res.json();
        const isAdmin = String(me?.designation||'').toLowerCase().includes('admin');
        const wrap = document.getElementById('adminEditWrap');
        const btn = document.getElementById('btnAdminEdit');
        const menu = document.getElementById('adminEditMenu');
        if(isAdmin && wrap && btn && menu){
          wrap.style.display = 'inline-flex';
          btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
          document.addEventListener('click', ()=> menu.classList.remove('open'));
          const click = (sel, fn)=>{ const el=menu.querySelector(sel); if(el) el.addEventListener('click', ()=>{ menu.classList.remove('open'); fn(); }); };
          click('[data-edit="wo"]', ()=> openWorkOrderEditor());
          click('[data-edit="emp"]', ()=> openEmployeeEditor());
          click('[data-edit="master"]', ()=> openMasterEditor());
        }
      }catch(_e){ /* silently ignore */ }
    });
  
  function byId(id){ return document.getElementById(id); }
</script>


  <!-- Work Order Overlay (Department Head only) -->
  <div id="workOrderOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="workOrderTitle">
      <div class="modal-head">
        <div class="modal-title" id="workOrderTitle">Add / Update Work Order</div>
        <div class="modal-actions"><button class="modal-close" type="button" onclick="closeWorkOrderOverlay()">Close ‚úï</button></div>
      </div>
      <form id="workOrderForm">
        <input type="hidden" id="wo_project_id" name="project_id" />
        <div class="form-row">
          <label for="wo_existing">Load Existing</label>
          <select id="wo_existing"><option value="">-- Select Work Order --</option></select>
        </div>
        <div class="form-row"><label for="wo_work_order_no">Work Order No</label>
          <input type="text" id="wo_work_order_no" name="work_order_no" required></div>
        <div class="form-row"><label for="wo_project_name">Project Name</label>
          <input type="text" id="wo_project_name" name="project_name" required></div>
        <div class="form-row"><label for="wo_client_name">Client Name</label>
          <input type="text" id="wo_client_name" name="client_name"></div>
        <div class="form-row"><label for="wo_project_type">Project Type</label>
          <input type="text" id="wo_project_type" name="project_type"></div>
        <div class="form-row"><label for="wo_place">Place</label>
          <input type="text" id="wo_place" name="place"></div>
        <div class="form-row"><label for="wo_address">Address</label>
          <textarea id="wo_address" name="address" rows="2" style="width:min(100%, var(--field-max));"></textarea></div>
        <div class="form-row"><label for="wo_dept_id">Department ID</label>
          <input type="number" id="wo_dept_id" name="dept_id"></div>
        <div class="form-row"><label for="wo_status">Status</label>
          <select id="wo_status" name="status">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
        <div class="form-actions" style="justify-content:flex-end">
          <button type="button" class="btn-secondary" onclick="closeWorkOrderOverlay()">Cancel</button>
          <button type="submit" class="btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Show button only for Department Head and wire actions
    (function(){
      async function setupDeptHeadUI(){
        try{
          const res = await fetch('/api/auth/me/');
          const j = await res.json().catch(()=>({}));
          const role = (j && j.designation ? String(j.designation) : '').toLowerCase();
          if(role.includes('department') && role.includes('head')){
            const btn = document.getElementById('btnWorkOrder');
            if(btn){
              btn.style.display = 'inline-flex';
              btn.addEventListener('click', openWorkOrderOverlay);
            }
          }
        }catch(_){ /* ignore */ }
      }
      window.openWorkOrderOverlay = function(){
        const ov = document.getElementById('workOrderOverlay');
        const form = document.getElementById('workOrderForm');
        if(form) form.reset();
        // Default status to Active on new entries
        const st = document.getElementById('wo_status'); if (st) st.value = 'Active';
        // Populate existing W.O list
        const sel = document.getElementById('wo_existing');
        if (sel) {
          sel.innerHTML = '<option value="">-- Select Work Order --</option>';
          fetch('/api/projects/', { headers: { 'Accept': 'application/json' } })
            .then(r => r.ok ? r.json() : [])
            .then(rows => {
              (rows||[]).forEach(it => {
                const o = document.createElement('option');
                o.value = it.work_order_no || '';
                o.textContent = it.project_name ? `${it.work_order_no} - ${it.project_name}` : (it.work_order_no || '');
                sel.appendChild(o);
              });
            }).catch(()=>{});
        }
        if(ov){ ov.classList.add('active'); ov.setAttribute('aria-hidden','false'); }
      };
      window.closeWorkOrderOverlay = function(){
        const ov = document.getElementById('workOrderOverlay');
        if(ov){ ov.classList.remove('active'); ov.setAttribute('aria-hidden','true'); }
      };
      const f = document.getElementById('workOrderForm');
      if(f){
        const sel = document.getElementById('wo_existing');
        if (sel) {
          sel.addEventListener('change', async function(){
            const wo = this.value;
            if (!wo) return;
            try{
              const r = await fetch(`/api/projects/details/${encodeURIComponent(wo)}/`);
              if(!r.ok) return;
              const d = await r.json();
              document.getElementById('wo_project_id').value = d.project_id || '';
              document.getElementById('wo_work_order_no').value = d.work_order_no || '';
              document.getElementById('wo_project_name').value = d.project_name || '';
              document.getElementById('wo_client_name').value = d.client_name || '';
              document.getElementById('wo_project_type').value = d.project_type || '';
              document.getElementById('wo_place').value = d.place || '';
              document.getElementById('wo_address').value = d.address || '';
              document.getElementById('wo_dept_id').value = d.dept_id || '';
              const st = (d.status||'').toString();
              document.getElementById('wo_status').value = (/active/i.test(st) ? 'Active' : 'Inactive');
            }catch(_){ /* ignore */ }
          });
        }
        f.addEventListener('submit', async function(e){
          e.preventDefault();
          const payload = {
            project_id: parseInt(document.getElementById('wo_project_id').value||'0',10) || undefined,
            work_order_no: (document.getElementById('wo_work_order_no').value||'').trim(),
            project_name:  (document.getElementById('wo_project_name').value||'').trim(),
            client_name:   (document.getElementById('wo_client_name').value||'').trim(),
            project_type:  (document.getElementById('wo_project_type').value||'').trim(),
            place:         (document.getElementById('wo_place').value||'').trim(),
            address:       (document.getElementById('wo_address').value||'').trim(),
            dept_id:       parseInt(document.getElementById('wo_dept_id').value||'0',10) || undefined,
            status:        (document.getElementById('wo_status').value||'').trim(),
          };
          if(!payload.work_order_no || !payload.project_name){
            alert('Work Order No and Project Name are required.');
            return;
          }
          try{
            const res = await fetch('/api/projects/upsert/', {
              method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            const j = await res.json().catch(()=>({}));
            if(!res.ok || j.ok===false) throw new Error(j.error || ('HTTP '+res.status));
            alert('Saved successfully. Project ID: ' + (j?.data?.project_id || ''));
            closeWorkOrderOverlay();
          }catch(err){ alert('Failed to save: ' + (err?.message||err)); }
        });
      }
      setupDeptHeadUI();
    })();
  
  function byId(id){ return document.getElementById(id); }
</script>

  <div class="container container-fluid">
    <section class="content">
      <!-- BLANK LANDING PAGE -->
      <div id="pg-blank" class="page active">
        <div class="content-card container-fluid">
          <h2>Welcome</h2>
          <p class="muted">Choose a section from the top navigation (Voucher, Payment Request, or Ledger) to get started.</p>
        </div>
      </div>

      <!-- VOUCHER LIST PAGE -->
      <div id="pg-voucher" class="page">
        <div class="content-card">
          <div class="top-actions">
            <button class="btn-ghost" data-home>‚Üê Back to Home</button>
            <h2 style="margin:0">Vouchers</h2>
          </div>
          <div class="actions" style="margin-top:4px;display:flex;gap:10px;align-items:center;position:relative">
            <div class="btn-group">
              <button id="btnVoucherDropdown" class="btn">Ôºã Add New Voucher <span class="caret">‚ñæ</span></button>
              <div id="voucherMenu" class="menu" role="menu" aria-label="Add Voucher Menu">
                <button type="button" data-type="purchase">Purchase</button>
                <button type="button" data-type="travel">Travel</button>
                <button type="button" data-type="cash">Expense</button></div>
            </div>
          </div>
          <div class="table-wrap">
            <table class="data" id="voucherTable">
              <thead>
                <tr>
                  <th style="width:50px;">SL</th>
                  <th style="width:120px;">Date</th>
                  <th>Claim No</th>
                  <th style="width:120px;">Amount</th>
                  <th style="width:90px;">Bill</th>
                  <th>Manager</th><th>Remarks</th>
                  <th>Department Head</th><th>Remarks</th>
                  <th>Accountant</th><th>Remarks</th>
                  <th>Finance Head</th><th>Remarks</th>
                  <th>Action</th>
</tr>
              </thead>
              <tbody id="voucherTbody"><tr class="empty"><td colspan="14">No vouchers yet.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PAYMENT LIST PAGE -->
      <div id="pg-payment" class="page">
        <div class="content-card">
          <div class="top-actions">
            <button class="btn-ghost" data-home>‚Üê Back to Home</button>
            <h2 style="margin:0">Payment Requests</h2>
          </div>
          <div class="actions" style="margin-top:4px;display:flex;gap:10px;align-items:center;position:relative">
            <div class="btn-group">
              <button id="btnPRDropdown" class="btn">Ôºã New Request <span class="caret">‚ñæ</span></button>
              <div id="prMenu" class="menu" role="menu" aria-label="New Payment Request Menu">
                <button type="button" data-prtype="Advance">Advance</button>
                <button type="button" data-prtype="Purchase">Purchase</button>
                <button type="button" data-prtype="Settlement">Settlement</button>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table class="data" id="paymentTable">
              <thead>
                <tr>
                  <th style="width:50px;">SL</th>
                  <th style="width:120px;">Date</th>
                  <th>Claim No</th>
                  <th style="width:120px;">Amount</th>
                  <th style="width:90px;">Bill</th>
                  <th>Manager</th><th>Remarks</th>
                  <th>Department Head</th><th>Remarks</th>
                  <th>Accountant</th><th>Remarks</th>
                  <th>Finance Head</th><th>Remarks</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="paymentTbody">
                <tr class="empty"><td colspan="13">No payment requests yet.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="table-wrap" style="margin-top:14px;">
            <h3>Awaiting My Approval</h3>
            <table class="data" id="paymentApproveTable">
              <thead>
                <tr>
                  <th style="width:50px;">SL</th>
                  <th>Request</th>
                  <th>Purpose</th>
                  <th style="width:120px;">Amount</th>
                  <th>Submitted By</th>
                  <th style="width:220px;">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty"><td colspan="6">Nothing pending for you.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- LEDGER PAGE -->
      <div id="pg-ledger" class="page">
        <div class="content-card">
          <div class="top-actions">
            <button class="btn-ghost" data-home>‚Üê Back to Home</button>
            <h2 style="margin:0">Download Ledger</h2>
          </div>
          <div class="ledger-actions"><button class="btn-secondary" onclick="window.print()">Print / Download</button></div>
          <div class="ledger-wrap" id="ledgerArea">
            <div class="ledger-top">
              <div class="ledger-title">
                <input id="ledgerName" value="HANUMANTHA" style="font:inherit;font-weight:800;border:none;border-bottom:1px solid #111;outline:0;width:100%;max-width:360px"/>
              </div>
              <table class="ledger-total">
                <tr><th>TOTAL</th><th>CREDIT</th><td id="lt-credit" class="number">0</td></tr>
                <tr><td></td><th>DEBIT</th><td id="lt-debit" class="number">0</td></tr>
                <tr><td></td><th>BALANCE</th><td id="lt-balance" class="number">0</td></tr>
              </table>
            </div>
            <table class="ledger-box" id="ledgerTable">
              <thead><tr><th style="width:60px;">SL NO.</th><th style="width:140px;">DATE</th><th>VOUCHER NO</th><th style="width:140px;">DEBIT</th><th style="width:140px;">CREDIT</th><th>REMARKS</th></tr></thead>
              <tbody id="ledgerBody"></tbody>
              <tfoot><tr><th colspan="3" style="text-align:right">TOTAL</th><th id="lb-debit" class="number">0</th><th id="lb-credit" class="number">0</th><th></th></tr></tfoot>
            </table>
            <div class="print-note">Tip: Use the Print button above to save as PDF.</div>
          </div>
        </div>
      </div>

      <!-- VALIDATE VOUCHER PAGE -->
      <div id="pg-validate" class="page">
        <div class="content-card">
          <div class="top-actions">
            <button class="btn-ghost" data-home>‚Üê Back to Home</button>
            <h2 style="margin:0">Validate Voucher</h2>
            <div class="summary" id="summary" style="margin-left:auto;">
              Approved: 0 | Deemed Approve: 0 | Rejected: 0
            </div>
          </div>
          <div class="table-wrap">
            <table class="data" id="approveTable">
              <thead>
                <tr>
                  <th>Sl.No</th>
                  <th>Employee Name</th>
                  <th>Submitted Date</th>
                  <th>Voucher No</th>
                  <th>Voucher Type</th><th>Work Order</th>
                  <th>Total Amount</th>
                  <th>Voucher Details</th>
                  <th>Action</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Details Modal -->
      <div id="detailsModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <button class="modal-back" onclick="closeOverlay('detailsModal')">‚Üê Back</button>
      <div class="modal-title">Voucher Details</div>
      <div class="modal-actions" id="detailsActions"></div>
      <div class="modal-actions">
        <button class="modal-close" onclick="closeOverlay('detailsModal')">‚úï</button>
      </div>
    </div>
    <div id="detailsContent">
      <!-- Filled dynamically -->
      <div class="uv-help">Loading details‚Ä¶</div>
    </div>
    <div id="decisionControls" class="uv-nav" style="justify-content:flex-start; gap:12px; margin-top:12px;">
      <label><input type="radio" name="decision" value="approve"> Approve</label>
      <label style="margin-left:12px;"><input type="radio" name="decision" value="reject"> Reject</label>
      <button id="decisionSubmitBtn" class="uv-btn primary" onclick="submitDecision()">Submit</button>
    </div>
  </div>
</div>

      <!-- Reject Modal -->
      <div id="rejectModal" class="modal-overlay">
        <div class="modal">
          <h3>Remarks (Min 50 characters)</h3>
          <textarea id="rejectRemarks" rows="4" cols="50"></textarea><br><br>
          <button onclick="confirmReject()">Submit</button>
          <button onclick="closeOverlay('rejectModal')">Cancel</button>
        </div>
      </div>

    </section>
  </div>

  <!-- MODAL ROOT -->
  <div id="app-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-head">
        <button class="modal-back" id="modalBackBtn">‚Üê Back</button>
        <div class="modal-title" id="modal-title">New</div>
        <div class="modal-actions">
          <button class="modal-close" id="modalCloseBtn">‚úï</button>
        </div>
      </div>
      <div id="modal-body"><!-- dynamic --></div>
    </div>
  </div>

  <!-- HIDDEN SOURCE FORMS (for cloning into modal) -->
  <div style="display:none">
    <!-- Purchase (DATE locked, BILL DATE limited to last 2 days, unit_rate) -->
    <div id="page-purchase-form">
      <div class="content-card">
        <form class="form" id="purchaseForm" data-code="P">
<div class="claim-stamp">Claim Number: <span class="claim-text">‚Äî</span></div>
          <input type="hidden" class="claim" />

          <div class="form-row"><label>Date</label><input id="pv-date" type="date" name="date" required /></div>
          <div class="form-row"><label>Bill Date</label><input id="pv-billdate" type="date" name="bill_date" required /></div>

          <div class="form-row">
            <label>Work Order</label>
            <select id="work_order_no" name="work_order_no">
              <option value="">Loading work orders‚Ä¶</option>
            </select>
          </div>

          <div class="form-row">
            <label>Total Amount (‚Çπ)</label>
            <input type="number" id="pv-total" name="total_amount" step="0.01" min="0" placeholder="0.00" required />
          </div>

          <div class="form-row">
            <label>Description</label>
            <textarea id="pv-description" name="description" rows="3" placeholder="Short summary of this purchase"></textarea>
          </div>

          <div class="form-row">
            <label>Upload Bill</label>
            <input type="file" id="pv-billfile" name="bill" accept=".pdf,.jpg,.jpeg,.png,.webp" />
            <small class="muted">Accepted: PDF/JPG/PNG/WEBP</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>
</form>
      </div>
    </div>

    <!-- Travel (no Purchased Items tab) -->
    <div id="page-travel-form">
      <div class="content-card">
        <form class="form" id="travelForm" data-code="T">
          <div class="claim-stamp">Claim No: <span class="claim-text">‚Äî</span></div>
          <input type="hidden" class="claim" />
          <div class="travel-title">TRAVELING ALLOWANCE</div>
          <table class="travel-table">
            <tr><td><b>Project Name / W.O # :</b><select id="tv-wo" type="text" required></select></td><td><b>Date :</b><input id="tv-date" type="date" required></td></tr>
            <tr><td><b>Customer :</b><input id="tv-customer" type="text" required></td><td><b>Name :</b><input id="tv-name" type="text" required></td></tr>
            <tr><td><b>Designation :</b><input id="tv-desig" type="text" required></td><td><b>Place of Visit :</b><input id="tv-place" type="text" required></td></tr>
            <tr>
              <td>
                <b>Purpose of Journey :</b>
                <input id="tv-purpose" type="text" required>
                
              </td>
              <td>
                <b>Visit Authorised By :</b>
                <select id="tv-auth" type="text">
                  <option value="">-- Select --</option>
                </select>
              </td>
            </tr>
            <tr><td><b>From (Date) :</b><input id="tv-from" type="date" required></td><td><b>To (Date) :</b><input id="tv-to" type="date" required></td></tr>
          </table>
          <div class="form-actions" style="margin-top:12px;">
            
            <button type="reset" class="btn-secondary">Reset All</button>
          </div>
          
<div class="actions" id="travel-expense-switches" style="margin:8px 0 2px;">
  <div role="radiogroup" aria-label="Expense Sections" style="display:flex;gap:12px;flex-wrap:wrap;">
    <label class="btn-secondary" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;">
      <input type="radio" name="expTab" value="fare"> Travel Fare
    </label>
    <label class="btn-secondary" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;">
      <input type="radio" name="expTab" value="local"> Local Travel
    </label>
    <label class="btn-secondary" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;">
      <input type="radio" name="expTab" value="hotel"> Hotel Accommodation
    </label>
    <label class="btn-secondary" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;">
      <input type="radio" name="expTab" value="da"> Daily & Food Allowance
    </label>
    <label class="btn-secondary" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;">
      <input type="radio" name="expTab" value="misc"> Miscellaneous Expenses
    </label>
  </div>
</div>

          <div class="exp-card" id="card-fare">
<div class="table-wrap" style="margin-top:8px;">
  
</div>

            <div class="claim-stamp">Claim No: <span class="claim-text-inline">‚Äî</span></div>
            <h3>(A) Travel Fare</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Place</label><input type="text" id="fare-from"></div>
              <div class="cell"><label>To Place</label><input type="text" id="fare-to"></div>
              <div class="cell"><label>Departure (Date/Time)</label><input type="datetime-local" step="1" id="fare-dep"></div>
              <div class="cell"><label>Arrival (Date/Time)</label><input type="datetime-local" step="1" id="fare-arr"></div>
              <div class="cell"><label>Mode Of Transport</label><select id="fare-mode"><option value="" selected disabled>-- Select Mode --</option><option>Bus</option><option>Flight</option><option>Train</option><option>Bike</option><option>Car</option></select></div><div class="cell"><label>KM</label><input type="number" step="0.01" min="0" id="fare-km" disabled></div>
              <div class="cell"><label>Amount</label><input type="number" step="0.01" min="0" id="fare-amt"></div>
              
              <div class="cell"><label>Upload Bill</label><input type="file" id="fare-file" accept=".pdf,.jpg,.jpeg,.png" multiple required></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="fare">Add Entry</button>
              
              <button type="button" class="btn-secondary" data-reset-section="fare">Reset</button>
            </div>
          </div>
          <div class="exp-card" id="card-local">
<div class="table-wrap" style="margin-top:8px;">
  
</div>

            <div class="claim-stamp">Claim No: <span class="claim-text-inline">‚Äî</span></div>
            <h3>(B) Local Travel</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="local-date"></div>
              <div class="cell"><label>From</label><input type="text" id="local-from"></div>
              <div class="cell"><label>To</label><input type="text" id="local-to"></div>
              <div class="cell"><label>Mode Of Transport</label><select id="local-mode"><option value="" selected disabled>-- Select Mode --</option><option>Auto</option><option>Taxi</option><option>Bus</option><option>Bike</option><option>Car</option><option>Metro</option></select></div><div class="cell"><label>KM</label><input type="number" step="0.01" min="0" id="local-km" disabled></div><div class="cell"><label>Amount</label><input type="number" step="0.01" min="0" id="local-amt"></div>
              <div class="cell"><label>Upload File</label><input type="file" id="local-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="local">Add Entry</button>
              
              <button type="button" class="btn-secondary" data-reset-section="local">Reset</button>
            </div>
          </div>
          <div class="exp-card" id="card-hotel">
<div class="table-wrap" style="margin-top:8px;">
  
</div>

            <div class="claim-stamp">Claim No: <span class="claim-text-inline">‚Äî</span></div>
            <h3>(C) Hotel Accommodation</h3>
            <div class="exp-grid">
              <div class="cell"><label>Check-in Date/Time</label><input type="datetime-local" step="1" id="hotel-checkin"></div>
              <div class="cell"><label>Check-Out Date/Time</label><input type="datetime-local" step="1" id="hotel-checkout"></div>
              <div class="cell"><label>Hotel Name & Place</label><input type="text" id="hotel-name"></div>
              <div class="cell"><label>Amount</label><input type="number" step="0.01" min="0" id="hotel-amt"></div>
              <div class="cell"><label>Address</label><input type="text" id="hotel-address" placeholder="Hotel full address"></div>
              <div class="cell"><label>Upload Invoice</label><input type="file" id="hotel-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="hotel">Add Entry</button>
              
              <button type="button" class="btn-secondary" data-reset-section="hotel">Reset</button>
            </div>
          </div>
          <div class="exp-card" id="card-da">
<div class="table-wrap" style="margin-top:8px;">
  
</div>

            <div class="claim-stamp">Claim No: <span class="claim-text-inline">‚Äî</span></div>
            <h3>(D) Daily & Food Allowance</h3>
            <div class="exp-grid">
              <div class="cell"><label>From Date (DD-MM-YYYY)</label><input type="date" id="da-from"></div>
              <div class="cell"><label>To Date (DD-MM-YYYY)</label><input type="date" id="da-to"></div>
              <div class="cell"><label>No of Days</label><input type="number" step="0.01" min="0" id="da-days" readonly></div>
              
              
              
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="da">Add Entry</button>
              
              <button type="button" class="btn-secondary" data-reset-section="da">Reset</button>
            </div>
          </div>
          <div class="exp-card" id="card-misc">
<div class="table-wrap" style="margin-top:8px;">
  
</div>

            <div class="claim-stamp">Claim No: <span class="claim-text-inline">‚Äî</span></div>
            <h3>(E) Miscellaneous Expenses</h3>
            <div class="exp-grid">
              <div class="cell"><label>Date</label><input type="date" id="misc-date"></div>
              <div class="cell"><label>Particulars</label><select id="misc-particulars"><option value="" selected disabled>-- Select --</option><option>Food</option><option>Snacks</option><option>Parking</option><option>Toll</option><option>Stationery</option><option>Other</option></select></div>
              <div class="cell"><label>Amount</label><input type="number" step="0.01" min="0" id="misc-amt"></div>
              
              <div class="cell"><label>Upload Bill</label><input type="file" id="misc-file" accept=".pdf,.jpg,.jpeg,.png" multiple></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" data-addentry="misc">Add Entry</button>
              
              <button type="button" class="btn-secondary" data-reset-section="misc">Reset</button>
            </div>
          </div>
          <div class="summary-wrap">
            <div class="summary-head">Summary</div>
            <table class="sum-table" id="summaryTable">
              <thead><tr><th style="width:70px;">Sl No</th><th>Main Contents</th><th style="width:140px;">Amount Claimed</th><th style="width:180px;">Remarks</th></tr></thead>
              <tbody>
                <tr><td>A</td><td>Travel Fare</td><td class="sum-amount" id="sum-fare">0.00</td><td></td></tr>
                <tr><td>B</td><td>Local Travel</td><td class="sum-amount" id="sum-local">0.00</td><td></td></tr>
                <tr><td>C</td><td>Hotel Accommodation</td><td class="sum-amount" id="sum-hotel">0.00</td><td></td></tr>
                <tr><td>D</td><td>Daily Allowance & Food Allowance</td><td class="sum-amount" id="sum-da">0.00</td><td></td></tr>
                <tr><td>E</td><td>Miscellaneous Expenses</td><td class="sum-amount" id="sum-misc">0.00</td><td></td></tr>
              </tbody>
              <tfoot><tr class="summary-total"><th colspan="2" style="text-align:right;">Total Amount</th><th class="sum-amount" id="sum-total">0.00</th><th></th></tr></tfoot>
            </table>
          </div>
        </form>
      </div>
    </div>

    <!-- Expanse (former Cash) -->
    
    <div id="page-cash-form">
      <div class="content-card">
        <h3 class="uv-heading">Expense Voucher Details</h3>
        <form class="form" id="cashForm" data-code="C">
          <!-- Upload Date: locks to today -->
          <div class="form-row"><label>Upload Date</label>
            <input id="cash-upload-date" type="date" value="2025-09-10" disabled required />
            <small class="muted">Auto-set to today</small>
          </div>

          <!-- Expense Date: only Today, Yesterday, Day-before -->
          <div class="form-row"><label>Expense Date</label>
            <select id="cash-exp-date" required></select>
          </div>

          <!-- Work Order dropdown -->
          <div class="form-row">
            <label>Work Order No</label>
            <select id="cash-wo">
              <option value="">Loading work orders‚Ä¶</option>
            </select>
          </div>

          <!-- Particulars: text input replacing dropdown -->
          <div class="form-row">
            <label>Particulars</label>
            <input id="cash-particulars" type="text" placeholder="Enter particulars" required />
          </div>

          <!-- Amount -->
          <div class="form-row"><label>Amount (‚Çπ)</label>
            <input id="cash-amount" type="number" step="0.01" min="0" placeholder="0.00" required />
          </div>

          <!-- Upload Bill inside Details (single file applies to this entry) -->
          <div class="form-row">
            <label>Upload Bill (PDF/JPG/PNG)</label>
            <input id="cash-bill" type="file" accept=".pdf,.jpg,.jpeg,.png" />
          </div>

          <!-- Remarks: min 50 chars -->
          <div class="form-row">
            <label>Remarks</label>
            <textarea id="cash-remarks" minlength="50" placeholder="Enter at least 50 characters"></textarea>
            <small class="muted">Minimum 50 characters.</small>
          </div>
<div class="form-actions" style="justify-content:flex-end; width:100%;">
            <button type="submit" class="btn">Submit</button>
            <button type="reset" class="btn-secondary">Reset</button>
          </div>

          <!-- (Removed: Add to Table button and below summary table as requested) -->
          <input id="cashTotalInput" type="number" step="0.01" name="total" hidden />
        </form>
      </div>
    </div>

          <input id="cashTotalInput" type="number" step="0.01" name="total" hidden />
        </form>
      </div>
    </div>
  </div>

  <script>
    /* ===== Helpers ===== */
    function readCookie(name){ return document.cookie.split('; ').find(r=>r.startsWith(name+'='))?.split('=')[1] || '' }
    function getUsername(){ return (window.APP_USERNAME || document.body.dataset.username || readCookie('username') || '').trim() }
    function firstLetterOfUser(){ const u=getUsername(); return u ? u[0].toUpperCase() : 'X' }
    function previewSeq(code){ const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10); return n+1 }
    function commitSeq(code){ const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10)+1; localStorage.setItem(k,String(n)); return n }
    function formatClaim(code,seq){ const fl=firstLetterOfUser(); const n  = String(seq).padStart(3,'0'); return code==='PR'?`${fl}-PR-${seq}`:`${fl}-${code}V-${seq}` }

    /* ===== Router ===== */
    const pages=[...document.querySelectorAll('.page')];
    const navBtns=[...document.querySelectorAll('.nav-btn')];
    function showPage(id){
      pages.forEach(p=>p.classList.remove('active'));
      const pg=document.getElementById(id); if(pg) pg.classList.add('active');
      navBtns.forEach(b=>b.classList.toggle('active', b.dataset.target===id));
      if(id==='pg-voucher') renderVoucherTable();
      if(id==='pg-payment') renderPaymentTable();
      if(id==='pg-ledger' && !window._ledgerInit){ fillSampleLedger(); window._ledgerInit=true; }
      window.scrollTo({top:0, behavior:'instant'});
    }
    navBtns.forEach(b=> b.addEventListener('click', ()=> showPage(b.dataset.target)));
    document.querySelectorAll('[data-home]').forEach(btn=> btn.addEventListener('click', ()=> showPage('pg-blank')));

    // Hide "Validate Voucher" for non-approvers (approve_seq == 0)
    try {
      fetch('/api/auth/me/')
        .then(r => r.ok ? r.json() : Promise.reject(r))
        .then(me => {
          const seq = parseInt((me && me.approve_seq) ?? 0, 10) || 0;
          const btns = document.querySelectorAll('.nav-btn[data-target="pg-validate"]');
          btns.forEach(b => { b.style.display = (seq > 0 ? '' : 'none'); });
        })
        .catch(()=>{});
    } catch(_) {}

    /* ===== Voucher dropdown ===== */
    const ddBtn = document.getElementById('btnVoucherDropdown');
    const ddMenu = document.getElementById('voucherMenu');
    ddBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); ddMenu.classList.toggle('open'); });
    ddMenu?.addEventListener('click', (e)=>{
      const t=e.target.closest('button[data-type]'); if(!t) return;
      ddMenu.classList.remove('open'); openVoucherWizardFor(t.dataset.type);
    });
    document.addEventListener('click', ()=> ddMenu?.classList.remove('open'));

    /* ===== Payment Request button ===== */
    (function(){
      // Hide old dropdown if present and insert a direct button
      const prContainer = document.querySelector('#pg-payment .actions');
      const oldGroup = prContainer?.querySelector('.btn-group');
      if(prContainer){
        const btn = document.createElement('button'); btn.id='btnNewPR'; btn.className='btn'; btn.textContent='+ New Request';
        prContainer.insertBefore(btn, prContainer.firstChild);
        btn.addEventListener('click', ()=> openPaymentWizard());
        if(oldGroup) oldGroup.style.display='none';
      }
    })();

    /* ===== Modal helpers ===== */
    const modal = document.getElementById('app-modal');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalBackBtn  = document.getElementById('modalBackBtn');

    function openModal(title, contentEl){
      modalTitle.textContent = title || 'New';
      modalBody.innerHTML = '';
      if(contentEl) modalBody.appendChild(contentEl);
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
    }
    function closeModal(){
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
      modalBody.innerHTML='';
      document.body.style.overflow='';
    }
    modalCloseBtn.addEventListener('click', closeModal);
    modalBackBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

    /* ===== Voucher storage ===== */
    const V_KEY='vouchers';
    const loadV=()=>{ try{return JSON.parse(localStorage.getItem(V_KEY)||'[]')}catch{return[]} };
    const saveV=(a)=>localStorage.setItem(V_KEY,JSON.stringify(a));
    function addVoucher(v){
      const arr=loadV(); const now=Date.now();
      arr.push({ id:'v_'+now, createdAt:now, currentStage:'dept',
        stages:{dept:{status:'Pending',updatedAt:now},finance:{status:'Pending',updatedAt:null},accountant:{status:'Pending',updatedAt:null}}, ...v });
      saveV(arr);
    }
    function approveStageV(item, stage){
      item.stages[stage].status='Approved'; item.stages[stage].updatedAt=Date.now();
      const order=['dept','finance','accountant'], idx=order.indexOf(stage);
      if(idx<order.length-1){ const next=order[idx+1]; item.currentStage=next; if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now(); }
      else item.currentStage='done';
    }
    function manualApproveVoucher(id){
      const arr=loadV(); const it=arr.find(x=>x.id===id); if(!it) return;
      if(it.currentStage==='done'){ saveV(arr); renderVoucherTable(); return; }
      approveStageV(it, it.currentStage); saveV(arr); renderVoucherTable();
    }
    function stageCellVoucher(item, stage){
      const st=item.stages[stage], isActive=item.currentStage===stage, statusText=st.status;
      let cls='s-pending'; if(statusText==='Approved') cls='s-approved';
      const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '‚Äî';
      const btn = isActive ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApproveVoucher('${item.id}')">Approve</button>` : '';
      return `<span class="${cls}">${statusText}</span>${btn}<span class="muted">Updated: ${updated}</span>`;
    }
    
function renderVoucherTable(){
  const tbody=document.getElementById('voucherTbody'); if(!tbody) return;
  tbody.innerHTML = '<tr class="empty"><td colspan="14">Loading‚Ä¶</td></tr>';
  fetch('/api/vouchers/list/')
    .then(res => res.json().then(js => ({ok:res.ok, js})))
    .then(({ok, js}) => {
      if(!ok || !js.ok){ throw new Error(js.error || 'HTTP error'); }
      const rows = js.data || [];
      if(!Array.isArray(rows) || rows.length===0){
        tbody.innerHTML = '<tr class="empty"><td colspan="14">No vouchers yet.</td></tr>';
        return;
      }
      function fmtStatus(val, remarks){
        if(typeof val === 'string'){
          const v = val.trim().toLowerCase();
          if(v==='approved' || v==='rejected' || v==='pending') return v[0].toUpperCase()+v.slice(1);
          if(v==='1') return 'Approved';
        }
        if(val===1 || val===true) return 'Approved';
        if(remarks && String(remarks).trim()) return 'Rejected';
        return 'Pending';
      }
      tbody.innerHTML = rows.map((r, i) => {
        const amt = Number(r.total_amount||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
        const vno = (r.voucher_id||'').trim();
        const showId = (vno||'').replace(/(\d{4})$/,'');
        const s1 = fmtStatus(r.approver1, r.remarks1);
        const s2 = fmtStatus(r.approver2, r.remarks2);
        const s3 = fmtStatus(r.approver3, r.remarks3);
        const s4 = fmtStatus(r.approver4, r.remarks4);
        const cls = (s)=> s==='Approved'?'s-approved':(s==='Rejected'?'s-rejected':'s-pending');
        const rem = (x)=> (x && String(x).trim()) ? String(x) : '';
        const vtype = (r.voucher_type||'').toUpperCase();
        const billBtn = vtype==='PURCHASE'
            ? `<a class="btn-secondary bill-btn" href="/api/files/purchase/voucher/${encodeURIComponent(vno)}/" target="_blank" rel="noopener">View</a>`
            : `<button class="btn-secondary bill-btn" data-vtype="${vtype}" data-vno="${encodeURIComponent(vno)}">View</button>`;
        return `<tr>
          <td>${i+1}</td>
          <td>${r.upload_date||'-'}</td>
          <td>${showId||'-'}</td>
          <td>${amt}</td>
          <td>${billBtn}</td>
          <td><span class="${cls(s1)}">${s1}</span></td><td>${rem(r.remarks1)}</td>
          <td><span class="${cls(s2)}">${s2}</span></td><td>${rem(r.remarks2)}</td>
          <td><span class="${cls(s3)}">${s3}</span></td><td>${rem(r.remarks3)}</td>
          <td><span class="${cls(s4)}">${s4}</span></td><td>${rem(r.remarks4)}</td>
          <td>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary" data-edit="${vno}">Update</button>
              <button class="btn-secondary" data-del="${vno}">Delete</button>
            </div>
          </td>
        </tr>`;
      }).join('');
    })
    .catch(err => {
      console.error(err);
      tbody.innerHTML = '<tr class="empty"><td colspan="14">Failed to load. Try again.</td></tr>';
    });
}

      if(false){ // disabled: leftover localStorage voucher table (replaced by API-based render)
      tbody.innerHTML='';
      arr.forEach((item,i)=>{
        const num=parseFloat((item.amount+'').replace(/[^0-9.]/g,''))||0;
        const fmt=num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${item.date||'-'}</td><td>${item.claimNo||'-'}</td><td>${fmt}</td><td><button class="btn-secondary bill-btn" onclick="openBillFor(${i})">View (${ (item.file_count||item.files_count||(item.fileUrls?item.fileUrls.length:0)||(item.bills?item.bills.length:0)||0) })</button></td><td>${stageCellVoucher(item,'accountant')}</td><td>${stageCellVoucher(item,'finance')}</td><td>${stageCellVoucher(item,'dept')}</td>`;
        tbody.appendChild(tr);
      });
      }


    /* ===== Payment storage ===== */
    const LS_KEY='paymentRequests';
    const TWO_DAYS=2*24*60*60*1000;
    function loadPR(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return[]} }
    function savePR(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function addPaymentRequest({date, amount, claimNo, prType}){
      const arr=loadPR(); const now=Date.now();
      arr.push({ id:'pr_'+now, date, amount, claimNo, prType, createdAt:now,
        stages:{dept:{status:'Pending',updatedAt:now},finance:{status:'Pending',updatedAt:null},accountant:{status:'Pending',updatedAt:null}},
        currentStage:'dept' }); savePR(arr);
    }
    function approveStage(item, stage, auto=false){
      item.stages[stage].status = auto ? 'Auto-approved' : 'Approved';
      item.stages[stage].updatedAt = Date.now();
      const order=['dept','finance','accountant'], idx=order.indexOf(stage);
      if(idx<order.length-1){ const next=order[idx+1]; item.currentStage=next; if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now(); }
      else item.currentStage='done';
    }
    function applyAutoApprovals(item){
      const order=['dept','finance','accountant'];
      for(const stage of order){
        const st=item.stages[stage];
        if(st.status==='Pending'){
          const base = st.updatedAt ?? item.createdAt;
          if(Date.now()-base >= TWO_DAYS){ approveStage(item, stage, true); continue; }
          else break;
        }
      }
      if(item.stages.dept.status==='Pending') item.currentStage='dept';
      else if(item.stages.finance.status==='Pending') item.currentStage='finance';
      else if(item.stages.accountant.status==='Pending') item.currentStage='accountant';
      else item.currentStage='done';
      return item;
    }
    function manualApprove(id){
      const arr=loadPR(); const item=arr.find(x=>x.id===id); if(!item) return;
      applyAutoApprovals(item); if(item.currentStage==='done'){ savePR(arr); renderPaymentTable(); return; }
      approveStage(item, item.currentStage, false); savePR(arr); renderPaymentTable();
    }
    function renderStageCell(item, stage){
      const st=item.stages[stage], isActive=item.currentStage===stage, statusText=st.status;
      let cls='s-pending'; if(statusText==='Approved') cls='s-approved';
      else if(statusText==='Auto-approved') cls='s-auto';
      const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '‚Äî';
      const btn = isActive ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApprove('${item.id}')">Approve</button>` : '';
      return `<span class="${cls}">${statusText}</span>${btn}<span class="muted">Updated: ${updated}</span>`;
    }
    async function renderPaymentTable(){
      const tbody = document.getElementById('paymentTbody');
      if (!tbody) return;
          tbody.innerHTML = '<tr class="empty"><td colspan="14">Loading...</td></tr>';
      try{
        const res = await fetch('/api/payment_request/my/', { headers: { 'Accept': 'application/json' } });
        const arr = await res.json().catch(()=>[]);
        if(!Array.isArray(arr) || arr.length===0){
          tbody.innerHTML = '<tr class="empty"><td colspan="14">No payment requests yet.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        arr.forEach((it, i)=>{
          const amt = Number(it.request_amount||0);
          const fmtAmt = amt.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
          const tr = document.createElement('tr');
          const claim = it.claim_no || ('PR-'+String(it.request_id).padStart(6,'0'));
          const cell = (v)=> (v===null||v===undefined||v==='')?'-':String(v);
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${cell(it.date)}</td>
            <td>${claim}</td>
            <td>${fmtAmt}</td>
            <td>-</td>
            <td>${cell(it.manager)}</td><td>${cell(it.remarks1)}</td>
            <td>${cell(it.approver2? 'Approved':'Pending')}</td><td>${cell(it.remarks2)}</td>
            <td>${cell(it.approver3? 'Approved':'Pending')}</td><td>${cell(it.remarks3)}</td>
            <td>${cell(it.approver4? 'Approved':'Pending')}</td><td>${cell(it.remarks4)}</td>
            <td>-</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){ tbody.innerHTML = '<tr class="empty"><td colspan="14">Failed to load.</td></tr>'; }
      // Also render approvals section
      try{ await renderPendingPRApprovals(); }catch(_){ }
    }

    async function renderPendingPRApprovals(){
      const tbody = document.querySelector('#paymentApproveTable tbody'); if(!tbody) return;
      tbody.innerHTML = '<tr class="empty"><td colspan="6">Loading...</td></tr>';
      try{
        const res = await fetch('/api/payment_request/pending/', { headers: { 'Accept': 'application/json' } });
        const arr = await res.json().catch(()=>[]);
        if(!Array.isArray(arr) || arr.length===0){ tbody.innerHTML = '<tr class="empty"><td colspan="6">Nothing pending for you.</td></tr>'; return; }
        tbody.innerHTML = '';
        arr.forEach((it,i)=>{
          const amt = Number(it.request_amount||0);
          const fmt = amt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
          const tr = document.createElement('tr');
          const req = `PR-${String(it.request_id).padStart(6,'0')}`;
          const approveBtn = document.createElement('button');
          approveBtn.className='btn-secondary'; approveBtn.textContent='Approve';
          approveBtn.addEventListener('click', async ()=>{
            if(it.is_final){
              const approved = prompt('Enter approved amount (number):', String(amt));
              const n = Number(approved);
              if(!(n>=0)){ alert('Enter a valid number.'); return; }
              const rdate = prompt('Enter release date (YYYY-MM-DD):', new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10));
              if(!rdate){ alert('Release date required'); return; }
              const remarks = prompt('Remarks (optional)')||'';
              const resp = await fetch('/api/payment_request/decision/', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ request_id: it.request_id, decision: 'approve', approved_amount: n, release_date: rdate, remarks })
              });
              const js = await resp.json().catch(()=>({ok:false}));
              if(!resp.ok || !js.ok){ alert('Failed: '+(js.error||resp.status)); return; }
            } else {
              const resp = await fetch('/api/payment_request/decision/', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ request_id: it.request_id, decision: 'approve' })
              });
              const js = await resp.json().catch(()=>({ok:false}));
              if(!resp.ok || !js.ok){ alert('Failed: '+(js.error||resp.status)); return; }
            }
            await renderPendingPRApprovals();
          });
          const rejectBtn = document.createElement('button');
          rejectBtn.className='btn-secondary'; rejectBtn.style.marginLeft='8px'; rejectBtn.textContent='Reject';
          rejectBtn.addEventListener('click', async ()=>{
            const txt = prompt('Enter rejection remarks (min 50 chars):')||'';
            if(txt.trim().length<50){ alert('Need at least 50 characters.'); return; }
            const resp = await fetch('/api/payment_request/decision/', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ request_id: it.request_id, decision: 'reject', remarks: txt })
            });
            const js = await resp.json().catch(()=>({ok:false}));
            if(!resp.ok || !js.ok){ alert('Failed: '+(js.error||resp.status)); return; }
            await renderPendingPRApprovals();
          });
          const actionCell = document.createElement('td'); actionCell.appendChild(approveBtn); actionCell.appendChild(rejectBtn);
          tr.innerHTML = `<td>${i+1}</td><td>${req}</td><td>${it.purpose||''}</td><td>${fmt}</td><td>${it.employee_name||''}</td>`;
          tr.appendChild(actionCell);
          tbody.appendChild(tr);
        });
      }catch(e){ tbody.innerHTML = '<tr class="empty"><td colspan="6">Failed to load.</td></tr>'; }
    }

    /* ===== Payment Request Wizard ===== */
    function openPaymentWizard(prType){
      const shell=document.createElement('div');
      const nice = prType;
      shell.innerHTML = `
        <div class="uv-wrap">
          <h3 class="uv-heading">${nice} Payment Request</h3>
          <form class="form" id="prForm">
            <div class="form-row"><label>Date</label><input id="pr-date" type="date" disabled></div>
            <div class="form-row"><label>Work Order</label>
              <select id="pr-wo"><option value="">Loading work orders...</option></select>
            </div>
            <div class="form-row"><label>Particulars</label>
              <select id="pr-purpose">
                <option value="Advance">Advance</option>
                <option value="Purchase">Purchase</option>
                <option value="Settlement">Settlement</option>
              </select>
            </div>
            <div class="form-row"><label>Amount</label><input id="pr-amount" type="number" min="0" step="0.01" required></div>
            <div class="form-row"><label>Description</label><textarea id="pr-desc" rows="3" placeholder="Describe the purpose (min 50 characters)"></textarea></div>
            <div class="uv-nav" style="justify-content:flex-start">
              <button type="submit" class="uv-btn primary">Submit</button>
              <button type="button" id="pr-reset" class="uv-btn">Reset</button>
            </div>
          </form>
        </div>`;

      openModal('New Payment Request', shell);
      const prForm = shell.querySelector('#prForm');
      const todayISO = new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
      shell.querySelector('#pr-date').value = todayISO;
      // Load work orders
      (async()=>{
        try{
          const res = await fetch('/api/projects/', { headers: { 'Accept': 'application/json' } });
          const list = await res.json().catch(()=>[]);
          const sel = shell.querySelector('#pr-wo'); sel.innerHTML = '<option value="">-- Select Work Order --</option>';
          list.forEach(it=>{
            const opt=document.createElement('option'); opt.value = it.work_order_no||''; opt.textContent = (it.project_name?`${it.work_order_no} - ${it.project_name}`:(it.work_order_no||'')); sel.appendChild(opt);
          });
        }catch(e){ try{ shell.querySelector('#pr-wo').innerHTML='<option value="">Failed to load</option>'; }catch(_){} }
      })();

      shell.querySelector('#pr-reset')?.addEventListener('click', ()=>{
        prForm.reset(); shell.querySelector('#pr-date').value = todayISO;
      });

      prForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const wo = shell.querySelector('#pr-wo').value;
        const purpose = shell.querySelector('#pr-purpose')?.value;
        const amt = shell.querySelector('#pr-amount').value;
        const desc = shell.querySelector('#pr-desc').value;
        if(!wo){ alert('Select work order'); return; }
        if(!(parseFloat(amt)>0)){ alert('Enter a positive amount.'); return; }
        if(!desc || desc.trim().length < 50){ alert('Description must be at least 50 characters.'); return; }
        try{
          const fd = new FormData();
          fd.append('work_order_no', wo);
          fd.append('purpose', purpose);
          fd.append('amount', amt);
          fd.append('description', desc);
          try{ if(typeof getUsername==='function'){ fd.append('username', getUsername()||''); } }catch(_){ }
          const resp = await fetch('/api/payment_request/create/', { method:'POST', body: fd });
          const js = await resp.json().catch(()=>({ok:false,error:'Invalid JSON'}));
          if(!resp.ok || !js.ok){ alert('Save failed: ' + (js.error || `HTTP ${resp.status}`)); return; }
          alert('Payment request submitted: '+(js.data?.request_no||('PR-'+String(js.data?.request_id||'').padStart(6,'0'))));
          renderPaymentTable();
          closeModal();
        }catch(err){ console.error(err); alert('Network error while saving.'); }
      });
    }

    /* ===== Voucher Wizard ===== */
    function updateClaimPreview(formEl){
      const code=formEl?.dataset?.code; if(!code) return;
      const seqPreview = previewSeq(code);
      const claim = formatClaim(code, seqPreview);
      formEl.querySelectorAll('.claim-text,.claim-text-inline').forEach(el=> el.textContent = claim);
      const hidden=formEl.querySelector('.claim'); if(hidden) hidden.value = claim;
    }
    
function openVoucherWizardFor(vtype){
  const shell=document.createElement('div');

  // Tabs
  let tabsHtml = '';
  if (vtype==='purchase'){
    tabsHtml = `<div class="uv-tabs">
      <button class="uv-tab active" data-step="2">Details</button>
      <button class="uv-tab" data-step="3" data-conditional="purchase">Purchased Items</button>
      <button class="uv-tab" data-step="4">Upload Bills</button>
    </div>`;
  } else if (vtype==='travel'){
    // Travel = Details ‚Üí Expenses (no Upload Bills)
    tabsHtml = `<div class="uv-tabs">
      <button class="uv-tab active" data-step="2">Details</button>
      <button class="uv-tab" data-step="3" id="tab-expenses">Expenses</button>
    </div>`;
} else {
    tabsHtml = `<div class="uv-tabs">
      <button class="uv-tab active" data-step="2">Details</button>
    </div>`;
  }

  const purchasedPanel = (vtype==='purchase') ? (`
    <div class="uv-panel hidden" id="uv-step3">
      <h3 class="uv-heading">Purchased Items</h3>
      <div class="form">
        <div class="form-row"><label>Material Name</label><input type="text" id="pi-name"></div>
        <div class="form-row"><label>Quantity</label><input type="number" step="0.01" min="0" id="pi-qty"></div>
        <div class="form-row">
          <label>UOM</label>
          <select id="pi-uom">
            <option value="" selected disabled>-- Select UOM --</option>
            <option>lot</option><option>Roll</option><option>Box</option><option>Feet</option>
            <option>Set</option><option>Nos</option><option>Pair</option>
          </select>
        </div>
        <div class="form-row"><label>Unit_Rate</label><input type="number" step="0.01" min="0" id="pi-amount-unit"></div>
        <div class="form-actions">
          <button type="button" class="btn" id="pi-add">ADD</button>
          <button type="button" class="btn-secondary" id="pi-clear">Clear</button>
        </div>
        <div class="table-wrap" style="margin-top:10px;">
          <table class="data" id="pi-table">
            <thead><tr><th>#</th><th>Material</th><th>Qty</th><th>UOM</th><th>Unit_Rate</th><th>Total Amount</th></tr></thead>
            <tbody id="pi-tbody"><tr class="empty"><td colspan="6">No items added.</td></tr></tbody>
            <tfoot><tr><th colspan="5" style="text-align:right">Total</th><th id="pi-total">0.00</th></tr></tfoot>
          </table>
        </div>
      </div>
    </div>`): '';

  const travelExpensesPanel = (vtype==='travel') ? (`
    <div class="uv-panel hidden" id="uv-step3">
      <h3 class="uv-heading">Travel Expenses</h3>
      <div class="uv-help">Add entries for Travel, Local, Hotel, DA/FA and Misc.</div>
      <div id="uv-step3-content"></div>
    </div>`): '';

  shell.innerHTML = `
    <div class="uv-wrap">
      ${tabsHtml}
      <div class="uv-panel" id="uv-step2">
        <h3 class="uv-heading" id="uv-details-title">${vtype.charAt(0).toUpperCase()+vtype.slice(1)} Voucher Details</h3>
        <div id="uv-form-slot"></div>
      </div>
      ${purchasedPanel}
      ${travelExpensesPanel}
      <div class="uv-panel hidden" id="uv-step4">
        <h3 class="uv-heading">Upload Bills</h3>
        <p class="uv-help">Attach one or more files. Accepted: PDF/JPG/PNG.</p>
        <input type="file" id="uv-files" multiple accept=".pdf,.jpg,.jpeg,.png">
        <div id="uv-filelist" class="uv-filelist"></div>
        <div class="uv-nav" style="justify-content:flex-start;margin-top:10px">
          <button class="uv-btn primary" id="uv-submit-btn" type="button">Submit</button>
          <button class="uv-btn" id="uv-reset-btn" type="button">Reset</button>
        </div>
      </div>
      <div class="uv-nav">
        <button id="uv-back" class="uv-btn" type="button" hidden>Back</button>
        <button id="uv-next" class="uv-btn primary" type="button">Submit</button>
      </div>
    </div>`;

  openModal('Add New Voucher', shell);

  let tabs=[...shell.querySelectorAll('.uv-tab')];
  const panels={2:shell.querySelector('#uv-step2'),3:shell.querySelector('#uv-step3'),4:shell.querySelector('#uv-step4')};
  const nextBtn=shell.querySelector('#uv-next'); const backBtn=shell.querySelector('#uv-back');
  const submitBtn=shell.querySelector('#uv-submit-btn'); const filesEl=shell.querySelector('#uv-files');
  const fileList=shell.querySelector('#uv-filelist'); const resetBtn=shell.querySelector('#uv-reset-btn');
  const formSlot=shell.querySelector('#uv-form-slot');
  const step3Content = shell.querySelector('#uv-step3-content');
  // For cash vouchers: remove Upload Bills step and hide Back/Next nav
  if (vtype === 'cash') {
    const up = shell.querySelector('#uv-step4'); if (up) up.remove();
    const nav = shell.querySelector('#uv-next')?.closest('.uv-nav'); if (nav) nav.style.display = 'none';
  }

  let step=2, activeForm=null, purchaseItems=[];
  function fmt2(n){ return (n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) }
  // Allow Expense to proceed if rows exist, even if small inputs are blank
  function hasCashRows(){
    if (vtype !== 'cash') return false;
    const tbody = formSlot.querySelector('#cashItemsBody');
    if (!tbody) return false;
    return [...tbody.querySelectorAll('tr')].some(tr => !tr.querySelector('.muted'));
  }

  function setStep(n){
    step=n;
    tabs.forEach(tb=> tb.classList.toggle('active', Number(tb.dataset.step)===n));
    Object.values(panels).forEach(p=> p && p.classList.add('hidden'));
    panels[n]?.classList.remove('hidden');
    backBtn.style.visibility = n===2 ? 'hidden' : 'visible';
    nextBtn.textContent = n===4 ? 'Finish' : 'Next';
    if(n===4 && vtype==='purchase' && purchaseItems.length===0){
      panels[4].classList.add('hidden'); panels[3]?.classList.remove('hidden');
      step=3; alert('Add at least one Purchased Item before proceeding.');
    }
  }

  tabs.forEach(tb=>tb.addEventListener('click',()=>{
    const target=Number(tb.dataset.step);
    if(target>step && step===2){
      const required = [...formSlot.querySelectorAll('[required]')];
      const missing = required.some(i=>!i.value);
      if(missing && !hasCashRows()){
        alert('Please fill required fields in Details.'); return;
      }    
    }
    setStep(target);
  }));

  backBtn.addEventListener('click',()=>{ if(step>2) setStep(step-1) });
  nextBtn.addEventListener('click',()=>{
    if(step===2){
      const required = [...formSlot.querySelectorAll('[required]')];
      const missing = required.some(i=>!i.value);
      if(missing && !hasCashRows()){
        alert('Please fill required fields in Details.'); return;
      }
      if(vtype==='purchase'){ setStep(3); }
      else if(vtype==='travel'){ 
        // reveal Expenses tab only now
        const te = shell.querySelector('#tab-expenses'); if(te) te.style.display='';
        setStep(3);
      } else { setStep(4); }
    }else if(step===3){
      if(vtype==='purchase' && purchaseItems.length===0){ alert('Add at least one Purchased Item.'); return; }
      if(vtype==='travel'){ submitBtn?.click?.(); if(!submitBtn){ closeModal(); } return; }
      setStep(4);
    }else if(step===4){
      submitBtn.click();
    }
  });

  function cloneForm(){
    const sources={ purchase:'#page-purchase-form .content-card form', travel:'#page-travel-form .content-card form', cash:'#page-cash-form .content-card form' };
    const srcSel=sources[vtype]; const srcForm=document.querySelector(srcSel); formSlot.innerHTML='';
    if(!srcForm){ formSlot.innerHTML='<div style="color:#dc2626">Form not found.</div>'; return; }
    activeForm=srcForm.cloneNode(true); 
    activeForm.setAttribute('onsubmit','return false;');
    try{ updateClaimPreview(activeForm) }catch(e){}

    if(vtype==='purchase'){
      // (same as before in your file) - lock date & set bill date window; remove actions
      const now = new Date();
      const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      const yesterday = new Date(now); yesterday.setDate(yesterday.getDate()-1);
      const dayBefore = new Date(now); dayBefore.setDate(dayBefore.getDate()-2);
      const d1 = activeForm.querySelector('#pv-date'); if(d1){ d1.value = toISO(now); d1.setAttribute('disabled','true'); }
      const d2 = activeForm.querySelector('#pv-billdate'); if(d2){ d2.setAttribute('min', toISO(dayBefore)); d2.setAttribute('max', toISO(yesterday)); d2.value = toISO(yesterday); }
      activeForm.querySelector('.form-actions')?.remove();
    }

    if(vtype==='travel'){
      // Split into Details (only top allowance table) and Expenses (actions + exp-cards + summary)
      const actionsRow = activeForm.querySelector('.form-actions'); // has Submit/Reset
      if (actionsRow){
        // Remove Submit from Details, keep Reset, add 'Next'
        
      }

      // Travel allowance table stays in Details automatically (we'll keep activeForm as is but move other pieces)
      const expActions = activeForm.querySelector('.actions');            // row with five buttons
      const cards = [...activeForm.querySelectorAll('.exp-card')];        // five cards
      const summary = activeForm.querySelector('.summary-wrap');          // summary table

      // Remove them from Details and mount into Expenses panel
      const expContainer = document.createElement('div');
      expContainer.className = 'content-card';
      const expForm = document.createElement('div'); expForm.className='form';
      if (expActions){ expForm.appendChild(expActions); }
      cards.forEach(c => { c.style.display='none'; expForm.appendChild(c); });
      if (summary){ expForm.appendChild(summary); }
      expContainer.appendChild(expForm);
      if (step3Content) step3Content.appendChild(expContainer);

      
// Wire radios to switch expense cards
const radioInputs = expForm.querySelectorAll('input[name="expTab"]');
radioInputs.forEach(r => {
  r.addEventListener('change', () => {
    expForm.querySelectorAll('.exp-card').forEach(c => c.style.display='none');
    const card = expForm.querySelector('#card-' + r.value);
    if(card) card.style.display='block';
  });
});
// Select first section by default
const firstRadio = expForm.querySelector('input[name="expTab"][value="fare"]');
if(firstRadio){ firstRadio.checked = true; firstRadio.dispatchEvent(new Event('change')); }
}

    if(vtype==='cash'){
      // Lock upload date to today and fill expense date options.
      const todayISO = new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
      const upEl = activeForm.querySelector('#cash-upload-date'); if (upEl) { upEl.value = todayISO; }
      const expSel = activeForm.querySelector('#cash-exp-date');
      if (expSel) {
        const d0 = new Date();
        const fmt = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
        const opts = [
          { label: 'Today', date: new Date(d0) },
          { label: 'Yesterday', date: new Date(d0.getTime()-86400000) },
          { label: 'Day before yesterday', date: new Date(d0.getTime()-2*86400000) }
        ];
        expSel.innerHTML = '';
        opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=fmt(o.date); opt.textContent=`${o.label} (${fmt(o.date)})`; expSel.appendChild(opt); });
      }
      // Populate Work Orders if there is a global loader (reuse purchase select if available)
      const cashWO = activeForm.querySelector('#cash-wo');
      const srcWO = document.querySelector('#work_order_no');
      if (cashWO && srcWO && srcWO.options && srcWO.options.length>0){
        cashWO.innerHTML = srcWO.innerHTML;
      }
    }
    
    formSlot.appendChild(activeForm);
  }
  cloneForm();

  // Purchased Items wiring
  const piTbody = shell.querySelector('#pi-tbody');
  const piTotal = shell.querySelector('#pi-total');
  function renderPI(){
    if(!piTbody) return;
    if(purchaseItems.length===0){
      piTbody.innerHTML = '<tr class="empty"><td colspan="6">No items added.</td></tr>';
    }else{
      piTbody.innerHTML = purchaseItems.map((it,idx)=>`<tr>
          <td>${idx+1}</td><td>${it.name}</td><td>${it.qty}</td><td>${it.uom}</td><td>${fmt2(it.amount)}</td><td>${fmt2(it.total)}</td>
        </tr>`).join('');
    }
    const total = purchaseItems.reduce((s,i)=>s+(i.total||0),0);
    if(piTotal) piTotal.textContent = fmt2(total);
  }
  shell.querySelector('#pi-add')?.addEventListener('click',()=>{
    const name = shell.querySelector('#pi-name').value.trim();
    const qty  = parseFloat(shell.querySelector('#pi-qty').value||'0');
    const uom  = shell.querySelector('#pi-uom').value.trim();
    const amount  = parseFloat(shell.querySelector('#pi-amount-unit').value||'0');
    if(!name || !(qty>0) || !(amount>=0)){ alert('Enter Material, positive Quantity and Amount.'); return; }
    const total = qty * amount;
    purchaseItems.push({name, qty, uom, amount, total});
    shell.querySelector('#pi-name').value=''; shell.querySelector('#pi-qty').value=''; shell.querySelector('#pi-uom').value=''; shell.querySelector('#pi-amount-unit').value='';
    renderPI();
  });
  shell.querySelector('#pi-clear')?.addEventListener('click',()=>{
    shell.querySelector('#pi-name').value=''; shell.querySelector('#pi-qty').value=''; shell.querySelector('#pi-uom').value=''; shell.querySelector('#pi-amount-unit').value='';
  });
  renderPI();

  // Files
  filesEl?.addEventListener('change', ()=>{
    fileList.innerHTML='';
    [...filesEl.files].forEach(f=>{
      const d=document.createElement('div');
      d.textContent='‚Ä¢ '+f.name;
      fileList.appendChild(d);
    });
  });
  resetBtn?.addEventListener('click', ()=>{ filesEl.value=''; fileList.innerHTML=''; activeForm?.reset?.(); try{updateClaimPreview(activeForm)}catch(e){} });

  // Submit (as in original; only wired to purchase in this template)
  submitBtn?.addEventListener('click', async ()=>{
    if (vtype === 'cash' || vtype === 'expense') {
      const root = (document.getElementById('modal-body')?.querySelector('#cashForm')) || document;
      const uploadDate = root.querySelector('#cash-upload-date')?.value || toISO(new Date());
      const expenseDate = root.querySelector('#cash-exp-date')?.value || uploadDate;
      const particulars = root.querySelector('#cash-particulars')?.value?.trim() || '';
      const workOrderNo = root.querySelector('#cash-wo')?.value || '';
      const remarks = root.querySelector('#cash-remarks')?.value?.trim() || '';
      const amt = parseFloat(root.querySelector('#cash-amount')?.value || '0') || 0;
      if (!particulars || !(amt>0)) { alert('Enter Particulars and a positive Amount.'); return; }
      if (remarks && remarks.length>0 && remarks.length < 50) { alert('Remarks should be at least 50 characters (or leave it empty).'); return; }

      const fd = new FormData();
      const items = [{ date: expenseDate, particulars: particulars, amount: amt, remarks: remarks }];
      fd.append('items', JSON.stringify(items));
fd.append('upload_date', uploadDate);
      fd.append('expense_date', expenseDate);
      if (workOrderNo) fd.append('work_order_no', workOrderNo);
      const billFile = root.querySelector('#cash-bill')?.files?.[0];
      if (!billFile) { alert('Please upload the bill file for this Expense voucher.'); return; }
      fd.append('bill', billFile);
      try {
        const res = await fetch('/api/vouchers/expense/create/', { method: 'POST', body: fd });
        const js = await res.json();
        if (!res.ok || !js.ok) { console.error(js); alert('Save failed: ' + (js.error || `HTTP ${res.status}`)); return; }
        const total = js.data?.total_amount ?? amt;
        const claim = root.querySelector('.claim')?.value || '';
        addVoucher({ type: 'expense', date: expenseDate, amount: String(total), workorder: workOrderNo, remarks: remarks, claimNo: claim, files: [] });
        renderVoucherTable();
        alert(`Saved! Voucher ${js.data?.voucher_id || claim} (Total ‚Çπ ${total})`);
        closeModal();
      } catch (err) {
        console.error(err);
        alert('Network error while saving.');
      }
      return;
    }

    // Prevent purchase validator from firing for other voucher types (e.g., travel)
    if (vtype !== 'purchase') {
      return;
    }

    const date        = activeForm.querySelector('#pv-date')?.value || '';
    const billDate    = activeForm.querySelector('#pv-billdate')?.value || '';
    const supplierId  = activeForm.querySelector('#supplier_id')?.value || '';
    const workOrderNo = activeForm.querySelector('#work_order_no')?.value || '';
    if (!date || !billDate || !supplierId || !workOrderNo) { alert('Please fill Date, Bill Date, Supplier and Work Order.'); return; }
    if (purchaseItems.length===0) { alert('Add at least one Purchased Item.'); return; }

    const items = purchaseItems.map(it => ({ materialname: it.name, qty: it.qty, uom: it.uom, amount_per_unit: it.amount }));
    const files = (filesEl && filesEl.files) ? [...filesEl.files] : [];
    if (files.length === 0) { alert('Please upload at least one bill file for this Purchase voucher.'); return; }
    const fd = new FormData();
    fd.append('date', date); fd.append('bill_date', billDate); fd.append('supplier_id', supplierId); fd.append('work_order_no', workOrderNo);
    fd.append('items', JSON.stringify(items)); files.forEach(f => fd.append('bill_files', f));
    try {
      const res = await fetch('/api/vouchers/purchase/create/', { method:'POST', body:fd });
      const js = await res.json();
      if (!res.ok || !js.ok) { console.error(js); alert('Save failed: ' + (js.error || `HTTP ${res.status}`)); return; }
      const total = js.data?.total_amount || '0.00';
      const today = date; const claim = activeForm.querySelector('.claim')?.value || '';
      addVoucher({ type:'purchase', date: today, amount: String(total), workorder: workOrderNo, remarks:'', claimNo: claim, files: [] });
      renderVoucherTable(); alert(`Saved! Voucher ${js.data.voucher_id} (Total ‚Çπ ${total})`); closeModal();
    } catch (err) { console.error(err); alert('Network error while saving.'); }
  });

  // Cash form submit inside Details: trigger same save
  if (vtype === 'cash') {
    const cashFormEl = shell.querySelector('#cashForm');
    cashFormEl?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const root = (document.getElementById('modal-body')?.querySelector('#cashForm')) || document;
      const toISO = d => new Date(d.getTime() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
      const uploadDate = root.querySelector('#cash-upload-date')?.value || toISO(new Date());
      const expenseDate = root.querySelector('#cash-exp-date')?.value || uploadDate;
      const particulars = root.querySelector('#cash-particulars')?.value?.trim() || '';
      const workOrderNo = root.querySelector('#cash-wo')?.value || '';
      const remarks = root.querySelector('#cash-remarks')?.value?.trim() || '';
      const amt = parseFloat(root.querySelector('#cash-amount')?.value || '0') || 0;
      if (!particulars || !(amt>0)) { alert('Enter Particulars and a positive Amount.'); return; }
      if (remarks && remarks.length>0 && remarks.length < 50) { alert('Remarks should be at least 50 characters (or leave it empty).'); return; }
      const fd = new FormData();
      fd.append('items', JSON.stringify([{ date: expenseDate, particulars, amount: amt, remarks }]));
      fd.append('upload_date', uploadDate);
      fd.append('expense_date', expenseDate);
      if (workOrderNo) fd.append('work_order_no', workOrderNo);
      const billFile = root.querySelector('#cash-bill')?.files?.[0];
      if (!billFile) { alert('Please upload the bill file for this Expense voucher.'); return; }
      fd.append('bill', billFile);
      try {
        const res = await fetch('/api/vouchers/expense/create/', { method: 'POST', body: fd });
        const js = await res.json();
        if (!res.ok || !js.ok) { console.error(js); alert('Save failed: ' + (js.error || `HTTP ${res.status}`)); return; }
        const total = js.data?.total_amount ?? amt;
        const claim = root.querySelector('.claim')?.value || '';
        if (typeof addVoucher === 'function') { addVoucher({ type:'expense', date: expenseDate, amount: String(total), workorder: workOrderNo, remarks, claimNo: claim, files: [] }); if (typeof renderVoucherTable==='function') renderVoucherTable(); }
        alert(`Saved! Voucher ${js.data?.voucher_id || claim} (Total ? ${total})`);
        if (typeof closeModal === 'function') closeModal();
      } catch(err) { console.error(err); alert('Network error while saving.'); }
    });
  }
}
/* ===== Ledger ===== */
    const ledgerBody=document.getElementById('ledgerBody');
    function fmtInt(n){ const num=parseInt((n||0),10); return isNaN(num)?'0':num.toLocaleString() }
    function renderLedgerRows(rows){
      ledgerBody.innerHTML=''; const max=10; let debitSum=0, creditSum=0;
      for(let i=0;i<max;i++){
        const r=rows[i]||{date:'',voucher:'',debit:'',credit:'',remarks:''};
        const d=parseInt(r.debit||0,10)||0; const c=parseInt(r.credit||0,10)||0;
        debitSum+=d; creditSum+=c;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${r.date||''}</td><td>${r.voucher||''}</td>
                      <td class="number">${r.debit?fmtInt(r.debit):''}</td>
                      <td class="number">${r.credit?fmtInt(r.credit):''}</td>
                      <td>${r.remarks||''}</td>`;
        ledgerBody.appendChild(tr);
      }
      document.getElementById('lb-debit').textContent=fmtInt(debitSum);
      document.getElementById('lb-credit').textContent=fmtInt(creditSum);
      document.getElementById('lt-debit').textContent=fmtInt(debitSum);
      document.getElementById('lt-credit').textContent=fmtInt(creditSum);
      document.getElementById('lt-balance').textContent=fmtInt(creditSum - debitSum);
    }
    function fillSampleLedger(){
      const rows=[
        {date:'30-06-2025', voucher:'OPENING BALANCE', debit:103941, credit:'', remarks:'TILL DATE C/F'},
        {date:'16-08-2025', voucher:'H-PV-001', debit:1500, credit:''},
        {date:'18-08-2025', voucher:'H-PR-008', debit:'', credit:5000},
      ];
      renderLedgerRows(rows);
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      populateSelect("#supplier_id", "/api/suppliers/", item => ({
        value: item.supplier_id,
        text: item.name || ("Supplier #" + item.supplier_id)
      }));

      populateSelect("#work_order_no", "/api/projects/", item => ({
        value: item.work_order_no,
        text: item.project_name ? `${item.work_order_no}` : item.work_order_no
      }));
    });

    async function populateSelect(selector, url, mapItem) {
      const el = document.querySelector(selector);
      if (!el) return;

      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const prev = el.value;
        el.innerHTML = `<option value="">-- Select --</option>`;
        for (const it of data) {
          const { value, text } = mapItem(it);
          const opt = document.createElement("option");
          opt.value = value ?? "";
          opt.textContent = text ?? "";
          el.appendChild(opt);
        }
        if (prev) el.value = prev;
      } catch (err) {
        console.error("Failed to load", url, err);
        el.innerHTML = `<option value="">Failed to load</option>`;
      }
    }

  
    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
  {% comment %} <script>
  document.addEventListener("DOMContentLoaded", () => {
    populateSelect("#supplier_id", "/api/suppliers/", item => ({
      value: item.supplier_id,
      text: item.name || ("Supplier #" + item.supplier_id)
    }));

    populateSelect("#work_order_no", "/api/projects/", item => ({
      value: item.work_order_no,
      text: item.project_name
            ? `${item.work_order_no} ‚Äî ${item.project_name}`
            : item.work_order_no
    }));
  });

  async function populateSelect(selector, url, mapItem) {
    const el = document.querySelector(selector);
    if (!el) return; // quietly exit if the select isn't on this page

    try {
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // Preserve any preselected value (useful after validation errors)
      const prev = el.value;
      el.innerHTML = `<option value="">Select‚Ä¶</option>`;

      for (const it of data) {
        const { value, text } = mapItem(it);
        const opt = document.createElement("option");
        opt.value = value ?? "";
        opt.textContent = text ?? "";
        el.appendChild(opt);
      }

      if (prev) el.value = prev; // restore selection if possible
    } catch (err) {
      console.error("Failed to load", url, err);
      el.innerHTML = `<option value="">Failed to load</option>`;
    }
  }
  
    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script> {% endcomment %}


<script>
function openBillFor(i){
  try{
    const arr = (typeof loadV === 'function') ? loadV() : [];
    const item = Array.isArray(arr) ? arr[i] : null;
    if(!item){ alert('No data for this row'); return; }
    const type = item.type || 'purchase';
    const vid  = item.voucher_id || item.claimNo || item.id;
    if(vid){
      const url = `/api/files/${type}/voucher/${vid}/`;
      window.open(url, '_blank'); return;
    }
    const files = item.fileUrls || item.bills || [];
    if(files.length){ window.open(files[0], '_blank'); return; }
    alert('No bill available for this entry yet.');
  }catch(err){ console.error(err); alert('Unable to open bill.'); }
}
(function () {
  function fmt(d){ return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  function setBillDateWindow(){
    const el = document.getElementById('pv-billdate');
    if(!el) return;
    const today = new Date();
    const min   = new Date(); min.setDate(today.getDate() - 2);    // day-before-yesterday
    el.min = fmt(min);
    el.max = fmt(today);                                           // include TODAY
    // Default to today if empty/out of range
    if (!el.value || el.value < el.min || el.value > el.max) el.value = fmt(today);
  }
  document.addEventListener('DOMContentLoaded', setBillDateWindow);
  // If your purchase form opens in a modal, re-apply when the modal content appears:
  document.addEventListener('click', function(e){
    if (e.target && (e.target.dataset?.type === 'purchase')) {
      setTimeout(setBillDateWindow, 0);
    }
  });
})();


    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
(function(){
  // Helper: attach when the travel wizard is opened
  const _orig = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    const res = _orig ? _orig.apply(this, arguments) : undefined;
    if(vtype !== 'travel') return res;

    try{
      const modalBody = document.getElementById('modal-body') || document.body;
      const form = modalBody.querySelector('#travelForm') || document.getElementById('travelForm');
      const expPanel = modalBody.querySelector('#uv-step3-content'); // expenses container
      if(!form) return res;

      // 1) Auto-increment Sl No in (A) Travel Fare
      const sl = form.querySelector('#fare-sl');
      if(sl && !sl.value) sl.value = '1';
      const addFareBtn = expPanel?.querySelector('[data-addentry="fare"]') || form.querySelector('[data-addentry="fare"]');
      if(addFareBtn){
        addFareBtn.addEventListener('click', ()=>{
          const cur = parseInt(form.querySelector('#fare-sl')?.value || '1', 10) || 1;
          form.querySelector('#fare-sl').value = String(cur + 1);
          // optional: clear fields for next entry
          ['#fare-from','#fare-to','#fare-dep-date','#fare-dep-time','#fare-arr-date','#fare-arr-time','#fare-amt','#fare-km','#fare-file'].forEach(sel=>{
            const el = form.querySelector(sel); if(el) el.value = (el.type==='file' ? '' : '');
          });
          const m = form.querySelector('#fare-mode'); if(m) m.selectedIndex = 0;
        });
      }

      // 2) Mode logic: Amount vs KM enable/disable
      const modeSel = form.querySelector('#fare-mode');
      const amt = form.querySelector('#fare-amt');
      const km  = form.querySelector('#fare-km');
      function syncMode(){
        const m = (modeSel?.value || '').toLowerCase();
        const dist = (m === 'bike' || m === 'car');
        if(km){ km.disabled = !dist; if(!dist) km.value=''; }
        if(amt){ amt.disabled = dist; if(dist) amt.value=''; }
      }
      modeSel && modeSel.addEventListener('change', syncMode); syncMode();

      // 3) Populate transport Mode from backend if available, else keep defaults
      (async function(){
        try{
          const sel = modeSel;
          if(!sel) return;
          // If already has our default entries beyond placeholder, keep
          const already = sel.options.length > 2;
          if(already) return;
          const r = await fetch('/api/master/transport_modes/', {headers:{'Accept':'application/json'}});
          if(!r.ok) return;
          const data = await r.json();
          if(!Array.isArray(data) || !data.length) return;
          const cur = sel.value;
          sel.innerHTML = '<option value="" selected disabled>-- Select Mode --</option>';
          for(const it of data){
            const name = it.mode_of_transport || it.mode || it.name; if(!name) continue;
            const o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o);
          }
          if(cur) sel.value = cur;
        }catch(e){ /* ignore */ }
      })();

      // 4) Daily & Food Allowance: auto-calc No of Days (inclusive)
      const daFrom = form.querySelector('#da-from');
      const daTo   = form.querySelector('#da-to');
      const daDays = form.querySelector('#da-days');
      function calcDays(){
        const a = daFrom?.value, b = daTo?.value;
        if(!a || !b){ if(daDays) daDays.value=''; return; }
        const d1 = new Date(a+'T00:00:00'); const d2 = new Date(b+'T00:00:00');
        const ms = d2 - d1; if(ms < 0){ daDays.value='0'; return; }
        daDays.value = String(Math.floor(ms/(24*3600*1000))+1);
      }
      daFrom && daFrom.addEventListener('change', calcDays);
      daTo && daTo.addEventListener('change', calcDays);

      // 5) Details dropdowns: W.O / Purpose / Authorised By
      (async function(){
        try{
          const wo = form.querySelector('#tv-wo');
          if(wo && wo.tagName === 'SELECT'){
            let rows=[];
            try{
              const r=await fetch('/api/projects/',{headers:{'Accept':'application/json'}});
              if(r.ok) rows = await r.json();
            }catch(_){}
            wo.innerHTML = '<option value="">-- Select --</option>';
            if(Array.isArray(rows) && rows.length){
              for(const it of rows){
                const val = it.work_order_no ?? it.id ?? '';
                const label = it.project_name ? `${it.work_order_no} ‚Äî ${it.project_name}` : (it.work_order_no || 'W.O');
                const o=document.createElement('option'); o.value=val; o.textContent=label; wo.appendChild(o);
              }
            }else{
              ['WO-001','WO-002','WO-003'].forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; wo.appendChild(o); });
            }
          }

          let master=[];
          try{
            const r2=await fetch('/api/master/travel/',{headers:{'Accept':'application/json'}});
            if(r2.ok) master = await r2.json();
          }catch(_){}

          const pSel = form.querySelector('#tv-purpose');
          const aSel = form.querySelector('#tv-auth');
          const purposes = new Set(); const auths = new Set();
          for(const it of (Array.isArray(master)? master : [])){
            if(it.purpose_journey) purposes.add(it.purpose_journey);
            if(it.visit_authoriser_name) auths.add(it.visit_authoriser_name);
          }
          if(pSel && pSel.tagName==='SELECT'){
            pSel.innerHTML = '<option value="">-- Select --</option>';
            (purposes.size? [...purposes] : ['Client Visit','Site Inspection','Training','Meeting']).forEach(v=>{
              const o=document.createElement('option'); o.value=v; o.textContent=v; pSel.appendChild(o);
            });
          }
          if(aSel && aSel.tagName==='SELECT'){
            aSel.innerHTML = '<option value="">-- Select --</option>';
            (auths.size? [...auths] : ['Manager','Department Head','HR','Admin']).forEach(v=>{
              const o=document.createElement('option'); o.value=v; o.textContent=v; aSel.appendChild(o);
            });
            // Replace with actual higher-ups, if available
            try{
              const r3 = await fetch('/api/employees/managers/');
              if(r3.ok){
                const arr = await r3.json();
                const names = (Array.isArray(arr)?arr:[]).map(x=>x.name).filter(Boolean);
                if(names.length){
                  aSel.innerHTML = '<option value="">-- Select --</option>';
                  names.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; aSel.appendChild(o); });
                }
              }
            }catch(_){/* ignore */}
          }
        }catch(e){ /* ignore */ }
      })();
    }catch(err){ console.warn('travel patch failed', err); }

    return res;
  };
})();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
(function(){
  // Wrap the existing hook; if not present, we still add submit.
  const _open = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    // If not travel, just pass through
    if(vtype !== 'travel') return _open ? _open.apply(this, arguments) : undefined;
    // If newer wiring is enabled, let it handle everything (and still open the modal once via newer wrapper)
    if (window.__DISABLE_LEGACY_TRAVEL_WIRING__) return _open ? _open.apply(this, arguments) : undefined;
    const ret = _open ? _open.apply(this, arguments) : undefined;

    try{
      const shell = document.getElementById('modal-body');
      const detailsForm = shell.querySelector('#travelForm');

      // We'll maintain state (and store Files per entry)
      const state = { fare:[], local:[], hotel:[], da:[], misc:[] };

      // Helper query
      const q = sel => shell.querySelector(sel);
      const fmt2 = n => (n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      const num = t => { const n=parseFloat(String(t).replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; };

      // ---- Hook your existing Add Entry buttons to also keep Files ----
      // Travel Fare
      const fareMode = q('#fare-mode');
      function syncFareMode(){
        const m=(fareMode?.value||'').toLowerCase();
        const km=q('#fare-km'), amt=q('#fare-amt');
        if(km){ km.disabled = !(m==='car'||m==='bike'); if(km.disabled) km.value=''; }
        if(amt){ amt.disabled = (m==='car'||m==='bike'); if(amt.disabled) amt.value=''; }
      }
      fareMode && fareMode.addEventListener('change', syncFareMode); syncFareMode();

      q('[data-addentry="fare"]')?.addEventListener('click', ()=>{
        const from = q('#fare-from')?.value?.trim();
        const to   = q('#fare-to')?.value?.trim();
        const dep  = q('#fare-dep')?.value || '';
        const arr  = q('#fare-arr')?.value || '';
        const mode = fareMode?.value || '';
        const kmv  = q('#fare-km')?.value || '';
        const amtv = q('#fare-amt')?.value || '';
        const files = [...(q('#fare-file')?.files || [])];   // keep File objects

        if(!from || !to || !dep || !arr || !mode){ alert('Fill From, To, Departure, Arrival, Mode.'); return; }
        if(files.length === 0){ alert('Please attach at least one bill file for Travel Fare.'); return; }
        const isDist = ['car','bike'].includes((mode||'').toLowerCase());
        if(isDist && !(parseFloat(kmv)>0)) { alert('Enter KM for Bike/Car'); return; }
        if(!isDist && !(parseFloat(amtv)>0)) { alert('Enter Amount for this mode'); return; }

        state.fare.push({from, to, dep, arr, mode, km: kmv?parseFloat(kmv):null, amount: amtv?parseFloat(amtv):0, files});
        function renderFareTable(){
          const tbody = q('#fare-table tbody');
          if(!tbody) return;
          tbody.innerHTML = '';
          state.fare.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${idx+1}</td>
              <td>${row.from}</td>
              <td>${row.to}</td>
              <td>${row.dep}</td>
              <td>${row.arr}</td>
              <td>${row.mode}</td>
              <td>${row.km ?? ''}</td>
              <td>${fmt2(row.amount)}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        renderFareTable();

        // update summary
        const sumFare = state.fare.reduce((s,it)=> s+(it.amount||0),0);
        q('#sum-fare').textContent = fmt2(sumFare);
        const totals = ['#sum-fare','#sum-local','#sum-hotel','#sum-da','#sum-misc'].map(sel => num(q(sel)?.textContent||'0'));
        q('#sum-total').textContent = fmt2(totals.reduce((a,b)=>a+b,0));

        // clear
        ['#fare-from','#fare-to','#fare-km','#fare-amt'].forEach(s=>{ const el=q(s); if(el) el.value=''; });
        if(q('#fare-dep')) q('#fare-dep').value='';
        if(q('#fare-arr')) q('#fare-arr').value='';
        if(fareMode) fareMode.selectedIndex=0;
        const f=q('#fare-file'); if(f) f.value='';
        syncFareMode();
      });

      // Local Travel
      const localMode = q('#local-mode');
      function syncLocalMode(){
        const m=(localMode?.value||'').toLowerCase();
        const km=q('#local-km'), amt=q('#local-amt');
        if(km){ km.disabled = !(m==='car'||m==='bike'); if(km.disabled) km.value=''; }
        if(amt){ amt.disabled = (m==='car'||m==='bike'); if(amt.disabled) amt.value=''; }
      }
      localMode && localMode.addEventListener('change', syncLocalMode); syncLocalMode();

      q('[data-addentry="local"]')?.addEventListener('click', ()=>{
        const date = q('#local-date')?.value || '';
        const frm  = q('#local-from')?.value?.trim();
        const to   = q('#local-to')?.value?.trim();
        const mode = localMode?.value || '';
        const kmv  = q('#local-km')?.value || '';
        const amtv = q('#local-amt')?.value || '';
        const files = [...(q('#local-file')?.files || [])];

        if(!date || !frm || !to || !mode){ alert('Fill Date, From, To, Mode.'); return; }
        if(files.length === 0){ alert('Please attach at least one bill file for Local Travel.'); return; }
        const isDist = ['car','bike'].includes((mode||'').toLowerCase());
        if(isDist && !(parseFloat(kmv)>0)) { alert('Enter KM for Bike/Car'); return; }
        if(!isDist && !(parseFloat(amtv)>0)) { alert('Enter Amount'); return; }

        state.local.push({date, from: frm, to, mode, km: kmv?parseFloat(kmv):null, amount: amtv?parseFloat(amtv):0, files});

        const sumLocal = state.local.reduce((s,it)=> s+(it.amount||0),0);
        q('#sum-local').textContent = fmt2(sumLocal);
        const totals = ['#sum-fare','#sum-local','#sum-hotel','#sum-da','#sum-misc'].map(sel => num(q(sel)?.textContent||'0'));
        q('#sum-total').textContent = fmt2(totals.reduce((a,b)=>a+b,0));

        ['#local-date','#local-from','#local-to','#local-km','#local-amt','#local-file'].forEach(s=>{ const el=q(s); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
        syncLocalMode();
      });

      // Hotel
      q('[data-addentry="hotel"]')?.addEventListener('click', ()=>{
        const checkin  = q('#hotel-checkin')?.value || '';
        const checkout = q('#hotel-checkout')?.value || '';
        const name     = q('#hotel-name')?.value?.trim();
        const address  = q('#hotel-address')?.value?.trim();
        const amtv     = q('#hotel-amt')?.value || '';
        const files    = [...(q('#hotel-file')?.files || [])];

        if(!checkin || !checkout || !name || !address){ alert('Fill Check-in, Check-out, Hotel Name, Address'); return; }
        if(files.length === 0){ alert('Please attach at least one bill file for Hotel Accommodation.'); return; }
        state.hotel.push({checkin, checkout, name, address, amount: amtv?parseFloat(amtv):0, files});

        const sumHotel = state.hotel.reduce((s,it)=> s+(it.amount||0),0);
        q('#sum-hotel').textContent = fmt2(sumHotel);
        const totals = ['#sum-fare','#sum-local','#sum-hotel','#sum-da','#sum-misc'].map(sel => num(q(sel)?.textContent||'0'));
        q('#sum-total').textContent = fmt2(totals.reduce((a,b)=>a+b,0));

        ['#hotel-checkin','#hotel-checkout','#hotel-name','#hotel-amt','#hotel-address','#hotel-file'].forEach(s=>{ const el=q(s); if(el) el.value=''; });
      });

      // DA / Misc already update the summary (no files).


      // ===== Daily & Food Allowance =====
      q('[data-addentry="da"]')?.addEventListener('click', async ()=>{
        const from = q('#da-from')?.value || '';
        const to   = q('#da-to')?.value || '';
        const ndEl = q('#da-days');
        const _days = (a,b)=>{ if(!a||!b) return 0; const d1=new Date(a+'T00:00:00'), d2=new Date(b+'T00:00:00'); return Math.floor((d2-d1)/86400000)+1; };
        const nd = _days(from,to);
        if(!(from && to && nd>0)){ alert('Pick valid From/To for DA/FA.'); return; }

        // Fetch per-day rate to show live amount (server recomputes anyway)
        let perDay = 0;
        try {
          const purpose = q('#tv-purpose')?.value || '';
          const r = await fetch(`/api/master/travel/rate/?purpose=${encodeURIComponent(purpose)}`);
          if (r.ok) { const j = await r.json(); perDay = Number(j?.data?.food_per_day || 0); }
        } catch(_){}
        const amount = Math.max(0, Math.round((perDay * nd) * 100)/100);

        state.da.push({ from, to, number_days: nd, amount });
        if (ndEl) ndEl.value = nd;

        const sumDA = state.da.reduce((s,it)=> s+(Number(it.amount)||0),0);
        q('#sum-da').textContent = fmt2(sumDA);
        const totals = ['#sum-fare','#sum-local','#sum-hotel','#sum-da','#sum-misc'].map(sel => num(q(sel)?.textContent||'0'));
        q('#sum-total').textContent = fmt2(totals.reduce((a,b)=>a+b,0));

        ['#da-from','#da-to'].forEach(sel => { const el=q(sel); if(el) el.value=''; });
        if (ndEl) ndEl.value = '';
      });

      // ===== Miscellaneous Expenses =====
      q('[data-addentry="misc"]')?.addEventListener('click', ()=>{
        const date = q('#misc-date')?.value || '';
        const particulars = q('#misc-particulars')?.value?.trim() || '';
        const amtv = q('#misc-amt')?.value || '';
        const files = [...(q('#misc-file')?.files || [])];
        if(!(date && particulars && parseFloat(amtv)>0)){
          alert('Enter Date, Particulars, and a positive Amount for Misc.'); return;
        }
        if(files.length === 0){ alert('Please attach at least one bill file for Miscellaneous Expenses.'); return; }
        const amount = parseFloat(amtv);
        state.misc.push({ date, particulars, amount, files });

        const sumMisc = state.misc.reduce((s,it)=> s+(Number(it.amount)||0),0);
        q('#sum-misc').textContent = fmt2(sumMisc);
        const totals = ['#sum-fare','#sum-local','#sum-hotel','#sum-da','#sum-misc'].map(sel => num(q(sel)?.textContent||'0'));
        q('#sum-total').textContent = fmt2(totals.reduce((a,b)=>a+b,0));

        ['#misc-date','#misc-amt'].forEach(sel => { const el=q(sel); if(el) el.value=''; });
        const selHead=q('#misc-particulars'); if (selHead && selHead.tagName==='SELECT') selHead.selectedIndex=0;
        const f=q('#misc-file'); if(f) f.value='';
      });
      // ---- SUBMIT: send details + arrays + files to backend ----
      let submit = shell.querySelector('#uv-submit-travel');
      if(!submit){
        submit = document.createElement('button');
        submit.id = 'uv-submit-travel';
        submit.type = 'button';
        submit.className = 'uv-btn primary';
        submit.textContent = 'Submit';
        shell.querySelector('.uv-nav')?.appendChild(submit);
      }

      submit.addEventListener('click', async ()=>{
        // Validate top Details tab
        const proj = q('#tv-wo')?.value || q('#tv-wo')?.textContent || '';  // project/work order
        const place = q('#tv-place')?.value || '';
        const purpose = q('#tv-purpose')?.value || '';
        const auth = q('#tv-auth')?.value || '';
        const fromd = q('#tv-from')?.value || '';
        const tod   = q('#tv-to')?.value || '';
        if(!(proj && place && purpose && fromd && tod)){ alert('Fill required details (Project/Place/Purpose/From/To).'); return; }

        // Ensure mandatory files for filled sections
        const missing = [];
        if (state.fare.some(r => !r.files || r.files.length===0)) missing.push('Travel Fare');
        if (state.local.some(r => !r.files || r.files.length===0)) missing.push('Local Travel');
        if (state.hotel.some(r => !r.files || r.files.length===0)) missing.push('Hotel Accommodation');
        if (state.misc.some(r => !r.files || r.files.length===0)) missing.push('Miscellaneous Expenses');
        if (missing.length){ alert('Please attach bill files for: ' + missing.join(', ')); return; }

        // Build FormData
        const fd = new FormData();
        // Voucher-level fields for backend compatibility
        fd.append('work_order_no', proj);
        const updt = q('#tv-date')?.value || new Date().toISOString().slice(0,10);
        fd.append('upload_date', updt);
        fd.append('expense_date', updt);
        fd.append('voucher_type', 'TRAVEL');
        try{ if(typeof getUsername==='function'){ fd.append('username', getUsername()||''); } }catch(_){}

        // Travel header fields
        fd.append('projectname', proj);
        fd.append('place', place);
        fd.append('purpose_journey', purpose);
        fd.append('visit_authorised', auth);
        fd.append('from_date', fromd);
        fd.append('to_date', tod);

        // Keep a file-less shadow to store as JSON arrays
        const fareNoFiles  = state.fare.map((it,idx)=>({from:it.from,to:it.to,dep:it.dep,arr:it.arr,mode:it.mode,km:it.km,amount:it.amount,index:idx}));
        const localNoFiles = state.local.map((it,idx)=>({date:it.date,from:it.from,to:it.to,mode:it.mode,km:it.km,amount:it.amount,index:idx}));
        const hotelNoFiles = state.hotel.map((it,idx)=>({checkin:it.checkin,checkout:it.checkout,name:it.name,address:it.address,amount:it.amount,index:idx}));

        fd.append('travel_fare',           JSON.stringify(fareNoFiles));
        fd.append('local_fare',            JSON.stringify(localNoFiles));
        fd.append('hotel_accomodation',    JSON.stringify(hotelNoFiles));
        fd.append('food',                  JSON.stringify(state.da));
        fd.append('miscellaneous_expenses',JSON.stringify(state.misc));


        // Attach files using predictable keys the backend expects
        state.fare.forEach((it,idx)=> (it.files||[]).forEach(f => fd.append(`fare_files_${idx}`, f)));
        state.local.forEach((it,idx)=> (it.files||[]).forEach(f => fd.append(`local_files_${idx}`, f)));
        state.hotel.forEach((it,idx)=> (it.files||[]).forEach(f => fd.append(`hotel_files_${idx}`, f)));
        state.misc.forEach((it,idx)=> (it.files||[]).forEach(f => fd.append(`misc_files_${idx}`, f)));

        try{
          const res = await fetch('/api/vouchers/travel/save/', { method:'POST', body: fd });
          const js  = await res.json().catch(()=> ({}));
          if(!res.ok || !js.ok){ console.error(js); alert('Save failed: '+(js.error||`HTTP ${res.status}`)); return; }

          const total   = js.data?.total_amount ?? 0;
          const claimNo = detailsForm.querySelector('.claim')?.value || '';
          // Add to local table (like purchase flow)
          if(typeof addVoucher === 'function'){
            addVoucher({ type:'travel', date: fromd, amount: String(Number(total).toFixed(2)), claimNo, files: [] });
            if(typeof renderVoucherTable === 'function') renderVoucherTable();
          }
          alert(`Saved! Travel ID ${js.data.travel_id} (Total ‚Çπ ${Number(total).toFixed(2)})`);
          if(typeof closeModal === 'function') closeModal();
        }catch(err){
          console.error(err); alert('Network error while saving.');
        }
      });

    }catch(e){ console.warn('Travel submit patch failed', e); }

    return ret;
  };
})();

(function(){
  const _open = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    const ret = _open ? _open.apply(this, arguments) : undefined;
    if (vtype !== 'cash') return ret;   // only wire when Expense is opened

    try{
      const shell = document.getElementById('modal-body');
      const form  = shell.querySelector('#cashForm, #expenseForm');
      if (!form) return ret;

      const dateEl = form.querySelector('#cash-date');
      const headEl = form.querySelector('#cash-head');
      const amtEl  = form.querySelector('#cash-amount');
      const tbody  = form.querySelector('#cashItemsBody');
      const totalSpan  = form.querySelector('#cashTotal');
      const totalInput = form.querySelector('#cashTotalInput');

      // Intercept the "Add to Table" submit of the expense form
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const dt   = (dateEl?.value || '').trim();
        const head = (headEl?.value || '').trim();
        const amtV = amtEl?.value || '';
        const amt  = parseFloat(amtV);

        if (!dt || !head || !(amt > 0)) {
          alert('Please enter Date, Particulars and a positive Amount.');
          return;
        }

        // Remove "No items added." placeholder if present
        const placeholder = tbody.querySelector('.muted')?.closest('tr');
        if (placeholder) placeholder.remove();

        // Append a new row (Date, Particulars, Amount)
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${dt}</td>
          <td>${head}</td>
          <td class="right">‚Çπ ${amt.toFixed(2)}</td>`;
        tbody.appendChild(tr);

        // Update totals
        const currentTotal = parseFloat((totalSpan?.textContent || '0').replace(/[^\d.]/g,'')) || 0;
        const newTotal = currentTotal + amt;
        if (totalSpan)  totalSpan.textContent = newTotal.toFixed(2);
        if (totalInput) totalInput.value = newTotal.toFixed(2);

        // Clear inputs for next entry
        if (dateEl) dateEl.value = '';
        if (headEl) headEl.selectedIndex = 0;
        if (amtEl)  amtEl.value = '';
        dateEl?.focus();
      });
    }catch(err){ console.error(err); }

    return ret;
  };
})();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Elements ‚Äì adjust IDs to match your current HTML
  const projectSelect = document.getElementById("tv-wo");          // Project / WO dropdown
  const nameInput     = document.getElementById("tv-name");        // Name (readonly)
  const desigInput    = document.getElementById("tv-desig"); // Designation/Role (readonly)
  const purposeSelect = document.getElementById("tv-purpose");     // Purpose of journey dropdown
  const authSelect    = document.getElementById("tv-auth");        // Visit authorised by dropdown

  // Helper: fill a <select> with options
  function fillSelect(selectEl, items, placeholder="Select...") {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);
    (items || []).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
  }

  // 1) Projects dropdown
  fetch("/api/projects/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      // Expecting an array; map to project_name (adjust if your key differs)
      const names = (Array.isArray(data) ? data : data?.results || []).map(p => p.project_name || p.name || p.work_order_no || "");
      fillSelect(projectSelect, names.filter(Boolean), "Select Project / WO");
    })
    .catch(() => { /* optionally show toast */ });

  // 2) Employee name + designation (from session)
  fetch("/api/auth/me/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(me => {
      if (nameInput)  nameInput.value  = me.name || "";
      if (desigInput) desigInput.value = me.designation || "";
    })
    .catch(() => {});

  // 3) Purpose + Visit Authorised dropdowns (robust to API shapes)
  fetch("/api/master/travel/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      let purposes = [];
      let authors  = [];

      if (Array.isArray(data)) {
        const pSet = new Set();
        const aSet = new Set();
        for (const it of data) {
          const p = (it?.purpose || it?.purpose_name || it?.purpose_journey || "").toString().trim();
          const a = (it?.visit_authorised || it?.visit_authoriser_name || it?.authorised_by || it?.authoriser || "").toString().trim();
          if (p) pSet.add(p);
          if (a) aSet.add(a);
        }
        purposes = [...pSet];
        authors  = [...aSet];
      } else if (data && typeof data === 'object') {
        const toArr = v => Array.isArray(v) ? v : (v ? [v] : []);
        purposes = toArr(data.purpose_journey || data.purpose || data.purpose_name).filter(Boolean);
        authors  = toArr(data.visit_authoriser_name || data.visit_authorised || data.authorised_by).filter(Boolean);
      }

      if (!purposes.length) purposes = ["Client Visit","Site Inspection","Training","Meeting"];
      if (!authors.length)  authors  = ["Manager","Department Head","HR","Admin"];

      fillSelect(purposeSelect, purposes, "Select Purpose");
      fillSelect(authSelect, authors,  "Select Authoriser");
    })
    .catch(() => {
      // Fallback defaults if API fails
      fillSelect(purposeSelect, ["Client Visit","Site Inspection","Training","Meeting"], "Select Purpose");
      fillSelect(authSelect,    ["Manager","Department Head","HR","Admin"],           "Select Authoriser");
    });
});

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== Elements (IDs match your dashboard.html) =====
  const elProject   = document.getElementById("tv-wo");
  const elName      = document.getElementById("tv-name");
  const elDesig     = document.getElementById("tv-desig");
  const elPurpose   = document.getElementById("tv-purpose");
  const elAuthBy    = document.getElementById("tv-auth");
  const elFrom      = document.getElementById("tv-from");
  const elTo        = document.getElementById("tv-to");

  // Daily & Food Allowance
  const daFrom      = document.getElementById("da-from");
  const daTo        = document.getElementById("da-to");
  const daDays      = document.getElementById("da-days");

  function fillSelect(selectEl, items, placeholder="-- Select --") {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = placeholder;
    selectEl.appendChild(opt0);
    (items || []).forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      selectEl.appendChild(o);
    });
  }

  // Projects (from /api/projects/)
  fetch("/api/projects/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(arr => {
      // Your endpoint returns [{work_order_no: "..."}]
      const items = (Array.isArray(arr)?arr:[]).map(x => x.work_order_no).filter(Boolean);
      fillSelect(elProject, items, "Select Project / W.O #");
    }).catch(()=>{});

  // Name/Designation from session
  fetch("/api/auth/me/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(me => {
      if (elName)  elName.value  = me.name || "";
      if (elDesig) elDesig.value = me.designation || "";
    }).catch(()=>{});

  // Purpose & Authoriser (from master_travel) - robust parsing + defaults
  fetch("/api/master/travel/")
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      let purposes = [];
      let authors  = [];
      if (Array.isArray(data)) {
        const pSet = new Set();
        const aSet = new Set();
        for (const it of data) {
          const p = (it?.purpose || it?.purpose_name || it?.purpose_journey || "").toString().trim();
          const a = (it?.visit_authorised || it?.visit_authoriser_name || it?.authorised_by || it?.authoriser || "").toString().trim();
          if (p) pSet.add(p);
          if (a) aSet.add(a);
        }
        purposes = [...pSet];
        authors  = [...aSet];
      } else if (data && typeof data === 'object') {
        const toArr = v => Array.isArray(v) ? v : (v ? [v] : []);
        purposes = toArr(data.purpose_journey || data.purpose || data.purpose_name).filter(Boolean);
        authors  = toArr(data.visit_authoriser_name || data.visit_authorised || data.authorised_by).filter(Boolean);
      }
      if (!purposes.length) purposes = ["Client Visit","Site Inspection","Training","Meeting"];
      if (!authors.length)  authors  = ["Manager","Department Head","HR","Admin"];
      fillSelect(elPurpose, purposes, "Select Purpose");
      fillSelect(elAuthBy,  authors,  "Select Authoriser");
      // Try to replace Authoriser list with actual managers (higher posts)
      fetch("/api/employees/managers/")
        .then(r => r.ok ? r.json() : [])
        .then(arr => {
          try{
            const names = (Array.isArray(arr)?arr:[]).map(x => x.name).filter(Boolean);
            if(names.length){ fillSelect(elAuthBy, names, "Select Authoriser"); }
          }catch(e){ /* ignore */ }
        }).catch(()=>{});
    })
    .catch(()=>{
      fillSelect(elPurpose, ["Client Visit","Site Inspection","Training","Meeting"], "Select Purpose");
      fillSelect(elAuthBy,  ["Manager","Department Head","HR","Admin"],           "Select Authoriser");
    });

  // ===== Daily & Food Allowance: auto-calc No. of Days (inclusive) =====
  function recalcDays() {
    const a = daFrom?.value, b = daTo?.value;
    if (!a || !b) { if (daDays) daDays.value = ""; return; }
    const d1 = new Date(a + "T00:00:00"), d2 = new Date(b + "T00:00:00");
    const ms = d2 - d1;
    const days = Math.floor(ms/86400000) + 1; // inclusive
    daDays.value = isFinite(days) && days>0 ? days : "";
  }
  ["change","input"].forEach(ev => {
    daFrom?.addEventListener(ev, recalcDays);
    daTo?.addEventListener(ev, recalcDays);
  });
});

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
/* ---------------- Transport Modes cache ---------------- */
let TRANSPORT_MODES = {}; // { "Bike": {price: 4.5, uom:"km"}, ... }

async function loadTransportModes() {
  const r = await fetch("/api/master/transport_modes/");
  const data = await r.json();
  TRANSPORT_MODES = {};
  for (const m of data) {
    TRANSPORT_MODES[(m.mode_of_transport || "").trim()] = {
      price: Number(m.price || 0),
      uom: (m.UOM || "").toLowerCase()
    };
  }
}

/* Populate a <select> with options + data-price/uom */
function fillModeSelect(sel) {
  if (!sel) return;
  // Keep a placeholder if present
  const keepFirst = sel.querySelector("option[value='']") ? sel.querySelector("option[value='']").outerHTML : "<option value=''>-- Select --</option>";
  sel.innerHTML = keepFirst;
  for (const [mode, info] of Object.entries(TRANSPORT_MODES)) {
    const opt = document.createElement("option");
    opt.value = mode;
    opt.textContent = mode;
    opt.dataset.price = info.price;  // per-unit price
    opt.dataset.uom   = info.uom;    // e.g., 'km' or 'ticket'
    sel.appendChild(opt);
  }
}

/* Recalculate amount in a single Travel Fare row */
function recalcTravelAmount(row) {
  if (!row) return;
  // Try by name first; fall back to IDs commonly used in your forms
  const modeSel = row.querySelector('select[name="tf_mode"]') || row.querySelector('#tf-mode') || row.querySelector('[data-role="mode"]');
  const kmInput = row.querySelector('input[name="tf_km"]')    || row.querySelector('#tf-km')   || row.querySelector('[data-role="km"]');
  const amtInput= row.querySelector('input[name="tf_amount"]')|| row.querySelector('#tf-amount')|| row.querySelector('[data-role="amount"]');
  if (!modeSel || !amtInput) return;

  let price = 0, uom = "";
  const opt = modeSel.options[modeSel.selectedIndex];
  if (opt) {
    price = Number(opt.dataset.price || 0);
    uom   = (opt.dataset.uom || "").toLowerCase();
  }

  let qty = 1;
  if (uom === "km") {
    const km = Number((kmInput && kmInput.value) ? kmInput.value : 0);
    qty = isNaN(km) ? 0 : km;
  }

  const total = (price * qty) || 0;
  amtInput.value = total.toFixed(2);
}

/* Attach listeners to one Travel Fare row */
function wireTravelFareRow(row) {
  const modeSel = row.querySelector('select[name="tf_mode"]') || row.querySelector('#tf-mode') || row.querySelector('[data-role="mode"]');
  const kmInput = row.querySelector('input[name="tf_km"]')    || row.querySelector('#tf-km')   || row.querySelector('[data-role="km"]');
  if (modeSel)  modeSel.addEventListener('change', () => recalcTravelAmount(row));
  if (kmInput)  kmInput.addEventListener('input',  () => recalcTravelAmount(row));
  // initial calc if mode preselected
  recalcTravelAmount(row);
}

/* Initialize for existing + future rows */
document.addEventListener("DOMContentLoaded", async () => {
  await loadTransportModes();
  // 1) Fill any existing Travel Fare row's mode select
  document.querySelectorAll('#travel-fare .row, #travel-fare tr, .travel-fare-row').forEach(row => {
    const modeSel = row.querySelector('select[name="tf_mode"]') || row.querySelector('#tf-mode') || row.querySelector('[data-role="mode"]');
    if (modeSel) fillModeSelect(modeSel);
    wireTravelFareRow(row);
  });

  // 2) If you have an "Add Entry" for Travel Fare, call wireTravelFareRow(newRow) after inserting it.
  // Example:
  // document.getElementById('tf-add-entry').addEventListener('click', () => {
  //   const row = addTravelFareRowSomehow();  // your existing function that creates/appends a row
  //   fillModeSelect(row.querySelector('select[name="tf_mode"]'));
  //   wireTravelFareRow(row);
  // });
});

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
/* ensure transport modes are loaded (price, UOM) */
async function ensureTransportModes(){
  if (!Object.keys(window.TRANSPORT_MODES || {}).length) {
    try {
      const r = await fetch('/api/master/transport_modes/', {headers:{'Accept':'application/json'}});
      const data = await r.json();
      window.TRANSPORT_MODES = {};
      for (const m of data) {
        window.TRANSPORT_MODES[(m.mode_of_transport || '').trim()] = {
          price: Number(m.price || 0),
          uom: (m.UOM || '').toLowerCase()
        };
      }
    } catch(e) { /* ignore */ }
  }
}

/* compute amount based on mode‚Äôs price (per km or fixed) */
function recalcFareAmount(){
  const mode = (document.querySelector('#fare-mode')?.value || '').trim();
  const kmEl = document.querySelector('#fare-km');
  const amtEl= document.querySelector('#fare-amt');
  if (!amtEl || !mode) return;

  const info = (window.TRANSPORT_MODES || {})[mode] || {price:0,uom:''};
  const per = Number(info.price || 0);
  const uom = (info.uom || '').toLowerCase();

  let total = 0;
  if (uom === 'km') {
    const kms = parseFloat(kmEl?.value || '0') || 0;
    total = per * kms;
  } else {
    // fixed price modes (e.g., ticket-based)
    total = per || parseFloat(amtEl.value || '0') || 0;
  }
  // Only auto-fill when Bike/Car or when we have a known fixed price
  if (['bike','car'].includes(mode.toLowerCase()) || per > 0) {
    amtEl.value = total ? total.toFixed(2) : '';
  }
}

/* hook up events */
document.addEventListener('DOMContentLoaded', async () => {
  await ensureTransportModes();

  const fareMode = document.querySelector('#fare-mode');
  const fareKm   = document.querySelector('#fare-km');

  // If you kept a fetch to singular, switch it to plural:
  // (Change the existing fetch('/api/master/transport_modes/') line to the plural URL.)
  // Now compute whenever mode or km changes:
  fareMode && fareMode.addEventListener('change', async () => {
    await ensureTransportModes();
    recalcFareAmount();
  });
  fareKm && fareKm.addEventListener('input', recalcFareAmount);

  // initial compute in case fields are prefilled
  recalcFareAmount();
});

// --- Overwrite purchase flow: single Details panel + submit ---
(function(){
  const _orig = openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    if (vtype !== 'purchase') return _orig(vtype);
    const shell=document.createElement('div');
    const src = document.querySelector('#page-purchase-form .content-card');
    if(!src){ alert('Purchase form template not found.'); return; }
    shell.appendChild(src.cloneNode(true));
    openModal('Add Purchase Voucher', shell);

    const form = shell.querySelector('#purchaseForm');
    const claimSpan = shell.querySelector('.claim-text');
    const hiddenClaim = shell.querySelector('.claim');

    // Claim no preview and today date
    const seqPreview = (typeof previewSeq==='function') ? previewSeq('P') : 1;
    const claim = (typeof formatClaim==='function') ? formatClaim('P', seqPreview) : ('P-'+String(seqPreview).padStart(3,'0'));
    if (claimSpan) claimSpan.textContent = claim;
    if (hiddenClaim) hiddenClaim.value = claim;
    const todayISO = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
    const dateEl = form.querySelector('#pv-date'); if(dateEl) dateEl.value = todayISO;

    // Populate Work Orders (keeps user's existing populate function if present)
    if (typeof populateSelect === 'function') {
      populateSelect("#work_order_no", "/api/projects/", item => ({
        value: item.work_order_no,
        text: item.project_name ? `${item.work_order_no}` : item.work_order_no
      }));
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date        = form.querySelector('#pv-date')?.value || '';
      const billDate    = form.querySelector('#pv-billdate')?.value || '';
      const workOrderNo = form.querySelector('#work_order_no')?.value || '';
      const totalAmount = form.querySelector('#pv-total')?.value || '';
      const description = form.querySelector('#pv-description')?.value || '';
      const billFile    = form.querySelector('#pv-billfile')?.files?.[0] || null;
      if(!date || !billDate || !(parseFloat(totalAmount)>0)){
        alert('Please fill Date, Bill Date and a positive Total Amount.'); return;
      }
      if(!billFile){ alert('Please upload the bill file for this Purchase voucher.'); return; }

      const seq = (typeof commitSeq==='function') ? commitSeq('P') : seqPreview;
      const finalClaim = (typeof formatClaim==='function') ? formatClaim('P', seq) : ('P-'+String(seq).padStart(3,'0'));
      if (hiddenClaim) hiddenClaim.value = finalClaim; if (claimSpan) claimSpan.textContent = finalClaim;

      const fd = new FormData();
      fd.append('date', date);
      fd.append('bill_date', billDate);
      fd.append('work_order_no', workOrderNo);
      fd.append('total_amount', totalAmount);
      fd.append('description', description);
      if (billFile) fd.append('bill', billFile);

      try {
        const res = await fetch('/api/vouchers/purchase/create/', { method:'POST', body:fd });
        const js  = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
        if (!res.ok || !js.ok) {
          console.error(js);
          alert('Save failed: ' + (js.error || `HTTP ${res.status}`));
          return;
        }
        const total = js.data?.total_amount || totalAmount || '0.00';
        // Add to local list (keeps UI table behavior)
        if (typeof addVoucher === 'function') {
          addVoucher({ type:'purchase', date, amount:String(total), workorder:workOrderNo, remarks:description, claimNo: finalClaim, files: [] });
          if (typeof renderVoucherTable === 'function') renderVoucherTable();
        }
        alert(`Saved! Voucher ${js.data.voucher_id || finalClaim} (Total ‚Çπ ${total})`);
        if (typeof closeModal === 'function') closeModal();
      } catch (err) {
        console.error(err);
        alert('Network error while saving.');
      }
    });
  };
})();


    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<script>
/** Convert "dd-mm-yyyy" or "dd/mm/yyyy" to "yyyy-mm-dd". Pass through ISO unchanged. */
function normalizeDMY(d) {
  if (!d) return "";
  // already ISO?
  if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  const m = d.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (!m) return d; // fallback: return as-is
  const [_, dd, mm, yyyy] = m;
  return `${yyyy}-${mm}-${dd}`;
}

async function submitPurchaseFromJson(voucherJson, purchaseJson, fileObj = null) {
  // 1) Normalize & sanitize incoming fields (be forgiving about typos)
  const billDate = normalizeDMY(
    voucherJson.billdate || voucherJson.bill_date || voucherJson.billDate
  );
  // Prefer explicit "uploddate" if given, otherwise default to today
  const uploadDateRaw = voucherJson.uploddate || voucherJson.uploaddate || voucherJson.upload_date;
  const todayISO = new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  const dateForVoucher = normalizeDMY(uploadDateRaw) || todayISO;

  const workOrder = voucherJson.worordernumber || voucherJson.workordernumber || voucherJson.work_order_no || voucherJson.work_order || "";
  const totalAmount = (voucherJson.total_amount ?? voucherJson.totalAmount ?? voucherJson.amount ?? "").toString().trim();
  const description = (purchaseJson.description || purchaseJson.desc || "").toString().replace(/^"+|"+$/g, ""); // strip stray quotes

  // 2) Get file to upload (priority: explicit arg > form input > none)
   let billFile = fileObj || null;
   if (!billFile) {
     const input = document.querySelector('#pv-billfile');
     if (input && input.files && input.files[0]) {
       billFile = input.files[0];
     } else if (purchaseJson.photo) {
       // We only have a filename string-cannot auto-read local files.
       // Leave null and let server accept no bill OR ask user to attach.
       console.warn('No actual File object available for photo:', purchaseJson.photo);
     }
   }
   if (!billFile) { alert('Please attach the bill file for this Purchase voucher before submitting.'); return; }

  // 3) Basic validation
  if (!billDate) { alert("Bill Date missing/invalid in JSON."); return; }
  if (!totalAmount || isNaN(parseFloat(totalAmount)) || parseFloat(totalAmount) <= 0) {
    alert("Total Amount missing/invalid in JSON."); return;
  }

  // 4) If your UI claim no helpers exist, create a minimal one
  if (typeof previewSeq !== 'function') {
    window.previewSeq = (code)=>parseInt(localStorage.getItem('seq_'+code)||'0',10)+1;
  }
  if (typeof commitSeq !== 'function') {
    window.commitSeq = (code)=>{ const k='seq_'+code; const n=parseInt(localStorage.getItem(k)||'0',10)+1; localStorage.setItem(k,String(n)); return n; };
  }
  if (typeof formatClaim !== 'function') {
    window.formatClaim = (code,seq)=> {
      const u=(document.body.dataset.username||voucherJson.username||'X')[0]||'X';
      return `${u.toUpperCase()}-${code}V-${String(seq).padStart(3,'0')}`;
    };
  }

  // 5) Claim number & form data
  const seq = commitSeq('P');
  const claimNo = formatClaim('P', seq);

  const fd = new FormData();
  // API contract based on your last file: these keys are expected
  fd.append('date', dateForVoucher);           // voucher date (upload/current date)
  fd.append('bill_date', billDate);            // bill date
  fd.append('work_order_no', workOrder);       // work order number
  fd.append('total_amount', totalAmount);      // total amount
  fd.append('description', description);       // description / remarks
  if (billFile) fd.append('bill', billFile);   // uploaded bill file
  // Optional extras if your backend accepts them (won't hurt if ignored):
  if (voucherJson.username) fd.append('username', voucherJson.username);
  if (voucherJson.vouchertype) fd.append('voucher_type', voucherJson.vouchertype);

  // 6) POST to backend
  try {
    const res = await fetch('/api/vouchers/purchase/create/', { method:'POST', body: fd });
    const js = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if (!res.ok || !js.ok) {
      console.error(js);
      alert('Save failed: ' + (js.error || `HTTP ${res.status}`));
      return;
    }

    const savedVoucherId = js.data?.voucher_id || claimNo;
    const savedTotal = js.data?.total_amount ?? totalAmount;

    // 7) Update table in UI (if your functions exist)
    if (typeof addVoucher === 'function') {
      addVoucher({
        type: 'purchase',
        date: dateForVoucher,
        amount: String(savedTotal),
        workorder: workOrder,
        remarks: description,
        claimNo: claimNo,
        files: []
      });
      if (typeof renderVoucherTable === 'function') renderVoucherTable();
    }

    alert(`Saved! Voucher ${savedVoucherId} (Total ‚Çπ ${savedTotal})`);
  } catch (err) {
    console.error(err);
    alert('Network error while saving.');
  }
}

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>


<!-- === Travel Voucher: NEW JSON submit (only filled sections) === -->
<script>
(function(){
  // Utility helpers
  const pruneEmpty = (obj) => {
    const out={}; for (const [k,v] of Object.entries(obj||{})){
      if (v === undefined || v === null) continue;
      if (typeof v === 'string' && v.trim() === '') continue;
      if (Number.isNaN(v)) continue;
      out[k]=v;
    } return out;
  };
  const money = n => (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  const b64FromFile = (file) => new Promise((resolve) => {
    if (!file) return resolve(null);
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(',')[1] || null);
    r.onerror = () => resolve(null);
    r.readAsDataURL(file);
  });

  function daysBetween(iso1, iso2){
    if(!iso1 || !iso2) return 0;
    const a = new Date(iso1), b = new Date(iso2);
    return Math.max(0, Math.round((b - a) / 86400000) + 1);
  }

  // Wire up when Travel form opens
  const _open = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    const ret = _open ? _open.apply(this, arguments) : undefined;
    if (vtype !== 'travel') return ret;

    const modalRoot = document.getElementById('modal-body') || document;
    const form = modalRoot.querySelector('#travelForm');
    if (!form) return ret;

    // Remove any legacy submit handlers by cloning the form node (drops listeners)
    const cloned = form.cloneNode(true);
    form.replaceWith(cloned);

    // section state arrays stored on the cloned form if older code added them
    let fareRows = []; let localRows = []; let hotelRows = []; let daRows = []; let miscRows = [];

    // Attach Add Entry buttons to push into arrays + render small tables below (optional if already present)
    function getVal(id){ return cloned.querySelector(id)?.value || ''; }

    // Build payload only with filled sections
    async function buildPayload(){
      const wo   = getVal('#tv-wo');
      const updt = getVal('#tv-date') || new Date(Date.now() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
      const from = getVal('#tv-from');
      const to   = getVal('#tv-to');

      // Required minimal checks
      if(!(wo && updt && from && to)){ alert('Fill Work Order, Date, From, To in Details.'); return null; }

      const voucher = [ pruneEmpty({
        work_order_no: wo, upload_date: updt, expense_date: updt, voucher_type: 'TRAVEL',
        username: (window.getUsername && window.getUsername()) || ''
      }) ];

      const travel = [ pruneEmpty({
        projectname: getVal('#tv-customer'),
        place: getVal('#tv-place'),
        purpose_journey: getVal('#tv-purpose'),
        place_visit: getVal('#tv-place'),
        from_date: from, to_date: to,
        visit_autherized: getVal('#tv-auth')
      }) ];

      // Collect rows from visible UI inputs (single-row per section in this UI). Only include when filled.
      const payload = { voucher, travel };

      // (A) Travel fare (single row UI) -> include if from_place & to_place present
      const fareFrom = getVal('#fare-from'); const fareTo = getVal('#fare-to');
      if (fareFrom && fareTo){
        const fFile = cloned.querySelector('#fare-file')?.files?.[0];
        payload.travel_fare = [ pruneEmpty({
          from_place: fareFrom,
          to_place: fareTo,
          departure_date: (getVal('#fare-dep')||'').split('T')[0] || '',
          departure_time: (getVal('#fare-dep')||'').split('T')[1] || '',
          arrival_date:   (getVal('#fare-arr')||'').split('T')[0] || '',
          arrival_time:   (getVal('#fare-arr')||'').split('T')[1] || '',
          mode_trasport: getVal('#fare-mode') || '',
          cost: (cloned.querySelector('#fare-amt')?.value||'').trim() || undefined,
          bill_photo: await b64FromFile(fFile)
        }) ];
      }

      // (B) Local fare -> include if date + (from or to)
      const locDate = getVal('#local-date');
      const locFrom = getVal('#local-from'); const locTo = getVal('#local-to');
      if (locDate && (locFrom || locTo)){
        const fFile = cloned.querySelector('#local-file')?.files?.[0];
        payload.local_fare = [ pruneEmpty({
          date: locDate ? new Date(locDate).toISOString() : undefined,
          fromplace: locFrom || undefined,
          toplace: locTo || undefined,
          mode_transport: getVal('#local-mode') || undefined,
          number_km: (cloned.querySelector('#local-km')?.value||'').trim() || undefined,
          amount: (cloned.querySelector('#local-amt')?.value||'').trim() || undefined,
          ref_image: await b64FromFile(fFile)
        }) ];
      }

      // (C) Hotel -> include if hotel name or amount present
      const hotelName = getVal('#hotel-name'); const hotelAmt = cloned.querySelector('#hotel-amt')?.value;
      if (hotelName || (hotelAmt && Number(hotelAmt)>0)){
        const fFile = cloned.querySelector('#hotel-file')?.files?.[0];
        payload.hotel_accomodation = [ pruneEmpty({
          checkin_date:  (getVal('#hotel-checkin')||'').split('T')[0] || '',
          checkin_time:  (getVal('#hotel-checkin')||'').split('T')[1] || '',
          checkout_date: (getVal('#hotel-checkout')||'').split('T')[0] || '',
          checkout_time: (getVal('#hotel-checkout')||'').split('T')[1] || '',
          hotel_name: hotelName || '',
          adress: getVal('#hotel-address') || '',
          total_amount: (hotelAmt||'').trim() || undefined,
          bill_photo: await b64FromFile(fFile)
        }) ];
      }

      // (D) Daily & Food allowance -> include if from/to selected
      const daFrom = getVal('#da-from'); const daTo = getVal('#da-to');
      if (daFrom && daTo){
        const days = daysBetween(daFrom, daTo);
        payload.food = [ pruneEmpty({
          fromdate: daFrom, todate: daTo,
          number_days: days,
          amount: (cloned.querySelector('#da-days')?.value||'').trim() || undefined
        }) ];
      }

      // (E) Misc -> include if date or particulars or amount present
      const miscDate = getVal('#misc-date'); const miscAmt = cloned.querySelector('#misc-amt')?.value;
      const miscPart = cloned.querySelector('#misc-particulars')?.value || '';
      if (miscDate || miscPart || (miscAmt && Number(miscAmt)>0)){
        const fFile = cloned.querySelector('#misc-file')?.files?.[0];
        payload.miscellaneous_expenses = [ pruneEmpty({
          date: miscDate || undefined,
          perticulers: miscPart || undefined,
          amount: (miscAmt||'').trim() || undefined,
          bill_photo: await b64FromFile(fFile)
        }) ];
      }

      return payload;
    }

    // Create/attach a bottom Submit button (or reuse one if exists)
    
  };
})();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<!-- end travel patch -->


<!-- === Transport Modes + DA auto-calc wiring === -->
<script>
(function(){
  // Store transport modes metadata here after fetch
  const transportMeta = new Map(); // key: mode name -> { id, fixed_status, price }

  async function fetchTransportModes(){
    try{
      const res = await fetch('/api/master/transport_modes/');
      const js = await res.json();
      // Expecting something like { ok:true, data:[{mode_of_transport, fixed_status, price}, ...] } or raw list
      const list = Array.isArray(js) ? js : (Array.isArray(js?.data) ? js.data : []);
      transportMeta.clear();
      for (const it of list){
        const name = it.mode_of_transport || it.name || it.title || '';
        if (!name) continue;
        transportMeta.set(String(name), { 
          id: it.id ?? it.mode_id ?? null,
          fixed_status: Number(it.fixed_status ?? it.fixed ?? 0),
          price: Number(it.price ?? it.rate ?? 0)
        });
      }
      // Populate selects if present
      const fareSel = document.querySelector('#fare-mode');
      const localSel = document.querySelector('#local-mode');
      for (const sel of [fareSel, localSel]){
        if (!sel) continue;
        const curr = sel.value;
        sel.innerHTML = '<option value="">Select mode</option>';
        for (const name of transportMeta.keys()){
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          if (name === curr) opt.selected = true;
          sel.appendChild(opt);
        }
      }
    }catch(e){ console.warn('Transport modes fetch failed', e); }
  }

  function recomputeLocalAmount(){
    const sel = document.querySelector('#local-mode');
    const kmEl = document.querySelector('#local-km');
    const amtEl = document.querySelector('#local-amt');
    if (!sel || !kmEl || !amtEl) return;
    const mode = sel.value;
    const km = parseFloat(kmEl.value || ''); 
    const meta = transportMeta.get(mode) || {};
    if (meta.fixed_status === 1 && !Number.isNaN(km)){
      const calc = (km * (Number(meta.price)||0));
      if (calc > 0) amtEl.value = calc.toFixed(2);
    }
  }

  // Daily Allowance: try to fetch master travel purposes to get food_per_day; fallback to 250
  let travelRateCache = { rate: 250 };
  async function fetchTravelRate(purpose){
    if (!purpose){ travelRateCache = { rate: 250 }; return travelRateCache; }
    try{
      // Use the generic /api/master/travel/ endpoint many projects expose in this codebase
      const res = await fetch('/api/master/travel/');
      const js = await res.json();
      const list = Array.isArray(js) ? js : (Array.isArray(js?.data) ? js.data : []);
      const match = (list || []).find(
        x => String(x.purpose || x.purpose_name || x.purpose_journey || '').toLowerCase() === String(purpose).toLowerCase()
      );
      const rate = Number(match?.food_per_day ?? match?.da ?? match?.rate ?? 250) || 250;
      travelRateCache = { rate };
    }catch(e){
      travelRateCache = { rate: 250 };
    }
    return travelRateCache;
  }

  function daysBetween(iso1, iso2){
    if(!iso1 || !iso2) return 0;
    const a = new Date(iso1), b = new Date(iso2);
    return Math.max(0, Math.round((b - a) / 86400000) + 1);
  }

  async function recomputeDA(){
    const from = document.querySelector('#da-from')?.value || '';
    const to   = document.querySelector('#da-to')?.value || '';
    const days = daysBetween(from, to);
    // Always show only number of days in the field
    const daysEl = document.querySelector('#da-days') || document.querySelector('#da-numdays');
    if (daysEl) daysEl.value = days || '';
    // Do not write computed amount into any visible input
    // Amount is calculated internally when adding the entry and reflected only in the summary
  }

  // Hook up listeners AFTER modal is open (openVoucherWizardFor wrapper already exists in our last patch)
  const _open = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    const ret = _open ? _open.apply(this, arguments) : undefined;
    if (vtype !== 'travel') return ret;

    // Populate transport modes
    fetchTransportModes();

    // Auto compute local fare amount when km or mode changes
    setTimeout(()=>{
      const kmEl = document.querySelector('#local-km');
      const modeEl = document.querySelector('#local-mode');
      if (kmEl) kmEl.addEventListener('input', recomputeLocalAmount);
      if (modeEl) modeEl.addEventListener('change', recomputeLocalAmount);
    }, 0);

    // Auto compute DA on date/purpose changes
    setTimeout(()=>{
      const daFrom = document.querySelector('#da-from');
      const daTo   = document.querySelector('#da-to');
      const purpose = document.querySelector('#tv-purpose');
      if (daFrom) daFrom.addEventListener('change', recomputeDA);
      if (daTo) daTo.addEventListener('change', recomputeDA);
      if (purpose) purpose.addEventListener('input', recomputeDA);
      // initial compute
      recomputeDA();
    }, 0);

    return ret;
  };
})();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>
<!-- end transport wiring -->
 <script>
  (function() {
    const sel = document.getElementById("cash-exp-date");
    if (sel) {
      const today = new Date();
      // helper: format yyyy-mm-dd
      const fmt = d => d.toISOString().slice(0,10);

      const opts = [
        { label: "Today", date: new Date(today) },
        { label: "Yesterday", date: new Date(today.getTime() - 86400000) },
        { label: "Day before yesterday", date: new Date(today.getTime() - 2*86400000) }
      ];

      sel.innerHTML = "";
      opts.forEach(o => {
        const opt = document.createElement("option");
        opt.value = fmt(o.date);
        opt.textContent = `${o.label} (${fmt(o.date)})`;
        sel.appendChild(opt);
      });
    }
  })();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


  function byId(id){ return document.getElementById(id); }
</script>


<script>
// === PATCH: Fix Voucher columns (Manager, Dept Head, Accountant, Finance Head, Action) and buttons ===
(function(){
  const V_KEY='vouchers';
  const loadV=()=>{ try{return JSON.parse(localStorage.getItem(V_KEY)||'[]')}catch{return[]} };
  const saveV=(a)=>localStorage.setItem(V_KEY,JSON.stringify(a));

  // Ensure item has all stages in the new order
  function ensureStages(it){
    it.stages = it.stages || {};
    if(!it.stages.manager)    it.stages.manager    = {status:'Pending', updatedAt: it.createdAt || Date.now()};
    if(!it.stages.dept)       it.stages.dept       = {status:'Pending', updatedAt: null};
    if(!it.stages.accountant) it.stages.accountant = {status:'Pending', updatedAt: null};
    if(!it.stages.finance)    it.stages.finance    = {status:'Pending', updatedAt: null};
    const order=['manager','dept','accountant','finance'];
    if(!order.includes(it.currentStage)){
      // pick first pending stage
      for(const s of order){ if((it.stages[s]||{}).status==='Pending'){ it.currentStage=s; break; } }
      if(!it.currentStage) it.currentStage='finance';
    }
    return it;
  }

  // Override addVoucher to include manager stage and new order
  window.addVoucher = function(v){
    const arr=loadV(); const now=Date.now();
    const item = { id:'v_'+now, createdAt:now, currentStage:'manager',
      stages:{ manager:{status:'Pending',updatedAt:now}, dept:{status:'Pending',updatedAt:null}, accountant:{status:'Pending',updatedAt:null}, finance:{status:'Pending',updatedAt:null} },
      ...v
    };
    arr.push(item); saveV(arr);
  };

  // Override approve flow to new order
  window.approveStageV = function(item, stage){
    const order=['manager','dept','accountant','finance'];
    if(!item.stages || !item.stages[stage]) ensureStages(item);
    item.stages[stage].status='Approved'; item.stages[stage].updatedAt=Date.now();
    const idx=order.indexOf(stage);
    if(idx<order.length-1){
      const next=order[idx+1];
      item.currentStage=next;
      if(item.stages[next].updatedAt==null) item.stages[next].updatedAt=Date.now();
    }else{
      item.currentStage='done';
    }
  };

  // Ensure the 'closeModal' function supports both usage styles
  window.closeModal = function(id){
    if(typeof id === 'string'){
      const el=document.getElementById(id);
      if(el && el.classList) el.classList.remove('active');
      return;
    }
    // Default app modal close
    const modal = document.getElementById('app-modal');
    if(modal){
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
    }
    const body = document.getElementById('modal-body'); if(body) body.innerHTML='';
    document.body.style.overflow='';
  };

  // Action buttons
  window.updateVoucher = function(id){
    const arr=loadV(); const it=arr.find(x=>x.id===id); if(!it) return alert('Voucher not found');
    const newAmt = prompt('Enter new amount:', String(it.amount||''));
    if(newAmt!==null && newAmt.trim()!==''){
      it.amount = newAmt.trim();
    }
    const newRemarks = prompt('Enter remarks (optional):', String(it.remarks||''));
    if(newRemarks!==null) it.remarks = newRemarks;
    saveV(arr);
    if(typeof renderVoucherTable==='function') renderVoucherTable();
  };
  window.deleteVoucher = function(id){
    if(!confirm('Delete this voucher?')) return;
    const arr=loadV().filter(x=>x.id!==id);
    saveV(arr);
    if(typeof renderVoucherTable==='function') renderVoucherTable();
  };

  // Override stage cell to reuse existing style classes
  window.stageCellVoucher = function(item, stage){
    ensureStages(item);
    const st=item.stages[stage], isActive=item.currentStage===stage, statusText=st.status;
    let cls='s-pending'; if(statusText==='Approved') cls='s-approved';
    const updated = st.updatedAt ? new Date(st.updatedAt).toLocaleString() : '‚Äî';
    const btn = isActive ? ` <button class="btn-secondary" style="padding:4px 8px" onclick="manualApproveVoucher('${item.id}')">Approve</button>` : '';
    return `<span class="${cls}">${statusText}</span>${btn}<span class="muted">Updated: ${updated}</span>`;
  };

  // LocalStorage renderer (disabled): keep for reference but not used
  window.renderVoucherTableLS_UNUSED = function(){
    const tbody=document.getElementById('voucherTbody'); if(!tbody) return;
    const arr=loadV();
    if(!Array.isArray(arr) || arr.length===0){ tbody.innerHTML='<tr class="empty"><td colspan="10">No vouchers yet.</td></tr>'; return; }
    tbody.innerHTML='';
    arr.forEach((raw,i)=>{
      const item = ensureStages(raw);
      const num = parseFloat((String(item.amount||'')).replace(/[^0-9.]/g,'')) || 0;
      const fmt = num.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      const billsCount = (item.file_count||item.files_count||(item.fileUrls?item.fileUrls.length:0)||(item.bills?item.bills.length:0)||0);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${item.date||'-'}</td>
        <td>${item.claimNo||'-'}</td>
        <td>${fmt}</td>
        <td><button class="btn-secondary bill-btn" onclick="openBillFor(${i})">View (${billsCount})</button></td>
        <td>${stageCellVoucher(item,'manager')}</td>
        <td>${stageCellVoucher(item,'dept')}</td>
        <td>${stageCellVoucher(item,'accountant')}</td>
        <td>${stageCellVoucher(item,'finance')}</td>
        <td>
          <button class="btn-secondary" style="padding:4px 8px" onclick="updateVoucher('${item.id}')">Update</button>
          <button class="btn-secondary" style="padding:4px 8px" onclick="deleteVoucher('${item.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  };

  // Manual approve uses new order automatically via approveStageV override
  window.manualApproveVoucher = function(id){
    const arr=loadV(); const it=arr.find(x=>x.id===id); if(!it) return;
    ensureStages(it);
    if(it.currentStage==='done'){ saveV(arr); renderVoucherTable(); return; }
    approveStageV(it, it.currentStage); saveV(arr); renderVoucherTable();
  };

  // === Validate Voucher modal utilities (use different name to avoid conflicts) ===
  window.openDetailsModal = function(voucherNo){
    const el=document.getElementById('detailsModal'); if(!el) return;
    const span=document.getElementById('modalVoucherNo'); if(span) span.textContent = voucherNo || '';
    el.classList.add('active');
  };
  window.closeOverlay = function(id){
    const el=document.getElementById(id); if(el) el.classList.remove('active');
  };
  window.submitDecision = function(){
    const decision = document.querySelector('input[name="decision"]:checked');
    if(!decision){ alert("Select Approve or Reject"); return; }
    if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
    else { closeOverlay('detailsModal'); const r=document.getElementById('rejectModal'); if(r) r.classList.add('active'); }
  };
  window.confirmReject = function(){
    const remarks = document.getElementById('rejectRemarks')?.value || '';
    if(remarks.length<50){ alert('Remarks must be at least 50 characters'); return; }
    updateAction('Rejected','s-rejected', remarks);
    closeOverlay('rejectModal');
  };
  window.updateAction = function(status, cls, remarks=''){
    const row = document.querySelector('#approveTable tbody tr'); if(!row) return;
    row.cells[8].innerHTML = `<span class="${cls}">${status}</span>`;
    row.cells[9].textContent = remarks;
    if(typeof updateSummary==='function') updateSummary();
  };
  window.updateSummary = function(){
    const rows=document.querySelectorAll('#approveTable tbody tr');
    let approved=0, rejected=0;
    rows.forEach(r=>{ const s=(r.cells[8]?.innerText||'').trim(); if(s==='Approved') approved++; if(s==='Rejected') rejected++; });
    const deemed = rows.length - approved - rejected;
    const el=document.getElementById('summary'); if(el) el.textContent = `Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
  };

  // Kick a re-render if user is already on voucher page
  try{ if(document.getElementById('pg-voucher')?.classList.contains('active')) renderVoucherTable(); }catch(e){}
})();

  function byId(id){ return document.getElementById(id); }
</script>


<script>
// Final safeguard: make sure app modal Close/Back always work
(function(){
  try{
    const modal = document.getElementById('app-modal');
    const body  = document.getElementById('modal-body');
    window.closeModal = function(){
      if(!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
      if(body) body.innerHTML='';
      document.body.style.overflow='';
    };
  }catch(e){}
})();

  function byId(id){ return document.getElementById(id); }
</script>
<script>
(function(){
  // When "Validate Voucher" tab is activated, load data
  function renderValidateTable(rows){
    const tbody = document.querySelector('#approveTable tbody');
    if(!tbody) return;
    if(!Array.isArray(rows) || rows.length===0){
      tbody.innerHTML = '<tr class="empty"><td colspan="10">No vouchers pending for you.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map((r, i) => {
      const v = {
        sl: i+1,
        emp: r.employee_name || '',
        sub: r.upload_date || '',
        vno: r.voucher_no || '',
        vtype: r.voucher_type || '',
        wo: r.work_order || '',
        amt: (r.total_amount ?? 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}),
        approved: (r.stage_approved||'').toString().trim(),
        remarks: (r.stage_remarks||'').toString()
      };
      let actionText = 'Pending', actionCls='pending', remarksText='';
      if(v.approved==='1' || (v.approved.toLowerCase && v.approved.toLowerCase()==='approved')){
        actionText='Approved'; actionCls='s-approved'; remarksText='Approved';
      } else if(v.remarks && v.remarks.trim()!=='') {
        actionText='Rejected'; actionCls='s-rejected'; remarksText=v.remarks;
      } else {
        actionCls='pending';
      }
      return `<tr data-voucher="${v.vno}">
        <td>${v.sl}</td>
        <td>${v.emp}</td>
        <td>${v.sub||''}</td>
        <td>${v.vno}</td>
        <td>${v.vtype}</td>
        <td>${v.wo}</td>
        <td>${v.amt}</td>
        <td><button class="btn-secondary" data-details="${v.vno}">Click here</button></td>
        <td class="${actionCls}">${actionText}</td>
        <td>${remarksText}</td>
      </tr>`;
    }).join('');
    // attach "Click here" handlers
    tbody.querySelectorAll('button[data-details]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = btn.getAttribute('data-details');
        try{
          const res = await fetch(`/api/validate/details/${encodeURIComponent(id)}/`, { headers: { 'Accept': 'application/json' } });
          let js; let text; const ct=(res.headers.get('content-type')||'').toLowerCase();
          if(ct.includes('application/json')){ js = await res.json(); }
          else { text = await res.text(); throw new Error(text.slice(0,200)); }
          if(!res.ok || !js.ok) throw new Error(js.error || `HTTP ${res.status}`);
          // fill modal content
          const d = js.data || {};
          const box = document.getElementById('detailsContent');
          if(box){
            box.innerHTML = `
              <div><b>Voucher:</b> ${d.voucher_no}</div>
              <div><b>Expense Date:</b> ${d.expense_date||''}</div>
              <div><b>Type:</b> ${d.voucher_type}</div>
              <div><b>Work Order:</b> ${d.work_order}</div>
              <div><b>Total:</b> ‚Çπ ${(d.total_amount||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
              <div><b>Employee:</b> ${d.employee_name||''}</div>
              ${d.purchase ? `<div><b>Description:</b> ${d.purchase.description||''}</div>`:''}
              ${d.purchase && d.purchase.bill_url ? `<div><b>Bill:</b> <a class=\"btn-secondary\" style=\"padding:2px 8px\" href=\"${d.purchase.bill_url}\" target=\"_blank\" rel=\"noopener\">View</a></div>`:''}
              ${Array.isArray(d.items)? `<div style="margin-top:8px;"><b>Items:</b><ul>`+d.items.map(it=>`<li>${it.expense_type||'-'} ‚Äî ‚Çπ ${(it.amount||0).toLocaleString(undefined,{minimumFractionDigits:2})}</li>`).join('')+`</ul></div>`:''}
              ${d.travel ? `<div style="margin-top:8px;"><b>Travel Summary:</b>
                 <div>A: Fare ‚Äî ‚Çπ ${(d.travel.fare?.sum||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                 <div>B: Local ‚Äî ‚Çπ ${(d.travel.local?.sum||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                 <div>C: Hotel ‚Äî ‚Çπ ${(d.travel.hotel?.sum||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                 <div>D: Food ‚Äî ‚Çπ ${(d.travel.food?.sum||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                 <div>E: Misc ‚Äî ‚Çπ ${(d.travel.misc?.sum||0).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
              </div>`:''}
            `;
          }
          // Re-render with cleaner layout (override above)
          try{
            const money = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
            const trimId = s => (s||'').replace(/(\d{4})$/,'');
            const chip = (t,v)=>`<div style="display:flex;flex-direction:column;gap:2px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb"><div style="font-size:12px;color:#64748b">${t}</div><div style="font-weight:700">${v}</div></div>`;
            const section = (title, inner)=>`<div style="margin-top:12px"><div style="font-weight:800;margin-bottom:6px">${title}</div><div>${inner}</div></div>`;
            const list = (rows)=>`<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr><th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px">Particulars</th><th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px">Amount</th><th style="padding:6px"></th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
            const btn = (href, label)=>`<a class="btn-secondary" style="padding:4px 8px" target="_blank" rel="noopener" href="${href}">${label}</a>`;
            const d = js.data || {};
            let itemsRows = [];
            if(Array.isArray(d.items)){
              itemsRows = d.items.map(it=>`<tr><td style=\"padding:6px;border-bottom:1px solid #f1f5f9\">${it.expense_type||'-'}</td><td style=\"padding:6px;text-align:right;border-bottom:1px solid #f1f5f9\">${money(it.amount)}</td><td style=\"padding:6px\">${it.file_url?btn(it.file_url,'View'):''}</td></tr>`);
            }
            const collect = (arr)=> (Array.isArray(arr)?arr:[]).map((x,i)=>x.file_url?btn(x.file_url,`View ${i+1}`):'').filter(Boolean).join(' ');
            const travelFiles = d.travel ? [
              d.travel.fare?.rows?.length? chip('A. Fare', money(d.travel.fare.sum||0)) + '<div style=\"margin-top:6px\">'+collect(d.travel.fare.rows)+'</div>' : '',
              d.travel.local?.rows?.length? chip('B. Local', money(d.travel.local.sum||0)) + '<div style=\"margin-top:6px\">'+collect(d.travel.local.rows)+'</div>' : '',
              d.travel.hotel?.rows?.length? chip('C. Hotel', money(d.travel.hotel.sum||0)) + '<div style=\"margin-top:6px\">'+collect(d.travel.hotel.rows)+'</div>' : '',
              d.travel.food?.sum? chip('D. Food', money(d.travel.food.sum||0)) : '',
              d.travel.misc?.rows?.length? chip('E. Misc', money(d.travel.misc.sum||0)) + '<div style=\"margin-top:6px\">'+collect(d.travel.misc.rows)+'</div>' : '',
            ].filter(Boolean).join('') : '';
            box.innerHTML = `
              <div style=\"display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:8px\">
                ${chip('Voucher', trimId(d.voucher_no||''))}
                ${chip('Type', d.voucher_type||'-')}
                ${chip('Expense Date', d.expense_date||'-')}
                ${chip('Work Order', d.work_order||'-')}
                ${chip('Total', '‚Çπ '+money(d.total_amount||0))}
                ${chip('Employee', d.employee_name||'-')}
              </div>
              ${d.purchase? section('Purchase', `
                 <div style=\\"display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff\\"> 
                   <div>${d.purchase.description||''}</div>
                   <div>${d.purchase.bill_url?btn(d.purchase.bill_url,'View Bill'):''}</div>
                 </div>
              `):''}
              ${itemsRows.length? section('Expense Items', list(itemsRows)) : ''}
              ${d.travel? section('Travel', travelFiles || '<div class=\\"muted\\">No travel bills attached.</div>') : ''}
            `;
          }catch(_){ /* leave basic content */ }
          const m=document.getElementById('detailsModal');
          if(m){
            m.dataset.voucher = id;
            m.querySelectorAll('input[name="decision"]').forEach(inp=>{ inp.checked=false; inp.disabled=false; });
            const btn = document.getElementById('decisionSubmitBtn'); if(btn) btn.disabled = false;
            m.classList.add('active');
          }
        }catch(err){
          alert('Failed to load details: '+ err.message);
        }
      });
    });
  }

  async function loadValidateList(){
    try{
      const res = await fetch('/api/validate/list/');
      const js  = await res.json();
      if(!res.ok || !js.ok){ throw new Error(js.error || `HTTP ${res.status}`); }
      renderValidateTable(js.data || []);
      if(typeof updateSummary==='function') updateSummary(); // reuse your summary bar logic
    }catch(err){
      console.error(err);
      renderValidateTable([]);
    }
  }

  // Hook: when the Validate tab is clicked / shown
  document.querySelectorAll('.nav-btn[data-target="pg-validate"]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      // slight defer so the page can show first
      setTimeout(loadValidateList, 50);
    });
  });
  // If already on the page at first paint, load immediately
  if(document.getElementById('pg-validate')?.classList.contains('active')) loadValidateList();
})();

  function byId(id){ return document.getElementById(id); }
</script>



<script>
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('.bill-btn');
  if(!btn) return;
  const vtype = (btn.getAttribute('data-vtype')||'').toUpperCase();
  const vnoAttr = btn.getAttribute('data-vno') || '';
  const vno = decodeURIComponent(vnoAttr).trim();
  if(!vno) return;

  // Purchase handled via plain anchor href; ignore here
  if(vtype==='PURCHASE') return;

  try{
    const res = await fetch(`/api/validate/details/${encodeURIComponent(vno)}/`, {headers:{'Accept':'application/json'}});
    const js  = await res.json();
    if(!res.ok || !js.ok) throw new Error(js.error || `HTTP ${res.status}`);

    const data = js.data || {};
    if(vtype==='EXPENSE'){
      const items = Array.isArray(data.items) ? data.items : [];
      const urls  = items.map(x=>x.file_url).filter(Boolean);
      if(!urls.length){ alert('No bill file found for this expense voucher.'); return; }
      // Open the first file for convenience
      window.open(urls[0], '_blank', 'noopener');
      return;
    }

    if(vtype==='TRAVEL'){
      // Collect all file URLs from travel sub-sections
      const collect = (arr)=> (Array.isArray(arr)?arr:[]).map(x=>x.file_url).filter(Boolean);
      const urls = [
        ...collect(data.travel?.fare?.rows),
        ...collect(data.travel?.local?.rows),
        ...collect(data.travel?.hotel?.rows),
        ...collect(data.travel?.misc?.rows),
      ];
      if(!urls.length){ alert('No bill files attached for this travel voucher.'); return; }
      // Render a small inline panel with one button per file
      let panel = btn.nextElementSibling;
      if(!panel || !panel.classList?.contains('bill-panel')){
        panel = document.createElement('div');
        panel.className = 'bill-panel';
        panel.style.display='flex'; panel.style.flexWrap='wrap'; panel.style.gap='6px'; panel.style.marginTop='6px';
        btn.insertAdjacentElement('afterend', panel);
      }
      panel.innerHTML = '';
      urls.forEach((u, idx)=>{
        const a = document.createElement('a');
        a.className = 'btn-secondary'; a.textContent = `View ${idx+1}`; a.target = '_blank'; a.rel='noopener'; a.href = u;
        a.style.padding='4px 8px';
        panel.appendChild(a);
      });
      return;
    }

    alert('Unsupported voucher type for bill viewing.');
  }catch(e){
    alert('Could not load bill file(s). ' + (e.message||e));
  }
});

  function byId(id){ return document.getElementById(id); }
</script>


<script>
// Append all travel voucher files into a FormData before submitting
(function(){
  if (window.appendTravelFilesToFormData) return;
  window.appendTravelFilesToFormData = function(fd){
    function pick(id){ return document.getElementById(id); }
    var f;

    f = pick('fare-file');
    if (f && f.files && f.files.length){
      Array.from(f.files).forEach(file => fd.append('fare_files[]', file));
    }
    f = pick('local-file');
    if (f && f.files && f.files.length){
      Array.from(f.files).forEach(file => fd.append('local_files[]', file));
    }
    f = pick('hotel-file');
    if (f && f.files && f.files.length){
      Array.from(f.files).forEach(file => fd.append('hotel_files[]', file));
    }
    f = pick('misc-file');
    if (f && f.files && f.files.length){
      Array.from(f.files).forEach(file => fd.append('misc_files[]', file));
    }
  };

  // If there is a travel form, ensure submit uses FormData + files
  function ensureTravelSubmitHandler(){
    const form = document.getElementById('travelForm');
    if (!form) return;
    if (form.__hasFileSubmitHandler) return;
    form.addEventListener('submit', async function(e){
      try{
        // If some other code prevented default, don't double-submit
        if (e.defaultPrevented) return;
      }catch(_){}
      e.preventDefault();
      const fd = new FormData(form);

      // Map visible fields into expected names if needed
      const woSel = document.getElementById('tv-wo');
      if (woSel) fd.set('work_order_no', (woSel.value||''));

      // Add section flags/fields (only minimal safe mapping; your existing JS may add more)
      const dateInput = document.getElementById('tv-date');
      if (dateInput) fd.set('date', dateInput.value||'');

      // Copy subsection values (ids from DOM)
      const mapIds = ['fare-from','fare-to','fare-amt','local-date','local-from','local-to','local-amt','hotel-name','hotel-amt','misc-date','misc-particulars','misc-amt'];
      mapIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) fd.set(id, el.value||'');
      });

      // Attach files
      window.appendTravelFilesToFormData(fd);

      try{
        const resp = await fetch('/api/vouchers/travel/save/', { method: 'POST', body: fd });
        const j = await resp.json().catch(()=>({}));
        if (!resp.ok || j.ok === false){
          alert('Save failed: ' + (j.error || ('HTTP '+resp.status)));
          return;
        }
        alert('Saved! Voucher ID: ' + (j?.data?.voucher_id || ''));
      }catch(err){
        alert('Save failed: ' + (err?.message || err));
      }
    }, { passive: false });
    form.__hasFileSubmitHandler = true;
  }

  // Try now and also after small delays (form may be injected dynamically)
  ensureTravelSubmitHandler();
  setTimeout(ensureTravelSubmitHandler, 300);
  document.addEventListener('click', function(){ setTimeout(ensureTravelSubmitHandler, 0); }, true);
})();

  function byId(id){ return document.getElementById(id); }
</script>

</body>
</html>




<!-- === Travel Voucher ONLY enhancements (append) === -->
<script>
(function(){
  // Section states kept per modal instance
  let fareRows=[], localRows=[], hotelRows=[], daRows=[], miscRows=[];

  const money = n => (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const pruneEmpty = (obj) => {
    const out={}; for(const [k,v] of Object.entries(obj||{})){
      if (v===undefined || v===null) continue;
      if (typeof v==="string" && v.trim()==="") continue;
      out[k]=v;
    } return out;
  };
  const sumArr = (arr, key) => (arr||[]).reduce((a,x)=>a + (Number(x?.[key]||0)||0), 0);
  const splitDT = (val) => { if(!val) return {date:"",time:""}; const [d,t] = String(val).split('T'); return {date:d||"", time:(t||"").slice(0,8)}; };
  const b64FromFile = (file) => new Promise((res)=>{
    if(!file) return res("");
    const fr=new FileReader();
    fr.onload=()=>{
      const data = String(fr.result||"");
      const base64 = data.includes(',') ? data.split(',')[1] : data; // return only base64 payload
      res(base64);
    };
    fr.readAsDataURL(file);
  });

  function ensureTables(modalRoot){
    const mk = (afterSel, id, cols) => {
      if(modalRoot.querySelector('#'+id)) return;
      const after = modalRoot.querySelector(afterSel); if(!after) return;
      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';
      wrap.innerHTML = `<table class="data small-table" id="${id}">
        <thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
        <tbody><tr class="empty"><td colspan="${cols.length}">No entries.</td></tr></tbody>
      </table>`;
      after.after(wrap);
    };
    mk('#card-fare .form-actions',  'fare-entries',  ['#','From','To','Depart','Arrive','Mode','KM','Amount']);
    mk('#card-local .form-actions', 'local-entries', ['#','Date','From','To','Mode','KM','Amount']);
    mk('#card-hotel .form-actions', 'hotel-entries', ['#','Check-in','Check-out','Hotel','Address','Total']);
    mk('#card-da .form-actions',    'da-entries',    ['#','From','To','Days','Amount']);
    mk('#card-misc .form-actions',  'misc-entries',  ['#','Date','Particulars','Amount']);
  }

  function renderAll(modalRoot){
    const put = (id, rows, rowHtml) => {
      const tbody = modalRoot.querySelector('#'+id+' tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      if(!rows.length){
        const tr=document.createElement('tr'); tr.className='empty';
        const cnt = modalRoot.querySelectorAll('#'+id+' thead th').length;
        tr.innerHTML = `<td colspan="${cnt}">No entries.</td>`; tbody.appendChild(tr); return;
      }
      rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=rowHtml(r,i); tbody.appendChild(tr); });
    };
    put('fare-entries', fareRows, (r,i)=>`<td>${i+1}</td><td>${r.from_place||''}</td><td>${r.to_place||''}</td>
      <td>${r.departure_date||''} ${r.departure_time||''}</td><td>${r.arrival_date||''} ${r.arrival_time||''}</td>
      <td>${r.mode_transport||r.mode_trasport||''}</td><td>${r.km ?? ''}</td><td class="right">‚Çπ ${money(r.cost ?? r.amount ?? 0)}</td>`);

    put('local-entries', localRows, (r,i)=>`<td>${i+1}</td><td>${r.date||''}</td><td>${r.fromplace||''}</td><td>${r.toplace||''}</td>
      <td>${r.mode_transport||r.mode_trasport||''}</td><td>${r.km ?? r.number_km ?? ''}</td><td class="right">‚Çπ ${money(r.amount||0)}</td>`);

    put('hotel-entries', hotelRows, (r,i)=>`<td>${i+1}</td><td>${r.checkin_date||''} ${r.checkin_time||''}</td>
      <td>${r.checkout_date||''} ${r.checkout_time||''}</td><td>${r.hotel_name||''}</td><td>${r.adress||''}</td>
      <td class="right">‚Çπ ${money(r.total_amount||0)}</td>`);

    put('da-entries', daRows, (r,i)=>`<td>${i+1}</td><td>${r.fromdate||''}</td><td>${r.todate||''}</td><td>${r.number_days||''}</td><td class="right">‚Çπ ${money(r.amount||0)}</td>`);

    put('misc-entries', miscRows, (r,i)=>`<td>${i+1}</td><td>${r.date||''}</td><td>${r.particulars||r.perticulers||''}</td><td class="right">‚Çπ ${money(r.amount||0)}</td>`);

    // Summary
    const sumFare = fareRows.reduce((s, r) => s + (parseFloat(r.cost ?? r.amount ?? 0) || 0), 0);
    const sumLocal = sumArr(localRows,'amount');
    const sumHotel = sumArr(hotelRows,'total_amount');
    const sumDA    = sumArr(daRows,'amount');
    const sumMisc  = sumArr(miscRows,'amount');
    const setTxt = (id,val)=>{ const el = modalRoot.querySelector('#'+id); if(el) el.textContent = money(val); };
    setTxt('sum-fare', sumFare); setTxt('sum-local', sumLocal); setTxt('sum-hotel', sumHotel); setTxt('sum-da', sumDA); setTxt('sum-misc', sumMisc);
    setTxt('sum-total', sumFare+sumLocal+sumHotel+sumDA+sumMisc);
  }

  async function loadMasters(modalRoot){
    // Purpose & Authoriser
    try{
      const res = await fetch('/api/master/travel/', {headers:{'Accept':'application/json'}});
      if(res.ok){
        const js = await res.json();
        const pSel = modalRoot.querySelector('#tv-purpose');
        const aSel = modalRoot.querySelector('#tv-auth');
        if(pSel) pSel.innerHTML = `<option value="" selected disabled>-- Select --</option>` + (js.purpose_journey||[]).map(p=>`<option>${p}</option>`).join('');
        if(aSel) aSel.innerHTML = `<option value="" selected disabled>-- Select --</option>` + (js.visit_authoriser_name||[]).map(a=>`<option>${a}</option>`).join('');
      }
    }catch(e){}
    // Replace Authoriser with actual higher-ups from employee chain, if available
    try{
      const r2 = await fetch('/api/employees/managers/', {headers:{'Accept':'application/json'}});
      if(r2.ok){
        const arr = await r2.json();
        const names = (Array.isArray(arr)?arr:[]).map(x=>x.name).filter(Boolean);
        const aSel = modalRoot.querySelector('#tv-auth');
        if(aSel && names.length){
          aSel.innerHTML = `<option value="" selected disabled>-- Select --</option>` + names.map(n=>`<option>${n}</option>`).join('');
        }
      }
    }catch(e){}
    // Transport modes
    let modes=[];
    try{
      const r2 = await fetch('/api/master/transport_modes/', {headers:{'Accept':'application/json'}});
      if(r2.ok) modes = await r2.json();
    }catch(e){}
    const fillMode = (sel) => {
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = `<option value="" selected disabled>-- Select Mode --</option>`
        + modes.map(m=>`<option value="${m.mode_of_transport}" data-fixed="${m.fixed_status}" data-price="${m.price}" data-uom="${m.UOM||'km'}">${m.mode_of_transport}</option>`).join('');
      if(prev) sel.value = prev;
    };
    fillMode(modalRoot.querySelector('#fare-mode'));
    fillMode(modalRoot.querySelector('#local-mode'));

    function hookup(selId, kmId, amtId){
      const sel = modalRoot.querySelector(selId);
      const km  = modalRoot.querySelector(kmId);
      const amt = modalRoot.querySelector(amtId);
      if(!sel) return;
      const badge = document.createElement('div'); badge.className='muted'; sel.parentElement.appendChild(badge);
      const update = () => {
        const opt = sel.selectedOptions[0];
        const fixed = Number(opt?.dataset?.fixed||0)===1;
        const rate  = parseFloat(opt?.dataset?.price||'0')||0;
        const uom   = opt?.dataset?.uom || 'km';
        badge.textContent = fixed ? `Rate: ‚Çπ ${money(rate)} per ${uom}` : `Variable mode ‚Äî enter Amount`;
        if(km){ km.disabled = !fixed; if(!fixed) km.value=''; }
        if(amt){ amt.disabled = fixed; if(fixed) amt.value=''; }
        if(km && amt){
          km.oninput = () => {
            const v = parseFloat(km.value||'0')||0;
            if(Number(opt?.dataset?.fixed||0)===1){
              amt.value = (v*rate).toFixed(2);
            }
          };
        }
      };
      sel.addEventListener('change', update); update();
    }
    hookup('#fare-mode','#fare-km','#fare-amt');
    hookup('#local-mode','#local-km','#local-amt');
  }

  function wireAdders(modalRoot){
    modalRoot.querySelectorAll('[data-addentry]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const type = btn.dataset.addentry;
        if (type === 'fare') {
          const from = modalRoot.querySelector('#fare-from')?.value.trim();
          const to   = modalRoot.querySelector('#fare-to')?.value.trim();
          const dep  = splitDT(modalRoot.querySelector('#fare-dep')?.value); // {date,time}
          const arr  = splitDT(modalRoot.querySelector('#fare-arr')?.value);
          const mode = modalRoot.querySelector('#fare-mode')?.value;
          const km   = modalRoot.querySelector('#fare-km')?.value;
          const amt  = modalRoot.querySelector('#fare-amt')?.value;
          const file = modalRoot.querySelector('#fare-file')?.files?.[0];

          if (!from || !to || !mode) { alert('Fill From, To, Mode.'); return; }

          const row = pruneEmpty({
            from_place: from,
            to_place: to,
            departure_date: dep.date,
            departure_time: dep.time,
            arrival_date: arr.date,
            arrival_time: arr.time,
            // backend reads mode_transport (and tolerates the older typo too)
            mode_transport: mode,
            mode_trasport: mode, // safety for older code
            // for fixed modes (car/bike) backend will compute from km/rate
            km: km ? Number(km) : undefined,
            // for variable modes (bus/train/flight/etc) we send cost now
            amount: amt ? Number(amt) : undefined,
            cost:   amt ? Number(amt) : undefined,
            bill_photo: file ? await b64FromFile(file) : undefined
          });
          fareRows.push(row);
          renderAll(modalRoot);

          // clear small inputs (keep KM for convenience)
          const card = btn.closest('.exp-card');
          card?.querySelectorAll('input[type="text"],input[type="number"],input[type="date"],input[type="datetime-local"]').forEach(i=>{
            if(i.id.endsWith('-km')) return; i.value='';
          });
          card?.querySelectorAll('input[type="file"]').forEach(f=> f.value='');
        }else if(type==='local'){
          const date = modalRoot.querySelector('#local-date')?.value;
          const frm  = modalRoot.querySelector('#local-from')?.value.trim();
          const to   = modalRoot.querySelector('#local-to')?.value.trim();
          const mode = modalRoot.querySelector('#local-mode')?.value;
          const km   = modalRoot.querySelector('#local-km')?.value;
          const amt  = modalRoot.querySelector('#local-amt')?.value;
          const file = modalRoot.querySelector('#local-file')?.files?.[0];
          if(!date || !frm || !to || !mode){ alert('Fill Date, From, To, Mode.'); return; }
          const row = pruneEmpty({
            date, fromplace: frm, toplace: to, mode_transport: mode,
            km: km? Number(km): undefined,
            number_km: km? Number(km): undefined,
            amount: amt? Number(amt): undefined,
            ref_image: file ? await b64FromFile(file) : undefined
          });
          localRows.push(row);
        }else if(type==='hotel'){
          const ci = splitDT(modalRoot.querySelector('#hotel-checkin')?.value);
          const co = splitDT(modalRoot.querySelector('#hotel-checkout')?.value);
          const name= modalRoot.querySelector('#hotel-name')?.value.trim();
          const addr= modalRoot.querySelector('#hotel-address')?.value.trim();
          const amt = modalRoot.querySelector('#hotel-amt')?.value;
          const file= modalRoot.querySelector('#hotel-file')?.files?.[0];
          if(!ci.date || !co.date || !name){ alert('Fill Check-in/Check-out and Hotel.'); return; }
          const row = pruneEmpty({
            checkin_date: ci.date, checkin_time: ci.time,
            checkout_date: co.date, checkout_time: co.time,
            hotel_name: name, adress: addr,
            total_amount: amt? Number(amt): undefined,
            bill_photo: file ? await b64FromFile(file) : undefined
          });
          hotelRows.push(row);
        }else if(type==='da'){
          const fd = modalRoot.querySelector('#da-from')?.value;
          const td = modalRoot.querySelector('#da-to')?.value;
          let days = undefined;
          if(fd && td){
            const d1=new Date(fd), d2=new Date(td);
            days = Math.max(1, Math.ceil((d2-d1)/(24*3600*1000))+1);
          }
          if(!fd || !td || !days){ alert('Fill From/To dates.'); return; }
          // Compute amount for summary (not shown in inputs), backend can recompute as well
          let amtComputed;
          try{
            const purpose = modalRoot.querySelector('#tv-purpose')?.value || '';
            const res = (typeof fetchTravelRate === 'function') ? await fetchTravelRate(purpose) : { rate: 250 };
            const rate = Number(res?.rate || 0);
            amtComputed = (rate>0 && days>0) ? Number((rate * days).toFixed(2)) : undefined;
          }catch(e){ amtComputed = undefined; }
          const row = pruneEmpty({ fromdate: fd, todate: td, number_days: days, amount: amtComputed });
          daRows.push(row);
        }else if(type==='misc'){
          const date = modalRoot.querySelector('#misc-date')?.value;
          const part = modalRoot.querySelector('#misc-particulars')?.value;
          const amt  = modalRoot.querySelector('#misc-amt')?.value;
          const file = modalRoot.querySelector('#misc-file')?.files?.[0];
          if(!date || !part || !amt){ alert('Fill Date, Particulars, Amount.'); return; }
          const row = pruneEmpty({ date, particulars: part, amount: Number(amt), bill_photo: file ? await b64FromFile(file) : undefined });
          miscRows.push(row);
        }
        renderAll(modalRoot);
        // Clear all inputs including mode/KM/amount to avoid stale values
        const card = btn.closest('.exp-card');
        card?.querySelectorAll('input[type="text"],input[type="number"],input[type="date"],input[type="datetime-local"]').forEach(i=>{ i.value=''; });
        card?.querySelectorAll('input[type="file"]').forEach(f=> f.value='');
        // Reset selects (transport mode) and trigger change to re-disable KM/Amount
        card?.querySelectorAll('select').forEach(s=>{ try{ s.selectedIndex = 0; s.dispatchEvent(new Event('change')); }catch(_){} });
      });
    });

    // Reset buttons per section
    modalRoot.querySelectorAll('[data-reset-section]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t=btn.dataset.resetSection;
        if(t==='fare') fareRows.length=0;
        if(t==='local') localRows.length=0;
        if(t==='hotel') hotelRows.length=0;
        if(t==='da') daRows.length=0;
        if(t==='misc') miscRows.length=0;
        renderAll(modalRoot);
      });
    });
  }

  function wireRadios(modalRoot){
    const radios = modalRoot.querySelectorAll('input[name="expTab"]');
    const show = (val)=>{
      modalRoot.querySelectorAll('.exp-card').forEach(c=> c.style.display='none');
      const tgt = modalRoot.querySelector('#card-'+val); if(tgt) tgt.style.display='block';
    };
    radios.forEach(r=> r.addEventListener('change', ()=> show(r.value)));
    const first = modalRoot.querySelector('input[name="expTab"][value="fare"]');
    if(first){ first.checked=true; first.dispatchEvent(new Event('change')); }
  }

  async function wireSubmit(modalRoot){
    const submitBtn = modalRoot.querySelector('#uv-submit-btn');
    if(!submitBtn) return;
    submitBtn.addEventListener('click', async ()=>{
      // header fields
      const wo   = modalRoot.querySelector('#tv-wo')?.value || '';
      const updt = modalRoot.querySelector('#tv-date')?.value || new Date().toISOString().slice(0,10);
      const from = modalRoot.querySelector('#tv-from')?.value || modalRoot.querySelector('#tv-from')?.value || '';
      const to   = modalRoot.querySelector('#tv-to')?.value || '';
      const place= modalRoot.querySelector('#tv-place')?.value || '';
      const purpose = modalRoot.querySelector('#tv-purpose')?.value || '';
      const auth    = modalRoot.querySelector('#tv-auth')?.value || '';
      const project = modalRoot.querySelector('#tv-customer')?.value || '';

      if(!(wo && updt && from && to)){
        alert('Fill Work Order, Date, From, To in Details.'); return;
      }

      const payload = {};
      payload.voucher = [ pruneEmpty({
        work_order_no: wo,
        upload_date: updt,
        expense_date: updt,
        voucher_type: 'TRAVEL',
        total_amount: 0,
        username: (window.getUsername && window.getUsername()) || ''
      }) ];
      payload.travel = [ pruneEmpty({
        projectname: project,
        place: place,
        purpose_journey: purpose,
        place_visit: place,
        from_date: modalRoot.querySelector('#tv-from')?.value || '',
        to_date: modalRoot.querySelector('#tv-to')?.value || '',
        visit_authorised: auth
      }) ];

      if(fareRows.length) payload.travel_fare = fareRows.map(pruneEmpty);
      if(localRows.length) payload.local_fare = localRows.map(pruneEmpty);
      if(hotelRows.length) payload.hotel_accomodation = hotelRows.map(pruneEmpty);
      if(daRows.length) payload.food = daRows.map(pruneEmpty);
      if(miscRows.length) payload.miscellaneous_expenses = miscRows.map(pruneEmpty);

      try{
        // Switch to FormData submit to avoid JSON errors and support files
        const fd = new FormData();
        fd.append('work_order_no', wo);
        fd.append('upload_date', updt);
        fd.append('expense_date', updt);
        fd.append('voucher_type', 'TRAVEL');
        try{ if(typeof getUsername==='function'){ fd.append('username', getUsername()||''); } }catch(_){ }

        fd.append('projectname', project);
        fd.append('place', place);
        fd.append('purpose_journey', purpose);
        fd.append('place_visit', place);
        fd.append('visit_authorised', auth);
        fd.append('from_date', from);
        fd.append('to_date', to);

        if(fareRows.length) fd.append('travel_fare', JSON.stringify(fareRows));
        if(localRows.length) fd.append('local_fare', JSON.stringify(localRows));
        if(hotelRows.length) fd.append('hotel_accomodation', JSON.stringify(hotelRows));
        if(daRows.length) fd.append('food', JSON.stringify(daRows));
        if(miscRows.length) fd.append('miscellaneous_expenses', JSON.stringify(miscRows));

        const res = await fetch('/api/vouchers/travel/save/', { method:'POST', body: fd });
        const js = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
        if(!res.ok || !js.ok){ console.error(js); alert('Save failed: ' + (js.error || `HTTP ${res.status}`)); return; }
        alert(`Saved! Voucher ${js.data?.voucher_id || ''} (Total ‚Çπ ${money(js.data?.total_amount||0)})`);
        // add to local list
        try{
          if(typeof addVoucher==='function'){
            addVoucher({ type:'travel', date: updt, amount: String(js.data?.total_amount||0), workorder: wo, remarks:'', claimNo: (document.querySelector('.claim')?.value||''), files: [] });
            if(typeof renderVoucherTable==='function') renderVoucherTable();
          }
        }catch(e){}
        // close modal
        document.getElementById('modalCloseBtn')?.click();
      }catch(err){ console.error(err); alert('Network error while saving.'); }
    });
  }

  // --- Monkey-patch openVoucherWizardFor to wire Travel after it builds the modal ---
  const _origOpen = window.openVoucherWizardFor;
  window.openVoucherWizardFor = function(vtype){
    // Disable legacy wiring before delegating so older wrapper won't attach listeners
    window.__DISABLE_LEGACY_TRAVEL_WIRING__ = true;
    _origOpen && _origOpen.apply(this, arguments);
    if(vtype!=='travel') return;

    // modal root
    const modalRoot = document.getElementById('modal-body') || document;
    // reset arrays for new instance
    fareRows=[]; localRows=[]; hotelRows=[]; daRows=[]; miscRows=[];

    ensureTables(modalRoot);
    loadMasters(modalRoot);
    wireAdders(modalRoot);
    wireRadios(modalRoot);
    renderAll(modalRoot);
    wireSubmit(modalRoot);
  };
})();

    /* === Validate Voucher JS === */
    function openDetailsModal(voucherNo){
      document.getElementById('modalVoucherNo').innerText = voucherNo;
      document.getElementById('detailsModal').classList.add('active');
    }
    function closeOverlay(id){
      document.getElementById(id).classList.remove('active');
    }
    function submitDecision(){
      const decision = document.querySelector('input[name="decision"]:checked');
      if(!decision){ alert("Select Approve or Reject"); return; }
      if(decision.value==='approve'){ updateAction('Approved','s-approved'); closeOverlay('detailsModal'); }
      else { closeOverlay('detailsModal'); document.getElementById('rejectModal').classList.add('active'); }
    }
    function confirmReject(){
      const remarks=document.getElementById('rejectRemarks').value;
      if(remarks.length<50){ alert("Remarks must be at least 50 characters"); return; }
      updateAction('Rejected','s-rejected',remarks);
      closeOverlay('rejectModal');
    }
    function updateAction(status,cls,remarks=''){
      const row=document.querySelector('#approveTable tbody tr');
      row.cells[6].innerHTML=`<span class="${cls}">${status}</span>`;
      row.cells[7].innerText=remarks;
      updateSummary();
    }
    function updateSummary(){
      const rows=document.querySelectorAll('#approveTable tbody tr');
      let approved=0,rejected=0;
      rows.forEach(r=>{
        const st=r.cells[6].innerText.trim();
        if(st==='Approved') approved++; if(st==='Rejected') rejected++;
      });
      const deemed=rows.length-approved-rejected;
      document.getElementById('summary').innerText=`Approved: ${approved} | Deemed Approve: ${deemed} | Rejected: ${rejected}`;
    }


/* ===== Validate Voucher: dynamic "Click here" modal ===== */
(function(){
  const fmt = (n)=> (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const esc = (s)=> String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const byId = (id)=> document.getElementById(id);

  window.closeOverlay = function(id){
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
  };
  function openOverlay(id){
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
  }

  async function fetchVoucherDetails(vno){
    const tryUrls = [
      `/api/vouchers/${encodeURIComponent(vno)}/details/validate/`,
      `/api/vouchers/details/${encodeURIComponent(vno)}/`,
      `/api/voucher/details/${encodeURIComponent(vno)}/`
    ];
    for(const url of tryUrls){
      try{
        const r = await fetch(url, {credentials:'include'});
        if(r.ok){
          return await r.json();
        }
      }catch(e){}
    }
    // last resort: look into localStorage (created from the "Voucher" page demo)
    try{
      const arr = JSON.parse(localStorage.getItem('vouchers')||'[]');
      const hit = arr.find(x=>x.claimNo===vno || x.voucher_no===vno || x.voucher_id===vno);
      if(hit){
        // Normalize a minimal structure so modal can still render something
        return {
          voucher:{ voucher_no: hit.claimNo || hit.voucher_no || hit.voucher_id || vno,
                    voucher_type: (hit.type||hit.vtype||hit.voucher_type||'EXPENSE').toUpperCase(),
                    work_order_no: hit.work_order_no || hit.wo || '-',
                    upload_date: hit.date || hit.upload_date || '',
                    expense_date: hit.date || hit.expense_date || '',
                    description: hit.description || '',
                    total_amount: hit.amount || 0 },
          attachments: (hit.bills||hit.fileUrls||[]).map((u,i)=>({type:'bill',item_id: i+1, filename: (u.name||('bill_'+(i+1))), url: (u.url||u) }))
        };
      }
    }catch(e){}
    throw new Error('Voucher details not available');
  }

  function kv(label, value){
    return `<div style="display:flex;gap:10px; margin:4px 0;">
      <div style="min-width:220px; font-weight:700;">${esc(label)}</div>
      <div>${esc(value)}</div>
    </div>`;
  }

  function buildPurchaseHTML(data){
    const v = data.voucher||{};
    const files = (data.attachments||[]).map(f=>`<li><a href="${esc(f.url)}" target="_blank" rel="noopener">${esc(f.filename||'View')}</a></li>`).join('') || '‚Äî';
    return `
      <div class="content-card">
        ${kv('Voucher No', v.voucher_no||'')}
        ${kv('Work Order', v.work_order_no||'')}
        ${kv('Upload Date', v.upload_date||'')}
        ${kv('Description', v.description||'')}
        ${kv('Total Amount', '‚Çπ '+fmt(v.total_amount))}
        <div style="margin:6px 0 0;"><strong>Bill Photo:</strong> <ul style="margin:6px 0 0 16px;">${files}</ul></div>
      </div>`;
  }

  function table(heads, rows){
    const thead = `<thead><tr>${heads.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead>`;
    const body = rows.length ? `<tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>` :
                               `<tbody><tr><td colspan="${heads.length}" class="muted">No entries</td></tr></tbody>`;
    return `<div class="table-wrap"><table class="data">${thead}${body}</table></div>`;
  }

  function buildTravelHTML(data){
    const v = data.voucher||{};
    const tr = data.travel||{};
    const sections = (data.sections)||{};
    const totals = (data.totals)||{};
    const files = (data.attachments||[]);
    const has = (arr)=> Array.isArray(arr) && arr.length>0;

    // Header (voucher + trip meta)
    let html = `<div class="content-card">
      ${kv('Voucher No', v.voucher_no||'')}
      ${kv('Work Order / Project', (v.work_order_no || (data.project && data.project.project_name) || '-'))}
      ${kv('Upload Date', v.upload_date||'')}
      ${kv('Travel period', (tr.from_date||'') + (tr.to_date?(' ‚Üí '+tr.to_date):''))}
      ${kv('Customer', v.customer || tr.customer || (data.project && data.project.customer) || '-')}
      ${kv('Employee Name', (v.employee && v.employee.name) || '-')}
      ${kv('Designation', (v.employee && v.employee.designation) || '-')}
      ${kv('Place of Visit', tr.place_visit || tr.place || '-')}
      ${kv('Purpose of Journey', tr.purpose_journey || '-') }
      ${kv('Visit Authorised By', (tr.visit_authorized && tr.visit_authorized.name) || tr.visit_authorised_by || tr.visit_authorized_by || '-') }
    </div>`;

    // A. Travel Fare
    if (has(sections.fare)){
      const heads = ['Sl','From Place','To Place','Departure (Date/Time)','Arrival (Date/Time)','Mode of Transport','KM','Amount','File(s)'];
      const rows = sections.fare.map((it,idx)=>{
        const filesCell = (it.files||[]).map(f=>`<a href="${esc(f.url)}" target="_blank" rel="noopener">View</a>`).join(', ') || '‚Äî';
        return [
          String(idx+1),
          esc(it.from_place||''),
          esc(it.to_place||''),
          esc((it.departure_date||'') + (it.departure_time?(' '+it.departure_time):'')),
          esc((it.arrival_date||'') + (it.arrival_time?(' '+it.arrival_time):'')),
          esc(it.mode_transport||''),
          esc(it.km==null?'':it.km),
          '‚Çπ '+fmt(it.cost||it.amount),
          filesCell
        ];
      });
      html += `<h3 style="margin:10px 0 6px;">(A) Travel Fare</h3>` + table(heads, rows);
    }

    // B. Local Travel
    if (has(sections.local)){
      const heads = ['Sl','Date','From','To','Mode of Transport','KM','Amount','File(s)'];
      const rows = sections.local.map((it,idx)=>{
        const filesCell = (it.files||[]).map(f=>`<a href="${esc(f.url)}" target="_blank" rel="noopener">View</a>`).join(', ') || '‚Äî';
        return [
          String(idx+1),
          esc(it.date||''),
          esc(it.from||''),
          esc(it.to||''),
          esc(it.mode_transport||''),
          esc(it.km==null?'':it.km),
          '‚Çπ '+fmt(it.cost||it.amount),
          filesCell
        ];
      });
      html += `<h3 style="margin:10px 0 6px;">(B) Local Travel</h3>` + table(heads, rows);
    }

    // C. Hotel Accommodation
    if (has(sections.hotel)){
      const heads = ['Sl','Check-in (Date/Time)','Check-out (Date/Time)','Hotel Name','Address','Amount','File(s)'];
      const rows = sections.hotel.map((it,idx)=>{
        const filesCell = (it.files||[]).map(f=>`<a href="${esc(f.url)}" target="_blank" rel="noopener">View</a>`).join(', ') || '‚Äî';
        const ci = (it.checkin_date||'') + (it.checkin_time?(' '+it.checkin_time):'');
        const co = (it.checkout_date||'') + (it.checkout_time?(' '+it.checkout_time):'');
        return [
          String(idx+1),
          esc(ci), esc(co),
          esc(it.hotel_name||''), esc(it.address||''),
          '‚Çπ '+fmt(it.cost||it.amount),
          filesCell
        ];
      });
      html += `<h3 style="margin:10px 0 6px;">(C) Hotel Accommodation</h3>` + table(heads, rows);
    }

    // D. Daily & Food Allowance
    if (has(sections.da)){
      const heads = ['Sl','From Date','To Date','No. of Days','Amount'];
      const rows = sections.da.map((it,idx)=>[
        String(idx+1),
        esc(it.from_date||''), esc(it.to_date||''),
        esc(it.number_days||it.days||''),
        '‚Çπ '+fmt(it.cost||it.amount)
      ]);
      html += `<h3 style="margin:10px 0 6px;">(D) Daily & Food Allowance</h3>` + table(heads, rows);
    }

    // E. Miscellaneous Expenses
    if (has(sections.misc)){
      const heads = ['Sl','Date','Particulars','Amount','File(s)'];
      const rows = sections.misc.map((it,idx)=>{
        const filesCell = (it.files||[]).map(f=>`<a href="${esc(f.url)}" target="_blank" rel="noopener">View</a>`).join(', ') || '‚Äî';
        return [
          String(idx+1),
          esc(it.date||''), esc(it.particulars||''),
          '‚Çπ '+fmt(it.cost||it.amount),
          filesCell
        ];
      });
      html += `<h3 style="margin:10px 0 6px;">(E) Miscellaneous Expenses</h3>` + table(heads, rows);
    }

    // Summary (only include filled sections)
    const sumRows = [];
    if (totals.fare>0)  sumRows.push(['A','Travel Fare', '‚Çπ '+fmt(totals.fare), '']);
    if (totals.local>0) sumRows.push(['B','Local Travel', '‚Çπ '+fmt(totals.local), '']);
    if (totals.hotel>0) sumRows.push(['C','Hotel Accommodation', '‚Çπ '+fmt(totals.hotel), '']);
    if (totals.da>0)    sumRows.push(['D','Daily & Food Allowance', '‚Çπ '+fmt(totals.da), '']);
    if (totals.misc>0)  sumRows.push(['E','Miscellaneous Expenses', '‚Çπ '+fmt(totals.misc), '']);
    const grand = (totals.grand_total!=null) ? totals.grand_total :
                  ['fare','local','hotel','da','misc'].reduce((s,k)=>s+(Number(totals[k]||0)), 0);

    if (sumRows.length){
      html += `<div class="summary-wrap" style="margin-top:10px;">
        <div class="summary-head">Summary</div>
        ${table(['Sl No','Main Contents','Amount Claimed','Remarks'], sumRows)}
        <div style="text-align:right;font-weight:800;padding:8px 6px;">Total Amount: ‚Çπ ${fmt(grand)}</div>
      </div>`;
    }

    return html;
  }

  window.openDetailsModal = async function(voucherNo){
    try{
      setDetailsTitle('Voucher Details');
      resetDetailsActions();
      setDecisionVisibility(true);
      const modal = document.getElementById('detailsModal');
      if(modal){
        delete modal.dataset.voucher;
      }
      openOverlay('detailsModal');
      const content = byId('detailsContent');
      if(content) content.innerHTML = `<div class="uv-help">Loading details‚Ä¶</div>`;
      const data = await fetchVoucherDetails(voucherNo);
      const type = (data.voucher?.voucher_type || data.voucher_type || '').toUpperCase();
      let html = '';
      if(type==='PURCHASE'){
        html = buildPurchaseHTML(data);
      }else if(type==='TRAVEL'){
        html = buildTravelHTML(data);
      }else{ // EXPENSE / CASH
        // Reuse the purchase layout but rename fields (Expense has Expense Date)
        const v = data.voucher||{};
        const files = (data.attachments||[]).map(f=>`<li><a href="${esc(f.url)}" target="_blank" rel="noopener">${esc(f.filename||'View')}</a></li>`).join('') || '‚Äî';
        html = `<div class="content-card">
          ${kv('Voucher No', v.voucher_no||'')}
          ${kv('Work Order', v.work_order_no||'')}
          ${kv('Expense Date', v.expense_date||'')}
          ${kv('Description', v.description||'')}
          ${kv('Total Amount', '‚Çπ '+fmt(v.total_amount))}
          <div style="margin:6px 0 0;"><strong>Bill Photo:</strong> <ul style="margin:6px 0 0 16px;">${files}</ul></div>
        </div>`;
      }
      if(content) content.innerHTML = `<div class="uv-details">${html}</div>`;
      try{
        const sId='uv-details-style'; if(!document.getElementById(sId)){
          const s=document.createElement('style'); s.id=sId; s.textContent=`
            .uv-details{line-height:1.6}
            .uv-details h3{margin:12px 0 6px}
            .uv-details table{margin:8px 0 14px}
            .uv-details .kv{margin:6px 0;display:flex;gap:14px;flex-wrap:wrap}
          `; document.head.appendChild(s);
        }
      }catch(_){ }
      // Admin-only Edit dropdown in the modal header
      try{
        const res = await fetch('/api/auth/me/'); const me = await res.json();
        const role = String(me?.designation||'').toLowerCase();
        const actions = document.getElementById('detailsActions'); if(actions) actions.innerHTML='';
        if(actions && role.includes('admin')){
          const wrap=document.createElement('div'); wrap.className='btn-group';
          wrap.innerHTML = `<button id=\"btnEditDropdown\" class=\"btn-secondary\">Edit ‚ñæ</button>
            <div id=\"editMenu\" class=\"menu\" role=\"menu\" style=\"right:0\">
              <button type=\"button\" data-edit=\"wo\">Work Order Add/Update</button>
              <button type=\"button\" data-edit=\"emp\">Employee Add/Update</button>
              <button type=\"button\" data-edit=\"master\">Update Master Travel/Transport</button>
            </div>`;
          actions.appendChild(wrap);
          const dd = wrap.querySelector('#btnEditDropdown'); const menu=wrap.querySelector('#editMenu');
          dd.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
          document.addEventListener('click', ()=> menu.classList.remove('open'));
          menu.addEventListener('click', (e)=>{
            const t = e.target.closest('button[data-edit]'); if(!t) return; menu.classList.remove('open');
            if(t.dataset.edit==='wo') openWorkOrderEditor();
            if(t.dataset.edit==='emp') openEmployeeEditor();
            if(t.dataset.edit==='master') openMasterEditor();
          });
        }
      }catch(_){ }
    }catch(e){
      const content = byId('detailsContent');
      if(content) content.innerHTML = `<div style="color:#b91c1c;">Failed to load voucher details. ${esc(e.message||e)}</div>`;
    }
  };

  function setDetailsTitle(text){
    const modal = document.getElementById('detailsModal');
    if(!modal) return;
    const titleEl = modal.querySelector('.modal-title');
    if(titleEl) titleEl.textContent = text || 'Voucher Details';
  }
  function resetDetailsActions(){
    const actions = document.getElementById('detailsActions');
    if(actions) actions.innerHTML = '';
  }
  function setDecisionVisibility(show){
    const wrap = document.getElementById('decisionControls');
    if(wrap){
      wrap.style.display = show ? 'flex' : 'none';
    }
    document.querySelectorAll('#detailsModal input[name="decision"]').forEach(inp=>{
      inp.checked = false;
      inp.disabled = !show;
    });
    const btn = document.getElementById('decisionSubmitBtn');
    if(btn){ btn.disabled = !show; }
  }
  async function openWorkOrderEditor(){
    setDetailsTitle('Work Order Add / Update');
    resetDetailsActions();
    setDecisionVisibility(false);
    const modal = document.getElementById('detailsModal');
    if(modal){
      delete modal.dataset.voucher;
    }
    const content = byId('detailsContent');
    if(content){
      content.innerHTML = `<div class="uv-wrap"><h3>Work Order Maintenance</h3>
        <div id="wo_message" class="uv-help" style="display:none;"></div>
        <form id="woForm" class="form">
          <div class="form-row">
            <label for="wo_selector">Work Order</label>
            <select id="wo_selector">
              <option value="__new__">Ôºã Create New Work Order</option>
            </select>
            <small class="muted">Select an existing work order to edit or choose the first option to create a new one.</small>
          </div>
          <input type="hidden" id="wo_project_id">
          <div class="form-row"><label for="wo_work_order_no">Work Order No</label>
            <input type="text" id="wo_work_order_no" required></div>
          <div class="form-row"><label for="wo_project_name">Project Name</label>
            <input type="text" id="wo_project_name" required></div>
          <div class="form-row"><label for="wo_client_name">Client Name</label>
            <input type="text" id="wo_client_name"></div>
          <div class="form-row"><label for="wo_project_type">Project Type</label>
            <input type="text" id="wo_project_type"></div>
          <div class="form-row"><label for="wo_place">Place</label>
            <input type="text" id="wo_place"></div>
          <div class="form-row"><label for="wo_address">Address</label>
            <textarea id="wo_address" rows="2" style="width:min(100%, var(--field-max));"></textarea></div>
          <div class="form-row"><label for="wo_dept_id">Department ID</label>
            <input type="number" id="wo_dept_id"></div>
          <div class="form-row"><label for="wo_status">Status</label>
            <select id="wo_status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
          <div class="form-actions" style="justify-content:flex-start">
            <button type="submit" class="btn-primary">Save Work Order</button>
          </div>
        </form>
      </div>`;
    }
    openOverlay('detailsModal');
    const root = byId('detailsContent');
    if(!root) return;
    const messageBox = root.querySelector('#wo_message');
    const selector = root.querySelector('#wo_selector');
    const fields = {
      projectId: root.querySelector('#wo_project_id'),
      workOrder: root.querySelector('#wo_work_order_no'),
      projectName: root.querySelector('#wo_project_name'),
      clientName: root.querySelector('#wo_client_name'),
      projectType: root.querySelector('#wo_project_type'),
      place: root.querySelector('#wo_place'),
      address: root.querySelector('#wo_address'),
      deptId: root.querySelector('#wo_dept_id'),
      status: root.querySelector('#wo_status'),
    };
    const form = root.querySelector('#woForm');

    const showMessage = (text, isError=false)=>{
      if(!messageBox) return;
      if(!text){
        messageBox.style.display = 'none';
        messageBox.textContent = '';
        return;
      }
      messageBox.style.display = 'block';
      messageBox.style.color = isError ? '#b91c1c' : '#256029';
      messageBox.textContent = text;
    };

    const clearForm = ()=>{
      if(fields.projectId) fields.projectId.value = '';
      if(fields.workOrder) fields.workOrder.value = '';
      if(fields.projectName) fields.projectName.value = '';
      if(fields.clientName) fields.clientName.value = '';
      if(fields.projectType) fields.projectType.value = '';
      if(fields.place) fields.place.value = '';
      if(fields.address) fields.address.value = '';
      if(fields.deptId) fields.deptId.value = '';
      if(fields.status) fields.status.value = 'Active';
    };

    const populateForm = (data={})=>{
      if(fields.projectId) fields.projectId.value = data.project_id ? String(data.project_id) : '';
      if(fields.workOrder) fields.workOrder.value = data.work_order_no || '';
      if(fields.projectName) fields.projectName.value = data.project_name || '';
      if(fields.clientName) fields.clientName.value = data.client_name || '';
      if(fields.projectType) fields.projectType.value = data.project_type || '';
      if(fields.place) fields.place.value = data.place || '';
      if(fields.address) fields.address.value = data.address || '';
      if(fields.deptId) fields.deptId.value = data.dept_id != null ? String(data.dept_id) : '';
      if(fields.status){
        const st = (data.status || '').toString().toLowerCase();
        fields.status.value = st === 'inactive' ? 'Inactive' : 'Active';
      }
    };

    const loadWorkOrders = async ()=>{
      if(!selector) return;
      const current = selector.value;
      selector.innerHTML = '<option value="__new__">Ôºã Create New Work Order</option>';
      try{
        const res = await fetch('/api/projects/', {headers:{'Accept':'application/json'}});
        const rows = await res.json().catch(()=>[]);
        if(!res.ok){
          throw new Error((rows && rows.error) || `HTTP ${res.status}`);
        }
        (rows || []).forEach(row=>{
          if(!row) return;
          const value = row.work_order_no || '';
          if(!value) return;
          const opt = document.createElement('option');
          opt.value = value;
          opt.textContent = row.project_name ? `${value} ‚Äî ${row.project_name}` : value;
          selector.appendChild(opt);
        });
        if(current && [...selector.options].some(o=>o.value===current)){
          selector.value = current;
        }else{
          selector.value = '__new__';
        }
      }catch(err){
        showMessage(`Unable to load work orders: ${err.message || err}`, true);
      }
    };

    await loadWorkOrders();
    clearForm();
    showMessage('Select an existing work order to edit or create a new one.');

    const loadDetails = async (wo)=>{
      if(!wo) return;
      showMessage(`Loading ${wo}‚Ä¶`);
      try{
        const res = await fetch(`/api/projects/details/${encodeURIComponent(wo)}/`, {headers:{'Accept':'application/json'}});
        if(!res.ok){
          throw new Error(res.status === 404 ? 'Work order not found.' : `HTTP ${res.status}`);
        }
        const data = await res.json();
        populateForm(data);
        showMessage(`Loaded ${data.work_order_no || wo}.`);
      }catch(err){
        clearForm();
        showMessage(`Failed to load work order: ${err.message || err}`, true);
      }
    };

    if(selector){
      selector.addEventListener('change', ()=>{
        const val = selector.value;
        if(val && val !== '__new__'){
          loadDetails(val);
        }else{
          clearForm();
          showMessage('Creating a new work order.');
        }
      });
    }

    if(form){
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const payload = {
          project_id: fields.projectId && fields.projectId.value ? parseInt(fields.projectId.value, 10) || undefined : undefined,
          work_order_no: (fields.workOrder?.value || '').trim(),
          project_name: (fields.projectName?.value || '').trim(),
          client_name: (fields.clientName?.value || '').trim(),
          project_type: (fields.projectType?.value || '').trim(),
          place: (fields.place?.value || '').trim(),
          address: (fields.address?.value || '').trim(),
          dept_id: fields.deptId && fields.deptId.value ? parseInt(fields.deptId.value, 10) || undefined : undefined,
          status: fields.status?.value || 'Active',
        };
        if(!payload.work_order_no || !payload.project_name){
          showMessage('Work Order No and Project Name are required.', true);
          return;
        }
        if(!payload.client_name) delete payload.client_name;
        if(!payload.project_type) delete payload.project_type;
        if(!payload.place) delete payload.place;
        if(!payload.address) delete payload.address;
        if(!payload.dept_id) delete payload.dept_id;
        if(!payload.project_id) delete payload.project_id;

        showMessage('Saving work order‚Ä¶');
        try{
          const res = await fetch('/api/projects/upsert/', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload),
          });
          const js = await res.json().catch(()=>({}));
          if(!res.ok || js.ok === false){
            throw new Error(js.error || `HTTP ${res.status}`);
          }
          const savedId = js.data?.project_id;
          if(fields.projectId && savedId){
            fields.projectId.value = String(savedId);
          }
          showMessage(`Saved successfully${savedId ? ` (Project ID ${savedId})` : ''}.`);
          await loadWorkOrders();
          if(selector && payload.work_order_no && [...selector.options].some(o=>o.value===payload.work_order_no)){
            selector.value = payload.work_order_no;
          }
        }catch(err){
          showMessage(`Failed to save work order: ${err.message || err}`, true);
        }
      });
    }
  }
  async function openEmployeeEditor(){
    setDetailsTitle('Employee & Credentials');
    resetDetailsActions();
    setDecisionVisibility(false);
    const modal = document.getElementById('detailsModal');
    if(modal){
      delete modal.dataset.voucher;
    }
    const content = byId('detailsContent');
    if(content){
      content.innerHTML = '<div class="uv-help">Loading employee tools‚Ä¶</div>';
    }
    openOverlay('detailsModal');

    const AUTH_OPTIONS = ['Employee','Manager','Department Head','Accountant','Finance Head','Admin'];
    let departments = [];
    let employees = [];
    let credentials = [];
    const employeeMap = new Map();
    const credentialMap = new Map();

    const fetchData = async ()=>{
      const [deptRes, empRes, credRes] = await Promise.all([
        fetch('/api/admin/departments/', {headers:{'Accept':'application/json'}}),
        fetch('/api/admin/employees/', {headers:{'Accept':'application/json'}}),
        fetch('/api/admin/credentials/', {headers:{'Accept':'application/json'}})
      ]);
      const deptJson = await deptRes.json().catch(()=>({}));
      const empJson = await empRes.json().catch(()=>({}));
      const credJson = await credRes.json().catch(()=>({}));
      if(!deptRes.ok){
        throw new Error(deptJson.error || `HTTP ${deptRes.status}`);
      }
      if(!empRes.ok){
        throw new Error(empJson.error || `HTTP ${empRes.status}`);
      }
      if(!credRes.ok){
        throw new Error(credJson.error || `HTTP ${credRes.status}`);
      }
      departments = Array.isArray(deptJson) ? deptJson : [];
      employees = Array.isArray(empJson) ? empJson.map(e=>{
        const contact = e.contact != null ? String(e.contact) : '';
        const credential = e.credential || {};
        return {
          emp_id: e.emp_id != null ? Number(e.emp_id) : null,
          name: e.name || '',
          age: e.age != null ? Number(e.age) : null,
          address: e.address || '',
          contact,
          email_id: e.email_id || '',
          dept_id: e.dept_id != null ? Number(e.dept_id) : null,
          reporting_manager: e.reporting_manager != null ? Number(e.reporting_manager) : null,
          authority: e.authority || '',
          credential: {
            cred_id: credential.cred_id != null ? Number(credential.cred_id) : null,
            username: credential.username || '',
            role: credential.role || '',
            approve_seq: credential.approve_seq != null ? Number(credential.approve_seq) : 0
          }
        };
      }) : [];
      employeeMap.clear();
      employees.forEach(emp=>{
        if(emp.emp_id != null){
          employeeMap.set(String(emp.emp_id), emp);
        }
      });
      credentials = Array.isArray(credJson) ? credJson.map(c=>({
        cred_id: c.cred_id != null ? Number(c.cred_id) : null,
        emp_id: c.emp_id != null ? Number(c.emp_id) : null,
        username: c.username || '',
        role: c.role || '',
        approve_seq: c.approve_seq != null ? Number(c.approve_seq) : 0
      })) : [];
      credentialMap.clear();
      credentials.forEach(c=>{
        if(c.cred_id != null){
          credentialMap.set(String(c.cred_id), c);
        }
      });
    };

    try{
      await fetchData();
    }catch(err){
      if(content){
        content.innerHTML = `<div style="color:#b91c1c;">${esc(err.message || err)}</div>`;
      }
      return;
    }

    if(content){
      content.innerHTML = `<div class="uv-wrap">
        <h3>Employee Maintenance</h3>
        <div id="emp_message" class="uv-help" style="display:none;"></div>
        <form id="employeeForm" class="form" autocomplete="off">
          <div class="form-row">
            <label for="emp_mode">Action</label>
            <select id="emp_mode">
              <option value="add">Add Employee</option>
              <option value="update">Update Employee</option>
            </select>
          </div>
          <div class="form-row" id="emp_select_row" style="display:none;">
            <label for="emp_select">Select Employee</label>
            <select id="emp_select"><option value="">-- Select Employee --</option></select>
          </div>
          <input type="hidden" id="emp_id_field">
          <div class="form-row"><label for="emp_name">Name</label>
            <input type="text" id="emp_name" required></div>
          <div class="form-row"><label for="emp_age">Age</label>
            <input type="number" id="emp_age" min="0"></div>
          <div class="form-row"><label for="emp_address">Address</label>
            <textarea id="emp_address" rows="2" style="width:min(100%, var(--field-max));"></textarea></div>
          <div class="form-row"><label for="emp_contact">Contact</label>
            <input type="text" id="emp_contact"></div>
          <div class="form-row"><label for="emp_email">Email</label>
            <input type="email" id="emp_email"></div>
          <div class="form-row"><label for="emp_dept">Department</label>
            <select id="emp_dept"><option value="">-- Select Department --</option></select>
          </div>
          <div class="form-row"><label for="emp_reporting">Reporting Manager</label>
            <select id="emp_reporting"><option value="">-- Select Manager --</option></select>
          </div>
          <div class="form-row"><label for="emp_authority">Authority</label>
            <select id="emp_authority"></select>
          </div>
          <h4>Credentials</h4>
          <div class="form-row"><label for="emp_username">Username</label>
            <input type="text" id="emp_username" required></div>
          <div class="form-row"><label for="emp_password">Password</label>
            <input type="text" id="emp_password" placeholder="Leave blank to keep existing"></div>
          <div class="form-row"><label for="emp_role">Role</label>
            <select id="emp_role"></select>
          </div>
          <div class="form-row"><label for="emp_seq">Approve Sequence</label>
            <select id="emp_seq"></select>
          </div>
          <div class="form-actions" style="justify-content:flex-start">
            <button type="submit" class="btn-primary">Save Employee</button>
          </div>
        </form>
        <h3 style="margin-top:24px;">Credentials Maintenance</h3>
        <div id="cred_message" class="uv-help" style="display:none;"></div>
        <form id="credForm" class="form" autocomplete="off">
          <div class="form-row">
            <label for="cred_mode">Action</label>
            <select id="cred_mode">
              <option value="add">Add Credentials</option>
              <option value="update">Update Credentials</option>
            </select>
          </div>
          <div class="form-row" id="cred_select_row" style="display:none;">
            <label for="cred_select">Select Credentials</label>
            <select id="cred_select"><option value="">-- Select Credentials --</option></select>
          </div>
          <div class="form-row"><label for="cred_employee">Employee</label>
            <select id="cred_employee"><option value="">-- Select Employee --</option></select>
          </div>
          <div class="form-row"><label for="cred_username">Username</label>
            <input type="text" id="cred_username" required></div>
          <div class="form-row"><label for="cred_password">Password</label>
            <input type="text" id="cred_password" placeholder="Leave blank to keep existing"></div>
          <div class="form-row"><label for="cred_role">Role</label>
            <select id="cred_role"></select>
          </div>
          <div class="form-row"><label for="cred_seq">Approve Sequence</label>
            <select id="cred_seq"></select>
          </div>
          <div class="form-actions" style="justify-content:flex-start">
            <button type="submit" class="btn-primary">Save Credentials</button>
          </div>
        </form>
      </div>`;
    }

    const root = byId('detailsContent');
    if(!root) return;

    const empMessage = root.querySelector('#emp_message');
    const credMessage = root.querySelector('#cred_message');
    const employeeForm = root.querySelector('#employeeForm');
    const credForm = root.querySelector('#credForm');
    const empMode = root.querySelector('#emp_mode');
    const empSelectRow = root.querySelector('#emp_select_row');
    const empSelect = root.querySelector('#emp_select');
    const empIdField = root.querySelector('#emp_id_field');
    const empName = root.querySelector('#emp_name');
    const empAge = root.querySelector('#emp_age');
    const empAddress = root.querySelector('#emp_address');
    const empContact = root.querySelector('#emp_contact');
    const empEmail = root.querySelector('#emp_email');
    const empDept = root.querySelector('#emp_dept');
    const empReporting = root.querySelector('#emp_reporting');
    const empAuthority = root.querySelector('#emp_authority');
    const empUsername = root.querySelector('#emp_username');
    const empPassword = root.querySelector('#emp_password');
    const empRole = root.querySelector('#emp_role');
    const empSeq = root.querySelector('#emp_seq');
    const credMode = root.querySelector('#cred_mode');
    const credSelectRow = root.querySelector('#cred_select_row');
    const credSelect = root.querySelector('#cred_select');
    const credEmployee = root.querySelector('#cred_employee');
    const credUsername = root.querySelector('#cred_username');
    const credPassword = root.querySelector('#cred_password');
    const credRole = root.querySelector('#cred_role');
    const credSeq = root.querySelector('#cred_seq');

    const showEmpMessage = (text, isError=false)=>{
      if(!empMessage) return;
      if(!text){
        empMessage.style.display = 'none';
        empMessage.textContent = '';
        return;
      }
      empMessage.style.display = 'block';
      empMessage.style.color = isError ? '#b91c1c' : '#256029';
      empMessage.textContent = text;
    };

    const showCredMessage = (text, isError=false)=>{
      if(!credMessage) return;
      if(!text){
        credMessage.style.display = 'none';
        credMessage.textContent = '';
        return;
      }
      credMessage.style.display = 'block';
      credMessage.style.color = isError ? '#b91c1c' : '#256029';
      credMessage.textContent = text;
    };

    const populateAuthorityOptions = (select, allowBlank)=>{
      if(!select) return;
      const current = select.value;
      select.innerHTML = '';
      if(allowBlank){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- Select --';
        select.appendChild(opt);
      }
      AUTH_OPTIONS.forEach(label=>{
        const opt = document.createElement('option');
        opt.value = label;
        opt.textContent = label;
        select.appendChild(opt);
      });
      if(current && [...select.options].some(o=>o.value===current)){
        select.value = current;
      }else if(!allowBlank){
        select.value = AUTH_OPTIONS[0];
      }
    };

    const populateApproveSeq = (select)=>{
      if(!select) return;
      const current = select.value;
      select.innerHTML = '';
      for(let i=0;i<=4;i++){
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = String(i);
        select.appendChild(opt);
      }
      if(current && [...select.options].some(o=>o.value===current)){
        select.value = current;
      }else{
        select.value = '0';
      }
    };

    populateAuthorityOptions(empAuthority, true);
    populateAuthorityOptions(empRole, false);
    populateAuthorityOptions(credRole, false);
    populateApproveSeq(empSeq);
    populateApproveSeq(credSeq);

    const populateDepartments = ()=>{
      if(!empDept) return;
      const current = empDept.value;
      empDept.innerHTML = '<option value="">-- Select Department --</option>';
      departments.forEach(dep=>{
        if(dep.dept_id == null) return;
        const opt = document.createElement('option');
        opt.value = String(dep.dept_id);
        const label = dep.dept_name ? `${dep.dept_name} (${dep.dept_id})` : String(dep.dept_id);
        opt.textContent = label;
        empDept.appendChild(opt);
      });
      if(current && [...empDept.options].some(o=>o.value===current)){
        empDept.value = current;
      }
    };

    const populateManagers = ()=>{
      if(!empReporting) return;
      const current = empReporting.value;
      empReporting.innerHTML = '<option value="">-- Select Manager --</option>';
      employees.forEach(emp=>{
        if(emp.emp_id == null) return;
        const opt = document.createElement('option');
        opt.value = String(emp.emp_id);
        opt.textContent = emp.name ? `${emp.name} (#${emp.emp_id})` : `Employee #${emp.emp_id}`;
        empReporting.appendChild(opt);
      });
      if(current && [...empReporting.options].some(o=>o.value===current)){
        empReporting.value = current;
      }
    };

    const populateEmployeeSelect = ()=>{
      if(!empSelect) return;
      const current = empSelect.value;
      empSelect.innerHTML = '<option value="">-- Select Employee --</option>';
      employees.forEach(emp=>{
        if(emp.emp_id == null) return;
        const opt = document.createElement('option');
        opt.value = String(emp.emp_id);
        opt.textContent = emp.name ? `${emp.name} (#${emp.emp_id})` : `Employee #${emp.emp_id}`;
        empSelect.appendChild(opt);
      });
      if(current && [...empSelect.options].some(o=>o.value===current)){
        empSelect.value = current;
      }
    };

    const populateCredentialEmployee = ()=>{
      if(!credEmployee) return;
      const current = credEmployee.value;
      credEmployee.innerHTML = '<option value="">-- Select Employee --</option>';
      employees.forEach(emp=>{
        if(emp.emp_id == null) return;
        const opt = document.createElement('option');
        opt.value = String(emp.emp_id);
        opt.textContent = emp.name ? `${emp.name} (#${emp.emp_id})` : `Employee #${emp.emp_id}`;
        credEmployee.appendChild(opt);
      });
      if(current && [...credEmployee.options].some(o=>o.value===current)){
        credEmployee.value = current;
      }
    };

    const populateCredentialSelect = ()=>{
      if(!credSelect) return;
      const current = credSelect.value;
      credSelect.innerHTML = '<option value="">-- Select Credentials --</option>';
      credentials.forEach(cred=>{
        if(cred.cred_id == null) return;
        const opt = document.createElement('option');
        opt.value = String(cred.cred_id);
        const empName = cred.emp_id != null ? (employeeMap.get(String(cred.emp_id))?.name || '') : '';
        opt.textContent = cred.username ? `${cred.username}${empName ? ` (${empName})` : ''}` : `Credential #${cred.cred_id}`;
        credSelect.appendChild(opt);
      });
      if(current && [...credSelect.options].some(o=>o.value===current)){
        credSelect.value = current;
      }
    };

    const populateAllSelects = (opts={})=>{
      populateDepartments();
      populateManagers();
      populateEmployeeSelect();
      populateCredentialEmployee();
      populateCredentialSelect();
      if(opts.selectedEmployee){
        const sid = String(opts.selectedEmployee);
        if(empSelect) empSelect.value = sid;
        if(credEmployee) credEmployee.value = sid;
      }
      if(opts.selectedCredential && credSelect){
        credSelect.value = String(opts.selectedCredential);
      }
    };

    const fillEmployeeForm = (emp)=>{
      if(!emp){
        if(empIdField) empIdField.value = '';
        if(empName) empName.value = '';
        if(empAge) empAge.value = '';
        if(empAddress) empAddress.value = '';
        if(empContact) empContact.value = '';
        if(empEmail) empEmail.value = '';
        if(empDept) empDept.value = '';
        if(empReporting) empReporting.value = '';
        if(empAuthority) empAuthority.value = '';
        if(empUsername) empUsername.value = '';
        if(empPassword) empPassword.value = '';
        if(empRole) empRole.value = AUTH_OPTIONS[0];
        if(empSeq) empSeq.value = '0';
        return;
      }
      if(empIdField) empIdField.value = emp.emp_id != null ? String(emp.emp_id) : '';
      if(empName) empName.value = emp.name || '';
      if(empAge) empAge.value = emp.age != null ? String(emp.age) : '';
      if(empAddress) empAddress.value = emp.address || '';
      if(empContact) empContact.value = emp.contact || '';
      if(empEmail) empEmail.value = emp.email_id || '';
      if(empDept) empDept.value = emp.dept_id != null ? String(emp.dept_id) : '';
      if(empReporting) empReporting.value = emp.reporting_manager != null ? String(emp.reporting_manager) : '';
      if(empAuthority) empAuthority.value = emp.authority || '';
      if(empUsername) empUsername.value = emp.credential?.username || '';
      if(empPassword) empPassword.value = '';
      if(empRole) empRole.value = emp.credential?.role || AUTH_OPTIONS[0];
      if(empSeq) empSeq.value = emp.credential?.approve_seq != null ? String(emp.credential.approve_seq) : '0';
    };

    const fillCredentialForm = (cred)=>{
      if(!cred){
        if(credEmployee) credEmployee.value = '';
        if(credUsername) credUsername.value = '';
        if(credPassword) credPassword.value = '';
        if(credRole) credRole.value = AUTH_OPTIONS[0];
        if(credSeq) credSeq.value = '0';
        return;
      }
      if(credEmployee) credEmployee.value = cred.emp_id != null ? String(cred.emp_id) : '';
      if(credUsername) credUsername.value = cred.username || '';
      if(credPassword) credPassword.value = '';
      if(credRole) credRole.value = cred.role || AUTH_OPTIONS[0];
      if(credSeq) credSeq.value = cred.approve_seq != null ? String(cred.approve_seq) : '0';
    };

    populateAllSelects();
    fillEmployeeForm(null);
    fillCredentialForm(null);

    const handleEmpModeChange = ()=>{
      if(!empMode) return;
      const mode = empMode.value;
      if(empSelectRow){
        empSelectRow.style.display = mode === 'update' ? '' : 'none';
      }
      if(mode === 'update'){
        showEmpMessage('Select an employee to update.');
        if(empSelect && !empSelect.value){
          fillEmployeeForm(null);
        }
      }else{
        showEmpMessage('');
        if(empSelect) empSelect.value = '';
        fillEmployeeForm(null);
      }
    };

    const handleEmployeeSelect = ()=>{
      if(!empSelect) return;
      const emp = employeeMap.get(empSelect.value || '');
      if(emp){
        fillEmployeeForm(emp);
        showEmpMessage(`Editing ${emp.name || 'Employee'} (#${emp.emp_id})`);
      }else{
        fillEmployeeForm(null);
        showEmpMessage('');
      }
    };

    const handleCredModeChange = ()=>{
      if(!credMode) return;
      const mode = credMode.value;
      if(credSelectRow){
        credSelectRow.style.display = mode === 'update' ? '' : 'none';
      }
      if(mode === 'update'){
        showCredMessage('Select credentials to update.');
        if(credSelect && !credSelect.value){
          fillCredentialForm(null);
        }
      }else{
        showCredMessage('');
        if(credSelect) credSelect.value = '';
        fillCredentialForm(null);
      }
    };

    const handleCredentialSelect = ()=>{
      if(!credSelect) return;
      const cred = credentialMap.get(credSelect.value || '');
      if(cred){
        fillCredentialForm(cred);
        showCredMessage(`Editing ${cred.username || 'credentials'} (#${cred.cred_id})`);
      }else{
        fillCredentialForm(null);
        showCredMessage('');
      }
    };

    if(empMode) empMode.addEventListener('change', handleEmpModeChange);
    if(empSelect) empSelect.addEventListener('change', handleEmployeeSelect);
    if(credMode) credMode.addEventListener('change', handleCredModeChange);
    if(credSelect) credSelect.addEventListener('change', handleCredentialSelect);

    handleEmpModeChange();
    handleCredModeChange();

    if(employeeForm){
      employeeForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const mode = empMode ? empMode.value : 'add';
        const selectedId = empSelect ? empSelect.value : '';
        if(mode === 'update' && !selectedId){
          showEmpMessage('Select an employee to update.', true);
          return;
        }
        const payload = {
          emp_id: mode === 'update' && selectedId ? Number(selectedId) : undefined,
          name: (empName?.value || '').trim(),
          age: empAge && empAge.value ? Number(empAge.value) : undefined,
          address: (empAddress?.value || '').trim(),
          contact: (empContact?.value || '').trim(),
          email_id: (empEmail?.value || '').trim(),
          dept_id: empDept && empDept.value ? Number(empDept.value) : undefined,
          reporting_manager: empReporting && empReporting.value ? Number(empReporting.value) : undefined,
          authority: empAuthority?.value || '',
          username: (empUsername?.value || '').trim(),
          password: empPassword?.value || '',
          role: empRole?.value || 'Employee',
          approve_seq: empSeq && empSeq.value ? Number(empSeq.value) : 0
        };
        if(!payload.name){
          showEmpMessage('Name is required.', true);
          return;
        }
        if(!payload.username){
          showEmpMessage('Username is required.', true);
          return;
        }
        if(mode === 'add' && !payload.password){
          showEmpMessage('Password is required when adding an employee.', true);
          return;
        }
        if(payload.address === '') delete payload.address;
        if(payload.contact){
          payload.contact = payload.contact.replace(/\s+/g, '');
        }
        if(!payload.contact) delete payload.contact;
        if(payload.email_id === '') delete payload.email_id;
        if(payload.authority === '') delete payload.authority;
        if(payload.age == null) delete payload.age;
        if(payload.dept_id == null) delete payload.dept_id;
        if(payload.reporting_manager == null) delete payload.reporting_manager;
        if(mode === 'add'){
          delete payload.emp_id;
        }
        showEmpMessage('Saving employee‚Ä¶');
        try{
          const res = await fetch('/api/admin/employee/upsert/', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const js = await res.json().catch(()=>({}));
          if(!res.ok || js.ok === false){
            throw new Error(js.error || `HTTP ${res.status}`);
          }
          const savedId = js.data?.emp_id;
          showEmpMessage(`Employee saved successfully${savedId ? ` (ID ${savedId})` : ''}.`);
          await fetchData();
          populateAllSelects({selectedEmployee: savedId});
          if(mode === 'update' && empSelect){
            empSelect.value = savedId ? String(savedId) : '';
            handleEmployeeSelect();
          }else{
            if(empMode) empMode.value = 'add';
            handleEmpModeChange();
            fillEmployeeForm(null);
          }
        }catch(err){
          showEmpMessage(`Failed to save employee: ${err.message || err}`, true);
        }
      });
    }

    if(credForm){
      credForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const mode = credMode ? credMode.value : 'add';
        const selectedCred = credSelect ? credSelect.value : '';
        if(mode === 'update' && !selectedCred){
          showCredMessage('Select credentials to update.', true);
          return;
        }
        const empVal = credEmployee ? credEmployee.value : '';
        if(!empVal){
          showCredMessage('Select an employee for these credentials.', true);
          return;
        }
        const payload = {
          cred_id: mode === 'update' && selectedCred ? Number(selectedCred) : undefined,
          emp_id: Number(empVal),
          username: (credUsername?.value || '').trim(),
          password: credPassword?.value || '',
          role: credRole?.value || 'Employee',
          approve_seq: credSeq && credSeq.value ? Number(credSeq.value) : 0
        };
        if(!payload.username){
          showCredMessage('Username is required.', true);
          return;
        }
        if(mode === 'add' && !payload.password){
          showCredMessage('Password is required when adding credentials.', true);
          return;
        }
        showCredMessage('Saving credentials‚Ä¶');
        try{
          const res = await fetch('/api/admin/credentials/upsert/', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const js = await res.json().catch(()=>({}));
          if(!res.ok || js.ok === false){
            throw new Error(js.error || `HTTP ${res.status}`);
          }
          const savedCredId = js.data?.cred_id;
          showCredMessage('Credentials saved successfully.');
          await fetchData();
          populateAllSelects({selectedCredential: savedCredId, selectedEmployee: payload.emp_id});
          if(savedCredId){
            if(credMode) credMode.value = 'update';
            handleCredModeChange();
            if(credSelect) credSelect.value = String(savedCredId);
            handleCredentialSelect();
          }else{
            fillCredentialForm(null);
          }
          if(credPassword) credPassword.value = '';
        }catch(err){
          showCredMessage(`Failed to save credentials: ${err.message || err}`, true);
        }
      });
    }
  }

  async function openMasterEditor(){
    setDetailsTitle('Master Travel & Transport');
    resetDetailsActions();
    setDecisionVisibility(false);
    const modal = document.getElementById('detailsModal');
    if(modal){
      delete modal.dataset.voucher;
    }
    const content = byId('detailsContent');
    if(content){
      content.innerHTML = `<div class="uv-wrap"><h3>Master Travel & Transport</h3>
        <div class="grid-2">
          <form id="mtForm" class="form">
            <h4>Master Travel</h4>
            <div class="form-row"><label for="mt_id">ID (leave blank to add)</label><input id="mt_id" type="number"></div>
            <div class="form-row"><label for="mt_authoriser">Visit Authoriser Name</label><input id="mt_authoriser" type="text"></div>
            <div class="form-row"><label for="mt_food">Food per Day</label><input id="mt_food" type="text"></div>
            <div class="form-row"><label for="mt_status">Status</label><select id="mt_status"><option value="1">Active (1)</option><option value="0">Inactive (0)</option></select></div>
            <div class="form-actions" style="justify-content:flex-start"><button type="submit" class="btn-primary">Save Travel</button></div>
          </form>
          <form id="mmForm" class="form">
            <h4>Master Transport Mode</h4>
            <div class="form-row"><label for="mm_id">Mode ID (leave blank to add)</label><input id="mm_id" type="number"></div>
            <div class="form-row"><label for="mm_mode">Mode of Transport</label><input id="mm_mode" type="text"></div>
            <div class="form-row"><label for="mm_uom">UOM</label><input id="mm_uom" type="text"></div>
            <div class="form-row"><label for="mm_fixed">Fixed Status</label><select id="mm_fixed"><option value="1">Yes (1)</option><option value="0">No (0)</option></select></div>
            <div class="form-row"><label for="mm_price">Price</label><input id="mm_price" type="text"></div>
            <div class="form-actions" style="justify-content:flex-start"><button type="submit" class="btn-primary">Save Mode</button></div>
          </form>
        </div>
      </div>`;
    }
    openOverlay('detailsModal');

    const root = byId('detailsContent');
    if(!root) return;

    const mtForm = root.querySelector('#mtForm');
    const mmForm = root.querySelector('#mmForm');

    if(mtForm){
      mtForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const payload = {
          travelmaster_id: (root.querySelector('#mt_id')?.value || '').trim(),
          visit_authoriser_name: (root.querySelector('#mt_authoriser')?.value || '').trim(),
          food_per_day: (root.querySelector('#mt_food')?.value || '').trim(),
          status: Number(root.querySelector('#mt_status')?.value || '1')
        };
        if(payload.travelmaster_id === '') delete payload.travelmaster_id;
        try{
          const res = await fetch('/api/master/travel/upsert/', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const js = await res.json().catch(()=>({}));
          if(!res.ok || js.ok === false){
            throw new Error(js.error || `HTTP ${res.status}`);
          }
          alert('Saved master travel');
        }catch(err){
          alert('Failed: ' + (err.message || err));
        }
      });
    }

    if(mmForm){
      mmForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const payload = {
          mode_id: (root.querySelector('#mm_id')?.value || '').trim(),
          mode_of_transport: (root.querySelector('#mm_mode')?.value || '').trim(),
          UOM: (root.querySelector('#mm_uom')?.value || '').trim(),
          fixed_status: Number(root.querySelector('#mm_fixed')?.value || '0'),
          price: (root.querySelector('#mm_price')?.value || '').trim()
        };
        if(payload.mode_id === '') delete payload.mode_id;
        try{
          const res = await fetch('/api/master/transport_mode/upsert/', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const js = await res.json().catch(()=>({}));
          if(!res.ok || js.ok === false){
            throw new Error(js.error || `HTTP ${res.status}`);
          }
          alert('Saved transport mode');
        }catch(err){
          alert('Failed: ' + (err.message || err));
        }
      });
    }
  }

  // Expose editor helpers globally so the navbar dropdown can trigger them
  window.openWorkOrderEditor = openWorkOrderEditor;
  window.openEmployeeEditor = openEmployeeEditor;
  window.openMasterEditor = openMasterEditor;

  window.submitDecision = async function(){
    const modal = document.getElementById('detailsModal');
    const voucherId = modal?.dataset?.voucher || '';
    const val = (document.querySelector('#detailsModal input[name="decision"]:checked')||{}).value;
    if(!voucherId){ alert('Missing voucher id.'); return; }
    if(!val){ alert('Choose Approve or Reject.'); return; }
    if(val==='reject'){
      const rej = document.getElementById('rejectModal');
      if(rej) rej.classList.add('active');
      return;
    }
    try{
      const submitBtn = document.getElementById('decisionSubmitBtn'); if(submitBtn) submitBtn.disabled = true;
      const res = await fetch('/api/validate/decision/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ voucher_id: voucherId, decision: 'approve' })
      });
      const js = await res.json().catch(()=>({}));
      if(!res.ok || js.ok===false){ throw new Error(js.error || `HTTP ${res.status}`); }
      // Disable radios + submit after decision
      modal.querySelectorAll('input[name="decision"]').forEach(inp=> inp.disabled=true);
      const _btn = document.getElementById('decisionSubmitBtn'); if(_btn) _btn.disabled = true;
      // Update table row immediately
      try {
        const tbody = document.querySelector('#approveTable tbody');
        const rows = tbody ? [...tbody.querySelectorAll('tr[data-voucher]')] : [];
        const tr = rows.find(r => (r.getAttribute('data-voucher')||'') === voucherId);
        if(tr){
          const actionCell = tr.cells[8];
          const remarksCell = tr.cells[9];
          if(actionCell) actionCell.innerHTML = '<span class="s-approved">Approved</span>';
          if(remarksCell) remarksCell.textContent = 'Approved';
        }
      } catch(_){ }
      closeOverlay('detailsModal');
      // refresh list (row may disappear if no longer pending)
      try{
        const r = await fetch('/api/validate/list/');
        const j = await r.json();
        if(r.ok && j.ok) renderValidateTable(j.data||[]);
      }catch(_){ }
    }catch(e){
      const submitBtn = document.getElementById('decisionSubmitBtn'); if(submitBtn) submitBtn.disabled = false;
      alert('Failed to approve: '+ (e?.message||e));
    }
  };

  window.confirmReject = async function(){
    const ta = document.getElementById('rejectRemarks');
    const txt = (ta?.value||'').trim();
    const modal = document.getElementById('detailsModal');
    const voucherId = modal?.dataset?.voucher || '';
    if(!voucherId){ alert('Missing voucher id.'); return; }
    if(txt.length < 50){ alert('Please enter at least 50 characters in Remarks.'); return; }
    try{
      const submitBtn = document.getElementById('decisionSubmitBtn'); if(submitBtn) submitBtn.disabled = true;
      const res = await fetch('/api/validate/decision/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ voucher_id: voucherId, decision: 'reject', remarks: txt })
      });
      const js = await res.json().catch(()=>({}));
      if(!res.ok || js.ok===false){ throw new Error(js.error || `HTTP ${res.status}`); }
      // disable radios + submit after decision
      modal.querySelectorAll('input[name="decision"]').forEach(inp=> inp.disabled=true);
      const _btn2 = document.getElementById('decisionSubmitBtn'); if(_btn2) _btn2.disabled = true;
      // Update table row immediately
      try {
        const tbody = document.querySelector('#approveTable tbody');
        const rows = tbody ? [...tbody.querySelectorAll('tr[data-voucher]')] : [];
        const tr = rows.find(r => (r.getAttribute('data-voucher')||'') === voucherId);
        if(tr){
          const actionCell = tr.cells[8];
          const remarksCell = tr.cells[9];
          if(actionCell) actionCell.innerHTML = '<span class="s-rejected">Rejected</span>';
          if(remarksCell) remarksCell.textContent = txt;
        }
      } catch(_){ }
      closeOverlay('rejectModal');
      closeOverlay('detailsModal');
      // refresh list
      try{
        const r = await fetch('/api/validate/list/');
        const j = await r.json();
        if(r.ok && j.ok) renderValidateTable(j.data||[]);
      }catch(_){ }
    }catch(e){
      const submitBtn = document.getElementById('decisionSubmitBtn'); if(submitBtn) submitBtn.disabled = false;
      alert('Failed to reject: '+ (e?.message||e));
    }
  };
})();


  function byId(id){ return document.getElementById(id); }
</script>
